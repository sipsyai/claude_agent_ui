{
  "file_path": "src/web/manager/components/MCPToolsSelector.tsx",
  "main_branch_history": [],
  "task_views": {
    "004-document-frontend-react-components-and-hooks": {
      "task_id": "004-document-frontend-react-components-and-hooks",
      "branch_point": {
        "commit_hash": "34a3f60da53773d90bd6579cb1cfd8417a1dd0b9",
        "content": "import React, { useState, useEffect } from 'react';\nimport * as api from '../services/api';\nimport { ServerIcon, ChevronDownIcon, ChevronRightIcon, InfoIcon, RefreshIcon } from './ui/Icons';\n\ninterface MCPToolsSelectorProps {\n  selectedMCPTools: Record<string, string[]>;\n  onChange: (mcpTools: Record<string, string[]>) => void;\n  disabled?: boolean;\n  directory?: string;\n}\n\nconst MCPToolsSelector: React.FC<MCPToolsSelectorProps> = ({\n  selectedMCPTools,\n  onChange,\n  disabled = false,\n  directory,\n}) => {\n  const [mcpServers, setMCPServers] = useState<api.MCPServer[]>([]);\n  const [expandedServers, setExpandedServers] = useState<Set<string>>(new Set());\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [refreshingServers, setRefreshingServers] = useState<Set<string>>(new Set());\n  const [selectedToolDetail, setSelectedToolDetail] = useState<{\n    server: api.MCPServer;\n    tool: api.MCPToolType;\n  } | null>(null);\n\n  useEffect(() => {\n    loadMCPServers();\n  }, [directory]);\n\n  const loadMCPServers = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      const servers = await api.getMCPServers(directory);\n\n      // Only include servers that have tools\n      const serversWithTools = servers.filter(s => s.mcpTools && s.mcpTools.length > 0);\n      setMCPServers(serversWithTools);\n\n      // Auto-expand servers that have selected tools\n      const autoExpand = new Set<string>();\n      serversWithTools.forEach(server => {\n        if (selectedMCPTools[server.id] && selectedMCPTools[server.id].length > 0) {\n          autoExpand.add(server.id);\n        }\n      });\n      setExpandedServers(autoExpand);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load MCP servers');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const toggleServer = (serverId: string) => {\n    const newExpanded = new Set(expandedServers);\n    if (newExpanded.has(serverId)) {\n      newExpanded.delete(serverId);\n    } else {\n      newExpanded.add(serverId);\n    }\n    setExpandedServers(newExpanded);\n  };\n\n  const toggleTool = (serverId: string, toolName: string) => {\n    const currentTools = selectedMCPTools[serverId] || [];\n    let newTools: string[];\n\n    if (currentTools.includes(toolName)) {\n      // Remove tool\n      newTools = currentTools.filter(t => t !== toolName);\n    } else {\n      // Add tool\n      newTools = [...currentTools, toolName];\n    }\n\n    // Update the entire mcpTools object\n    const newMCPTools = { ...selectedMCPTools };\n    if (newTools.length === 0) {\n      delete newMCPTools[serverId];\n    } else {\n      newMCPTools[serverId] = newTools;\n    }\n\n    onChange(newMCPTools);\n  };\n\n  const toggleAllToolsForServer = (serverId: string) => {\n    const server = mcpServers.find(s => s.id === serverId);\n    if (!server || !server.mcpTools) return;\n\n    const currentTools = selectedMCPTools[serverId] || [];\n    const allToolNames = server.mcpTools.map((t: api.MCPToolType) => t.name);\n\n    let newMCPTools = { ...selectedMCPTools };\n\n    if (currentTools.length === allToolNames.length) {\n      // All selected, deselect all\n      delete newMCPTools[serverId];\n    } else {\n      // Not all selected, select all\n      newMCPTools[serverId] = allToolNames;\n    }\n\n    onChange(newMCPTools);\n  };\n\n  const refreshServerTools = async (serverId: string) => {\n    setRefreshingServers(prev => new Set(prev).add(serverId));\n\n    try {\n      const result = await api.listMCPServerTools(serverId, directory);\n\n      if (result.success) {\n        // Update server tools in state\n        setMCPServers(prev =>\n          prev.map(s =>\n            s.id === serverId ? { ...s, mcpTools: result.tools } : s\n          )\n        );\n      }\n    } catch (err) {\n      console.error('Failed to refresh tools:', err);\n    } finally {\n      setRefreshingServers(prev => {\n        const next = new Set(prev);\n        next.delete(serverId);\n        return next;\n      });\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"text-sm text-muted-foreground\">\n        Loading MCP servers...\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"text-sm text-red-500\">\n        {error}\n      </div>\n    );\n  }\n\n  if (mcpServers.length === 0) {\n    return (\n      <div className=\"text-sm text-muted-foreground p-3 border border-dashed border-border rounded\">\n        No MCP servers with tools found. Add MCP servers in the MCP Servers section to see their tools here.\n      </div>\n    );\n  }\n\n  const getTotalSelectedTools = () => {\n    return Object.values(selectedMCPTools).reduce((sum, tools) => sum + tools.length, 0);\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Summary */}\n      <div className=\"text-xs text-muted-foreground\">\n        {getTotalSelectedTools() > 0\n          ? `${getTotalSelectedTools()} MCP tool(s) selected across ${Object.keys(selectedMCPTools).length} server(s)`\n          : 'No MCP tools selected'}\n      </div>\n\n      {/* MCP Servers List */}\n      <div className=\"border border-border rounded-md max-h-80 overflow-y-auto\">\n        {mcpServers.map((server) => {\n          const isExpanded = expandedServers.has(server.id);\n          const serverTools = server.mcpTools || [];\n          const selectedTools = selectedMCPTools[server.id] || [];\n          const allSelected = selectedTools.length === serverTools.length;\n          const someSelected = selectedTools.length > 0 && !allSelected;\n\n          return (\n            <div key={server.id} className=\"border-b border-border last:border-b-0\">\n              {/* Server Header */}\n              <div className=\"flex items-center gap-2 p-3 bg-secondary/30 hover:bg-secondary/50 transition-colors\">\n                <button\n                  type=\"button\"\n                  onClick={() => toggleServer(server.id)}\n                  disabled={disabled}\n                  className=\"flex-shrink-0 text-muted-foreground hover:text-foreground disabled:opacity-50\"\n                >\n                  {isExpanded ? (\n                    <ChevronDownIcon className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronRightIcon className=\"h-4 w-4\" />\n                  )}\n                </button>\n\n                <ServerIcon className=\"h-4 w-4 text-primary flex-shrink-0\" />\n\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"font-medium text-sm truncate\">{server.name}</span>\n                    {server.disabled && (\n                      <span className=\"text-xs px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded\">\n                        Disabled\n                      </span>\n                    )}\n                    <span className=\"text-xs text-muted-foreground\">\n                      ({serverTools.length} tool{serverTools.length !== 1 ? 's' : ''})\n                    </span>\n                  </div>\n                </div>\n\n                {/* Select All Checkbox for Server */}\n                <label\n                  className=\"flex items-center gap-2 text-xs cursor-pointer\"\n                  onClick={(e) => e.stopPropagation()}\n                >\n                  <input\n                    type=\"checkbox\"\n                    checked={allSelected}\n                    ref={(input) => {\n                      if (input) {\n                        input.indeterminate = someSelected;\n                      }\n                    }}\n                    onChange={() => toggleAllToolsForServer(server.id)}\n                    disabled={disabled}\n                    className=\"w-4 h-4 rounded\"\n                  />\n                  <span className=\"text-muted-foreground\">\n                    {allSelected ? 'All' : someSelected ? `${selectedTools.length}` : 'None'}\n                  </span>\n                </label>\n\n                {/* Refresh Button */}\n                <button\n                  type=\"button\"\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    refreshServerTools(server.id);\n                  }}\n                  disabled={disabled || refreshingServers.has(server.id)}\n                  className=\"flex-shrink-0 p-1 text-muted-foreground hover:text-primary rounded disabled:opacity-50\"\n                  title=\"Refresh tools\"\n                >\n                  <RefreshIcon className={`h-4 w-4 ${refreshingServers.has(server.id) ? 'animate-spin' : ''}`} />\n                </button>\n              </div>\n\n              {/* Tools List */}\n              {isExpanded && (\n                <div className=\"p-2 space-y-1 bg-background\">\n                  {serverTools.map((tool: api.MCPToolType) => {\n                    const isSelected = selectedTools.includes(tool.name);\n\n                    return (\n                      <div\n                        key={tool.name}\n                        className=\"flex items-start gap-2 p-2 rounded hover:bg-secondary/50 transition-colors\"\n                      >\n                        <label className=\"flex items-start gap-2 flex-1 min-w-0 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            checked={isSelected}\n                            onChange={() => toggleTool(server.id, tool.name)}\n                            disabled={disabled}\n                            className=\"mt-1 w-4 h-4 rounded flex-shrink-0\"\n                          />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"font-mono text-xs text-primary break-all\">\n                              mcp__{server.name}__{tool.name}\n                            </div>\n                            {tool.description && (\n                              <div className=\"text-xs text-muted-foreground mt-0.5 line-clamp-2\">\n                                {tool.description}\n                              </div>\n                            )}\n                          </div>\n                        </label>\n\n                        {/* Info button */}\n                        <button\n                          type=\"button\"\n                          onClick={() => setSelectedToolDetail({ server, tool })}\n                          className=\"flex-shrink-0 text-muted-foreground hover:text-primary p-1\"\n                          title=\"View details\"\n                        >\n                          <InfoIcon className=\"h-4 w-4\" />\n                        </button>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Tool Detail Modal */}\n      {selectedToolDetail && (\n        <div\n          className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\"\n          onClick={() => setSelectedToolDetail(null)}\n        >\n          <div\n            className=\"bg-background border border-border rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"p-4 border-b border-border\">\n              <h3 className=\"text-lg font-semibold font-mono\">\n                mcp__{selectedToolDetail.server.name}__{selectedToolDetail.tool.name}\n              </h3>\n              {selectedToolDetail.tool.description && (\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {selectedToolDetail.tool.description}\n                </p>\n              )}\n            </div>\n\n            <div className=\"p-4 overflow-y-auto flex-1\">\n              <div className=\"space-y-3\">\n                {/* Server Info */}\n                <div>\n                  <h4 className=\"text-sm font-medium mb-1\">MCP Server</h4>\n                  <p className=\"text-sm text-muted-foreground font-mono\">\n                    {selectedToolDetail.server.name}\n                  </p>\n                </div>\n\n                {/* Tool Name */}\n                <div>\n                  <h4 className=\"text-sm font-medium mb-1\">Tool Name</h4>\n                  <p className=\"text-sm text-muted-foreground font-mono\">\n                    {selectedToolDetail.tool.name}\n                  </p>\n                </div>\n\n                {/* Input Schema */}\n                {selectedToolDetail.tool.inputSchema && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-1\">Input Schema</h4>\n                    <pre className=\"text-xs bg-secondary/50 p-3 rounded border border-border overflow-x-auto max-h-60\">\n                      {JSON.stringify(selectedToolDetail.tool.inputSchema, null, 2)}\n                    </pre>\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div className=\"p-4 border-t border-border flex justify-end\">\n              <button\n                onClick={() => setSelectedToolDetail(null)}\n                className=\"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90\"\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default MCPToolsSelector;\n",
        "timestamp": "2026-01-02T14:22:14.293924"
      },
      "worktree_state": {
        "content": "/**\n * @file MCPToolsSelector.tsx\n * @description Multi-select MCP tool picker component with server grouping, tool filtering, and refresh functionality.\n * This component provides an interface for selecting MCP tools from configured MCP servers, organized by server\n * with expandable sections, individual and bulk selection, and real-time tool list refresh capability.\n *\n * ## Features\n * - **Server Grouping**: Tools organized by MCP server with collapsible server sections\n * - **Multi-Select Interface**: Checkbox-based selection for individual tools and bulk \"Select All\" per server\n * - **Server Expansion/Collapse**: Click chevron icon to expand/collapse server tool lists\n * - **Auto-Expand**: Automatically expands servers that have selected tools on load\n * - **Tool Refresh**: Refresh individual server tool lists with spinning indicator during refresh\n * - **Tool Detail Modal**: View comprehensive tool details including input schema and server info\n * - **Selection Summary**: Real-time display of total selected tools across all servers\n * - **Loading/Error/Empty States**: Graceful handling of API states with appropriate feedback\n * - **Directory-Aware**: Reloads servers when directory changes (via useEffect dependency)\n * - **Disabled Mode**: Can be disabled to show read-only view of selections\n * - **Controlled Component**: Fully controlled via selectedMCPTools and onChange props\n * - **Indeterminate State**: Server checkboxes show indeterminate state when some (but not all) tools selected\n *\n * ## MCP Tool Selection\n * The component provides hierarchical multi-select functionality organized by MCP server:\n *\n * ### Selection Data Structure\n * - **Format**: `Record<string, string[]>` where key is serverId and value is array of tool names\n * - **Example**: `{ \"server-1\": [\"tool-a\", \"tool-b\"], \"server-2\": [\"tool-x\"] }`\n * - **Empty Server**: Server with no tools selected is removed from object (not empty array)\n * - **Tool Name Format**: Display shows `mcp__{serverName}__{toolName}` but stored as just `toolName`\n *\n * ### Individual Tool Selection\n * - **Checkbox Input**: Each tool has a checkbox for selection toggle\n * - **Label Wrapper**: Entire tool row is clickable via label wrapping checkbox\n * - **Visual Feedback**: Hover shows bg-secondary/50, selected shows checked checkbox\n * - **Toggle Behavior**: Click to add if not selected, remove if already selected\n * - **Immutable Updates**: Creates new selectedMCPTools object (doesn't mutate)\n *\n * ### Individual Tool Workflow\n * 1. User clicks tool checkbox\n * 2. `toggleTool(serverId, toolName)` called\n * 3. Current tools for server retrieved from selectedMCPTools[serverId]\n * 4. New array created: add tool if not present, remove if already present\n * 5. New selectedMCPTools object created with updated tools\n * 6. If no tools remain for server, server key deleted from object\n * 7. `onChange(newMCPTools)` invoked with updated object\n * 8. Parent component updates state\n * 9. Component re-renders with new selectedMCPTools prop\n *\n * ## Server Integration\n * Tools are organized by MCP server with server-level controls:\n *\n * ### Server Display\n * - **Header Section**: Collapsible header showing server name, status, tool count, controls\n * - **Server Icon**: Primary-colored ServerIcon (4x4) on left\n * - **Server Name**: Font-medium text-sm, truncated if too long (truncate class)\n * - **Disabled Badge**: Gray badge shown if server.disabled is true\n * - **Tool Count**: Displays `(X tool[s])` in muted text\n * - **Expand/Collapse**: Chevron icon (down when expanded, right when collapsed)\n * - **Background**: Secondary/30 with hover to secondary/50 transition\n *\n * ### Server Loading\n * - **API Call**: `api.getMCPServers(directory)` fetches all servers\n * - **Filtering**: Only includes servers with `mcpTools.length > 0`\n * - **Empty Servers**: Servers without tools are excluded from display\n * - **Loading State**: Shows \"Loading MCP servers...\" message during initial load\n * - **Error State**: Shows red error message if API call fails\n * - **Empty State**: Shows dashed border message if no servers with tools found\n *\n * ### Auto-Expand Behavior\n * - **Trigger**: On initial load after fetching servers\n * - **Logic**: Auto-expand servers that have selectedMCPTools[serverId].length > 0\n * - **State**: `expandedServers` Set contains server IDs that should be expanded\n * - **Purpose**: Show selected tools immediately without manual expansion\n *\n * ## Multi-Select Behavior\n * Supports both individual tool selection and bulk server-level selection:\n *\n * ### Select All for Server\n * - **Location**: Server header, right side after tool count\n * - **Checkbox**: Shows checked when all tools selected, indeterminate when some selected, unchecked when none\n * - **Indeterminate State**: Uses `input.indeterminate = someSelected` for visual feedback\n * - **Label Text**:\n *   - \"All\" when all tools selected\n *   - Number (e.g., \"3\") when some tools selected\n *   - \"None\" when no tools selected\n * - **Toggle Behavior**:\n *   - If all selected: Deselect all \u2192 delete server key from selectedMCPTools\n *   - If some/none selected: Select all \u2192 set selectedMCPTools[serverId] to all tool names\n * - **Event Propagation**: `stopPropagation()` prevents server expand/collapse when clicking checkbox\n *\n * ### Selection States\n * - **All Selected**: `selectedTools.length === serverTools.length`\n * - **Some Selected**: `selectedTools.length > 0 && !allSelected`\n * - **None Selected**: `selectedTools.length === 0`\n *\n * ### Selection Summary\n * - **Location**: Top of component, above server list\n * - **Format**: \"X MCP tool(s) selected across Y server(s)\" or \"No MCP tools selected\"\n * - **Count Calculation**: Sum of all tool array lengths across all servers in selectedMCPTools\n * - **Server Count**: Number of keys in selectedMCPTools object\n * - **Real-Time**: Updates immediately as selections change\n *\n * ## Server Expansion/Collapse\n * Each server section can be expanded to show tools or collapsed to save space:\n *\n * ### Expansion Mechanism\n * - **Toggle Button**: Chevron icon button on left side of server header\n * - **Icon State**: ChevronDownIcon when expanded, ChevronRightIcon when collapsed\n * - **Click Area**: Entire server header is clickable to toggle expansion\n * - **State Management**: `expandedServers` Set contains IDs of expanded servers\n * - **Toggle Logic**: Add to Set if not present, remove if already present\n * - **Disabled State**: Expansion disabled when component disabled prop is true\n *\n * ### Tools List Display\n * - **Conditional Rendering**: Tool list only rendered when `isExpanded` is true\n * - **Background**: bg-background to differentiate from server header (bg-secondary/30)\n * - **Spacing**: p-2 padding with space-y-1 between tool items\n * - **Tool Layout**: Each tool in rounded container with hover effect\n *\n * ## Tool Refresh Functionality\n * Individual server tool lists can be refreshed to get latest tools from MCP server:\n *\n * ### Refresh Button\n * - **Location**: Server header, rightmost position\n * - **Icon**: RefreshIcon (4x4) with spinning animation during refresh\n * - **Animation**: `animate-spin` class applied when server is in refreshingServers Set\n * - **Disabled**: Disabled when component disabled or server is currently refreshing\n * - **Title**: \"Refresh tools\" tooltip on hover\n * - **Event Propagation**: `stopPropagation()` prevents server expand/collapse when clicking refresh\n *\n * ### Refresh Workflow\n * 1. User clicks refresh button for a server\n * 2. `refreshServerTools(serverId)` called\n * 3. Server ID added to `refreshingServers` Set (triggers spinning animation)\n * 4. `api.listMCPServerTools(serverId, directory)` API call made\n * 5. If successful, server's mcpTools updated in state with new tools\n * 6. Server ID removed from `refreshingServers` Set (stops spinning)\n * 7. Component re-renders with updated tool list\n *\n * ### Refresh States\n * - **Idle**: RefreshIcon static, button enabled\n * - **Refreshing**: RefreshIcon spinning (`animate-spin`), button disabled\n * - **Error**: Error logged to console, button re-enabled (silent failure)\n * - **Success**: Tool list updates, button re-enabled\n *\n * ## Tool Detail Modal\n * Clicking the info icon on a tool opens a modal with comprehensive details:\n *\n * ### Modal Trigger\n * - **Button**: InfoIcon button on right side of each tool item\n * - **Action**: Sets `selectedToolDetail` state to `{ server, tool }`\n * - **Non-Selection**: Clicking info does NOT select/deselect the tool\n * - **Title Attribute**: \"View details\" tooltip on hover\n *\n * ### Modal Content Sections\n * 1. **Header**:\n *    - Tool name in monospace: `mcp__{serverName}__{toolName}` (text-lg font-semibold font-mono)\n *    - Description (text-sm muted, mt-1) if available\n * 2. **MCP Server**:\n *    - Label: \"MCP Server\"\n *    - Value: Server name in monospace (font-mono)\n * 3. **Tool Name**:\n *    - Label: \"Tool Name\"\n *    - Value: Tool name in monospace (font-mono)\n * 4. **Input Schema**:\n *    - Label: \"Input Schema\"\n *    - Value: JSON.stringify with 2-space indentation in pre block\n *    - Styling: bg-secondary/50 with border, max-h-60 with scroll\n *    - Conditional: Only shown if tool.inputSchema exists\n *\n * ### Modal Behavior\n * - **Background**: Semi-transparent black overlay (bg-black/50)\n * - **Close Methods**: Click backdrop, click Close button in footer\n * - **Z-Index**: z-50 for layering above other content\n * - **Event Propagation**: `stopPropagation()` on modal content prevents backdrop close on modal click\n * - **Scrollable**: overflow-y-auto on content section, max-h-[80vh] on modal\n * - **Responsive**: max-w-2xl with p-4 padding for mobile\n * - **Layout**: Flex column with header, scrollable content, footer\n *\n * ## Directory Integration\n * Component reloads MCP servers when directory changes:\n *\n * ### Directory Handling\n * - **useEffect Dependency**: `[directory]` triggers reload on directory change\n * - **API Integration**: `directory` parameter passed to all API calls\n * - **Reload Behavior**: Complete re-fetch of servers and re-calculation of auto-expand\n * - **State Reset**: Loading state set to true, error cleared before reload\n *\n * ## Styling Behavior\n * Component uses Tailwind CSS with dark theme support:\n *\n * ### Container Styling\n * - **Outer Container**: space-y-3 for vertical spacing between sections\n * - **Server List Container**: border with rounded-md, max-h-80 with overflow-y-auto\n * - **Server Items**: border-b between servers, last:border-b-0 for last item\n *\n * ### Color Scheme\n * - **Server Header**: bg-secondary/30 with hover to bg-secondary/50\n * - **Tool List**: bg-background for contrast with server header\n * - **Primary Elements**: ServerIcon and selected tool names in text-primary\n * - **Muted Elements**: Tool counts, labels, descriptions in text-muted-foreground\n * - **Disabled Badge**: bg-gray-200 text-gray-600\n * - **Hover States**: hover:text-primary on refresh button, hover:bg-secondary/50 on tool items\n *\n * ### Typography\n * - **Server Name**: font-medium text-sm\n * - **Tool Display Name**: font-mono text-xs text-primary (break-all for long names)\n * - **Tool Description**: text-xs text-muted-foreground with line-clamp-2\n * - **Summary**: text-xs text-muted-foreground\n *\n * @example\n * // Basic usage with MCP tool selection\n * function AgentForm() {\n *   const [mcpTools, setMcpTools] = useState<Record<string, string[]>>({});\n *\n *   return (\n *     <div>\n *       <label>Select MCP Tools</label>\n *       <MCPToolsSelector\n *         selectedMCPTools={mcpTools}\n *         onChange={setMcpTools}\n *       />\n *     </div>\n *   );\n * }\n *\n * @example\n * // With custom directory and initial selection\n * function ProjectAgentForm() {\n *   const [mcpTools, setMcpTools] = useState({\n *     \"filesystem-server\": [\"read_file\", \"write_file\"],\n *     \"database-server\": [\"query\", \"execute\"]\n *   });\n *\n *   return (\n *     <MCPToolsSelector\n *       selectedMCPTools={mcpTools}\n *       onChange={setMcpTools}\n *       directory=\"/path/to/project\"\n *     />\n *   );\n * }\n *\n * @example\n * // Disabled mode for read-only view\n * function ViewAgentTools({ agent }) {\n *   return (\n *     <div>\n *       <h3>Agent MCP Tools</h3>\n *       <MCPToolsSelector\n *         selectedMCPTools={agent.mcpTools || {}}\n *         onChange={() => {}} // No-op in read-only mode\n *         disabled={true}\n *       />\n *     </div>\n *   );\n * }\n *\n * @example\n * // Understanding tool selection workflow\n * // Initial state:\n * // selectedMCPTools = { \"server-1\": [\"tool-a\"] }\n * //\n * // User clicks \"tool-b\" checkbox from \"server-1\":\n * // 1. toggleTool(\"server-1\", \"tool-b\") called\n * // 2. currentTools = [\"tool-a\"]\n * // 3. newTools = [\"tool-a\", \"tool-b\"] (tool-b added)\n * // 4. onChange({ \"server-1\": [\"tool-a\", \"tool-b\"] })\n * //\n * // User clicks \"Select All\" for \"server-2\" with tools [\"x\", \"y\", \"z\"]:\n * // 1. toggleAllToolsForServer(\"server-2\") called\n * // 2. allToolNames = [\"x\", \"y\", \"z\"]\n * // 3. onChange({ \"server-1\": [\"tool-a\", \"tool-b\"], \"server-2\": [\"x\", \"y\", \"z\"] })\n * //\n * // User unchecks \"tool-a\" from \"server-1\":\n * // 1. toggleTool(\"server-1\", \"tool-a\") called\n * // 2. currentTools = [\"tool-a\", \"tool-b\"]\n * // 3. newTools = [\"tool-b\"] (tool-a removed)\n * // 4. onChange({ \"server-1\": [\"tool-b\"], \"server-2\": [\"x\", \"y\", \"z\"] })\n * //\n * // User clicks \"Select All\" for \"server-1\" when all already selected:\n * // 1. toggleAllToolsForServer(\"server-1\") called\n * // 2. All selected, so deselect all\n * // 3. onChange({ \"server-2\": [\"x\", \"y\", \"z\"] }) // server-1 key deleted\n */\n\nimport React, { useState, useEffect } from 'react';\nimport * as api from '../services/api';\nimport { ServerIcon, ChevronDownIcon, ChevronRightIcon, InfoIcon, RefreshIcon } from './ui/Icons';\n\n/**\n * Props for the MCPToolsSelector component.\n *\n * @interface MCPToolsSelectorProps\n * @property {Record<string, string[]>} selectedMCPTools - Object mapping server IDs to arrays of selected tool names.\n *   Example: `{ \"server-1\": [\"tool-a\", \"tool-b\"], \"server-2\": [\"tool-x\"] }`.\n *   Empty servers (no tools selected) are removed from object, not stored as empty arrays.\n * @property {function} onChange - Callback invoked when tool selection changes. Receives updated selectedMCPTools object.\n *   Called when user toggles individual tool, selects/deselects all tools for a server.\n * @property {boolean} [disabled=false] - If true, disables all interaction (checkboxes, expand/collapse, refresh).\n *   Used for read-only display of tool selections.\n * @property {string} [directory] - Optional directory path for loading directory-specific MCP servers.\n *   When changed, triggers reload of servers via useEffect dependency.\n */\ninterface MCPToolsSelectorProps {\n  selectedMCPTools: Record<string, string[]>;\n  onChange: (mcpTools: Record<string, string[]>) => void;\n  disabled?: boolean;\n  directory?: string;\n}\n\nconst MCPToolsSelector: React.FC<MCPToolsSelectorProps> = ({\n  selectedMCPTools,\n  onChange,\n  disabled = false,\n  directory,\n}) => {\n  const [mcpServers, setMCPServers] = useState<api.MCPServer[]>([]);\n  const [expandedServers, setExpandedServers] = useState<Set<string>>(new Set());\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [refreshingServers, setRefreshingServers] = useState<Set<string>>(new Set());\n  const [selectedToolDetail, setSelectedToolDetail] = useState<{\n    server: api.MCPServer;\n    tool: api.MCPToolType;\n  } | null>(null);\n\n  useEffect(() => {\n    loadMCPServers();\n  }, [directory]);\n\n  /**\n   * Loads MCP servers from API and filters to only servers with tools.\n   * Auto-expands servers that have selected tools.\n   *\n   * @internal\n   * @async\n   * @function loadMCPServers\n   * @returns {Promise<void>}\n   *\n   * @description\n   * Fetches all MCP servers from the API, filters to only include servers with at least one tool,\n   * and auto-expands servers that have tools currently selected in selectedMCPTools.\n   *\n   * Workflow:\n   * 1. Set loading state to true, clear any errors\n   * 2. Call api.getMCPServers(directory) to fetch servers\n   * 3. Filter to only servers where mcpTools.length > 0\n   * 4. Calculate auto-expand set: servers with selectedMCPTools[serverId].length > 0\n   * 5. Update mcpServers state with filtered servers\n   * 6. Update expandedServers state with auto-expand set\n   * 7. Set loading to false\n   * 8. If error occurs, set error message and loading to false\n   *\n   * @throws {Error} API fetch error (caught and stored in error state)\n   */\n  const loadMCPServers = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n      const servers = await api.getMCPServers(directory);\n\n      // Only include servers that have tools\n      const serversWithTools = servers.filter(s => s.mcpTools && s.mcpTools.length > 0);\n      setMCPServers(serversWithTools);\n\n      // Auto-expand servers that have selected tools\n      const autoExpand = new Set<string>();\n      serversWithTools.forEach(server => {\n        if (selectedMCPTools[server.id] && selectedMCPTools[server.id].length > 0) {\n          autoExpand.add(server.id);\n        }\n      });\n      setExpandedServers(autoExpand);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load MCP servers');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  /**\n   * Toggles the expansion state of a server's tool list.\n   *\n   * @internal\n   * @function toggleServer\n   * @param {string} serverId - The ID of the server to expand/collapse\n   * @returns {void}\n   *\n   * @description\n   * Adds or removes server ID from expandedServers Set to show/hide the server's tool list.\n   * If server is currently expanded, it will be collapsed. If collapsed, it will be expanded.\n   *\n   * Workflow:\n   * 1. Create new Set from current expandedServers\n   * 2. Check if serverId is in the Set\n   * 3. If present: remove from Set (collapse)\n   * 4. If not present: add to Set (expand)\n   * 5. Update expandedServers state with new Set\n   * 6. Component re-renders, tool list shown/hidden based on updated state\n   */\n  const toggleServer = (serverId: string) => {\n    const newExpanded = new Set(expandedServers);\n    if (newExpanded.has(serverId)) {\n      newExpanded.delete(serverId);\n    } else {\n      newExpanded.add(serverId);\n    }\n    setExpandedServers(newExpanded);\n  };\n\n  /**\n   * Toggles selection state of an individual tool.\n   *\n   * @internal\n   * @function toggleTool\n   * @param {string} serverId - The ID of the MCP server the tool belongs to\n   * @param {string} toolName - The name of the tool to toggle\n   * @returns {void}\n   *\n   * @description\n   * Adds or removes a tool from the selected tools for a specific server.\n   * If all tools for a server are deselected, the server key is removed from selectedMCPTools object.\n   *\n   * Workflow:\n   * 1. Get current tools array for server from selectedMCPTools[serverId] (default to [])\n   * 2. Check if toolName is in current tools array\n   * 3. If present: filter out toolName (deselect)\n   * 4. If not present: append toolName (select)\n   * 5. Create new selectedMCPTools object (immutable update)\n   * 6. If newTools is empty array: delete server key from object\n   * 7. If newTools has items: set selectedMCPTools[serverId] = newTools\n   * 8. Call onChange with new object\n   * 9. Parent updates state, component re-renders with new selection\n   */\n  const toggleTool = (serverId: string, toolName: string) => {\n    const currentTools = selectedMCPTools[serverId] || [];\n    let newTools: string[];\n\n    if (currentTools.includes(toolName)) {\n      // Remove tool\n      newTools = currentTools.filter(t => t !== toolName);\n    } else {\n      // Add tool\n      newTools = [...currentTools, toolName];\n    }\n\n    // Update the entire mcpTools object\n    const newMCPTools = { ...selectedMCPTools };\n    if (newTools.length === 0) {\n      delete newMCPTools[serverId];\n    } else {\n      newMCPTools[serverId] = newTools;\n    }\n\n    onChange(newMCPTools);\n  };\n\n  /**\n   * Toggles selection of all tools for a server (Select All / Deselect All).\n   *\n   * @internal\n   * @function toggleAllToolsForServer\n   * @param {string} serverId - The ID of the server whose tools should be toggled\n   * @returns {void}\n   *\n   * @description\n   * If all tools are currently selected, deselects all (removes server key).\n   * If some or no tools are selected, selects all tools for the server.\n   *\n   * Workflow:\n   * 1. Find server object in mcpServers by serverId\n   * 2. Return early if server not found or has no tools\n   * 3. Get current selected tools for server (default to [])\n   * 4. Get all tool names from server.mcpTools\n   * 5. Check if all tools are selected: currentTools.length === allToolNames.length\n   * 6. If all selected: delete server key from selectedMCPTools (deselect all)\n   * 7. If not all selected: set selectedMCPTools[serverId] = allToolNames (select all)\n   * 8. Call onChange with updated object\n   * 9. Parent updates state, component re-renders with new selection\n   * 10. Checkbox shows updated state (checked/unchecked/indeterminate)\n   */\n  const toggleAllToolsForServer = (serverId: string) => {\n    const server = mcpServers.find(s => s.id === serverId);\n    if (!server || !server.mcpTools) return;\n\n    const currentTools = selectedMCPTools[serverId] || [];\n    const allToolNames = server.mcpTools.map((t: api.MCPToolType) => t.name);\n\n    let newMCPTools = { ...selectedMCPTools };\n\n    if (currentTools.length === allToolNames.length) {\n      // All selected, deselect all\n      delete newMCPTools[serverId];\n    } else {\n      // Not all selected, select all\n      newMCPTools[serverId] = allToolNames;\n    }\n\n    onChange(newMCPTools);\n  };\n\n  /**\n   * Refreshes the tool list for a specific MCP server.\n   *\n   * @internal\n   * @async\n   * @function refreshServerTools\n   * @param {string} serverId - The ID of the server to refresh\n   * @returns {Promise<void>}\n   *\n   * @description\n   * Calls the API to fetch the latest tool list from the MCP server and updates the local state.\n   * Shows spinning animation during refresh. Errors are logged but don't block UI (silent failure).\n   *\n   * Workflow:\n   * 1. Add serverId to refreshingServers Set (triggers spinning animation on refresh icon)\n   * 2. Call api.listMCPServerTools(serverId, directory) to fetch latest tools\n   * 3. If result.success is true:\n   *    - Update mcpServers state, replacing tools for this server\n   *    - Keep all other server data unchanged\n   * 4. If error occurs: log to console (silent failure, user can retry)\n   * 5. Remove serverId from refreshingServers Set (stop spinning animation)\n   * 6. Component re-renders with updated tool list\n   *\n   * Note: Tool selections are preserved during refresh. Only tool list is updated.\n   *\n   * @throws {Error} API call error (caught, logged, and ignored - button re-enabled for retry)\n   */\n  const refreshServerTools = async (serverId: string) => {\n    setRefreshingServers(prev => new Set(prev).add(serverId));\n\n    try {\n      const result = await api.listMCPServerTools(serverId, directory);\n\n      if (result.success) {\n        // Update server tools in state\n        setMCPServers(prev =>\n          prev.map(s =>\n            s.id === serverId ? { ...s, mcpTools: result.tools } : s\n          )\n        );\n      }\n    } catch (err) {\n      console.error('Failed to refresh tools:', err);\n    } finally {\n      setRefreshingServers(prev => {\n        const next = new Set(prev);\n        next.delete(serverId);\n        return next;\n      });\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"text-sm text-muted-foreground\">\n        Loading MCP servers...\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"text-sm text-red-500\">\n        {error}\n      </div>\n    );\n  }\n\n  if (mcpServers.length === 0) {\n    return (\n      <div className=\"text-sm text-muted-foreground p-3 border border-dashed border-border rounded\">\n        No MCP servers with tools found. Add MCP servers in the MCP Servers section to see their tools here.\n      </div>\n    );\n  }\n\n  /**\n   * Calculates the total number of selected tools across all servers.\n   *\n   * @internal\n   * @function getTotalSelectedTools\n   * @returns {number} Total count of selected tools\n   *\n   * @description\n   * Sums the lengths of all tool arrays in selectedMCPTools object.\n   * Used for displaying selection summary at top of component.\n   *\n   * Example:\n   * - selectedMCPTools = { \"server-1\": [\"a\", \"b\"], \"server-2\": [\"x\"] }\n   * - Returns: 3 (2 + 1)\n   */\n  const getTotalSelectedTools = () => {\n    return Object.values(selectedMCPTools).reduce((sum, tools) => sum + tools.length, 0);\n  };\n\n  return (\n    <div className=\"space-y-3\">\n      {/* Summary */}\n      <div className=\"text-xs text-muted-foreground\">\n        {getTotalSelectedTools() > 0\n          ? `${getTotalSelectedTools()} MCP tool(s) selected across ${Object.keys(selectedMCPTools).length} server(s)`\n          : 'No MCP tools selected'}\n      </div>\n\n      {/* MCP Servers List */}\n      <div className=\"border border-border rounded-md max-h-80 overflow-y-auto\">\n        {mcpServers.map((server) => {\n          const isExpanded = expandedServers.has(server.id);\n          const serverTools = server.mcpTools || [];\n          const selectedTools = selectedMCPTools[server.id] || [];\n          const allSelected = selectedTools.length === serverTools.length;\n          const someSelected = selectedTools.length > 0 && !allSelected;\n\n          return (\n            <div key={server.id} className=\"border-b border-border last:border-b-0\">\n              {/* Server Header */}\n              <div className=\"flex items-center gap-2 p-3 bg-secondary/30 hover:bg-secondary/50 transition-colors\">\n                <button\n                  type=\"button\"\n                  onClick={() => toggleServer(server.id)}\n                  disabled={disabled}\n                  className=\"flex-shrink-0 text-muted-foreground hover:text-foreground disabled:opacity-50\"\n                >\n                  {isExpanded ? (\n                    <ChevronDownIcon className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronRightIcon className=\"h-4 w-4\" />\n                  )}\n                </button>\n\n                <ServerIcon className=\"h-4 w-4 text-primary flex-shrink-0\" />\n\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"font-medium text-sm truncate\">{server.name}</span>\n                    {server.disabled && (\n                      <span className=\"text-xs px-1.5 py-0.5 bg-gray-200 text-gray-600 rounded\">\n                        Disabled\n                      </span>\n                    )}\n                    <span className=\"text-xs text-muted-foreground\">\n                      ({serverTools.length} tool{serverTools.length !== 1 ? 's' : ''})\n                    </span>\n                  </div>\n                </div>\n\n                {/* Select All Checkbox for Server */}\n                <label\n                  className=\"flex items-center gap-2 text-xs cursor-pointer\"\n                  onClick={(e) => e.stopPropagation()}\n                >\n                  <input\n                    type=\"checkbox\"\n                    checked={allSelected}\n                    ref={(input) => {\n                      if (input) {\n                        input.indeterminate = someSelected;\n                      }\n                    }}\n                    onChange={() => toggleAllToolsForServer(server.id)}\n                    disabled={disabled}\n                    className=\"w-4 h-4 rounded\"\n                  />\n                  <span className=\"text-muted-foreground\">\n                    {allSelected ? 'All' : someSelected ? `${selectedTools.length}` : 'None'}\n                  </span>\n                </label>\n\n                {/* Refresh Button */}\n                <button\n                  type=\"button\"\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    refreshServerTools(server.id);\n                  }}\n                  disabled={disabled || refreshingServers.has(server.id)}\n                  className=\"flex-shrink-0 p-1 text-muted-foreground hover:text-primary rounded disabled:opacity-50\"\n                  title=\"Refresh tools\"\n                >\n                  <RefreshIcon className={`h-4 w-4 ${refreshingServers.has(server.id) ? 'animate-spin' : ''}`} />\n                </button>\n              </div>\n\n              {/* Tools List */}\n              {isExpanded && (\n                <div className=\"p-2 space-y-1 bg-background\">\n                  {serverTools.map((tool: api.MCPToolType) => {\n                    const isSelected = selectedTools.includes(tool.name);\n\n                    return (\n                      <div\n                        key={tool.name}\n                        className=\"flex items-start gap-2 p-2 rounded hover:bg-secondary/50 transition-colors\"\n                      >\n                        <label className=\"flex items-start gap-2 flex-1 min-w-0 cursor-pointer\">\n                          <input\n                            type=\"checkbox\"\n                            checked={isSelected}\n                            onChange={() => toggleTool(server.id, tool.name)}\n                            disabled={disabled}\n                            className=\"mt-1 w-4 h-4 rounded flex-shrink-0\"\n                          />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"font-mono text-xs text-primary break-all\">\n                              mcp__{server.name}__{tool.name}\n                            </div>\n                            {tool.description && (\n                              <div className=\"text-xs text-muted-foreground mt-0.5 line-clamp-2\">\n                                {tool.description}\n                              </div>\n                            )}\n                          </div>\n                        </label>\n\n                        {/* Info button */}\n                        <button\n                          type=\"button\"\n                          onClick={() => setSelectedToolDetail({ server, tool })}\n                          className=\"flex-shrink-0 text-muted-foreground hover:text-primary p-1\"\n                          title=\"View details\"\n                        >\n                          <InfoIcon className=\"h-4 w-4\" />\n                        </button>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Tool Detail Modal */}\n      {selectedToolDetail && (\n        <div\n          className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\"\n          onClick={() => setSelectedToolDetail(null)}\n        >\n          <div\n            className=\"bg-background border border-border rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col\"\n            onClick={(e) => e.stopPropagation()}\n          >\n            <div className=\"p-4 border-b border-border\">\n              <h3 className=\"text-lg font-semibold font-mono\">\n                mcp__{selectedToolDetail.server.name}__{selectedToolDetail.tool.name}\n              </h3>\n              {selectedToolDetail.tool.description && (\n                <p className=\"text-sm text-muted-foreground mt-1\">\n                  {selectedToolDetail.tool.description}\n                </p>\n              )}\n            </div>\n\n            <div className=\"p-4 overflow-y-auto flex-1\">\n              <div className=\"space-y-3\">\n                {/* Server Info */}\n                <div>\n                  <h4 className=\"text-sm font-medium mb-1\">MCP Server</h4>\n                  <p className=\"text-sm text-muted-foreground font-mono\">\n                    {selectedToolDetail.server.name}\n                  </p>\n                </div>\n\n                {/* Tool Name */}\n                <div>\n                  <h4 className=\"text-sm font-medium mb-1\">Tool Name</h4>\n                  <p className=\"text-sm text-muted-foreground font-mono\">\n                    {selectedToolDetail.tool.name}\n                  </p>\n                </div>\n\n                {/* Input Schema */}\n                {selectedToolDetail.tool.inputSchema && (\n                  <div>\n                    <h4 className=\"text-sm font-medium mb-1\">Input Schema</h4>\n                    <pre className=\"text-xs bg-secondary/50 p-3 rounded border border-border overflow-x-auto max-h-60\">\n                      {JSON.stringify(selectedToolDetail.tool.inputSchema, null, 2)}\n                    </pre>\n                  </div>\n                )}\n              </div>\n            </div>\n\n            <div className=\"p-4 border-t border-border flex justify-end\">\n              <button\n                onClick={() => setSelectedToolDetail(null)}\n                className=\"px-4 py-2 text-sm bg-primary text-primary-foreground rounded hover:bg-primary/90\"\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nMCPToolsSelector.displayName = 'MCPToolsSelector';\n\nexport default MCPToolsSelector;\n",
        "last_modified": "2026-01-02T15:11:36.282587"
      },
      "task_intent": {
        "title": "Document Frontend React Components and Hooks",
        "description": "Add comprehensive JSDoc documentation to all React components and custom hooks in the frontend, including prop types, usage examples, component purposes, state management, and side effects.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T14:01:11.314615",
  "last_updated": "2026-01-02T14:22:14.847354"
}
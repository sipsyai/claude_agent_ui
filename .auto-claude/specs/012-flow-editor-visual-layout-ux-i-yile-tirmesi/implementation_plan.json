{
  "feature": "Canvas-First Layout Restructure for FlowEditorVisual",
  "workflow_type": "feature",
  "workflow_rationale": "This is a significant UI/UX enhancement that adds new layout patterns (collapsible sidebar, floating toolbar, toast notifications) and restructures the page hierarchy. It's adding new interface patterns rather than refactoring existing ones, making it a feature enhancement workflow.",
  "phases": [
    {
      "id": "phase-1-toast-system",
      "name": "Toast Notification System",
      "type": "implementation",
      "description": "Create simple toast notification system for validation messages (no new dependencies)",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create Toast UI component with auto-dismiss and manual close",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/web/manager/components/ui/Toast.tsx"
          ],
          "patterns_from": [
            "src/web/manager/components/ui/Dialog.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'export.*Toast' src/web/manager/components/ui/Toast.tsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Toast UI component created successfully with all required features: auto-dismiss (5s default), manual close button, success/error/warning/info variants, slide-up animation, top-right positioning, and ToastContainer for managing multiple toasts. Follows existing code patterns from Dialog.tsx.",
          "updated_at": "2026-01-02T19:07:58.842693+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Create ToastContext for global toast state management",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/web/manager/contexts/ToastContext.tsx"
          ],
          "patterns_from": [
            "src/web/manager/contexts/FlowCanvasContext.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'ToastProvider\\|useToast' src/web/manager/contexts/ToastContext.tsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "ToastContext created successfully with full type safety. Provides addToast, removeToast, and clearAllToasts functions. Supports all toast variants (success, error, warning, info). Includes automatic toast ID generation, max toast limit (default 5), and auto-removal of oldest toasts when limit exceeded. ToastProvider renders ToastContainer automatically with all active toasts. Follows existing code patterns from FlowCanvasContext.tsx.",
          "updated_at": "2026-01-02T19:09:56.563099+00:00"
        }
      ]
    },
    {
      "id": "phase-2-sidebar-component",
      "name": "Configuration Sidebar Component",
      "type": "implementation",
      "description": "Create collapsible left sidebar component to house metadata and triggers sections",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create ConfigSidebar component with collapse/expand state",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/web/manager/components/flow-canvas/ConfigSidebar.tsx"
          ],
          "patterns_from": [
            "src/web/manager/components/flow-canvas/NodePalette.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'ConfigSidebar' src/web/manager/components/flow-canvas/ConfigSidebar.tsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "ConfigSidebar component created successfully with all required features: collapse/expand state (320px \u2194 50px), smooth CSS transitions (300ms), collapsible sections for Metadata and Triggers, localStorage persistence for collapsed state, theme-aware styling, full accessibility support (ARIA labels, keyboard navigation), and responsive design. Follows patterns from NodePalette.tsx including comprehensive JSDoc documentation, TypeScript interfaces, and proper component structure. Supports both controlled and uncontrolled modes via optional props.",
          "updated_at": "2026-01-02T19:12:02.849895+00:00"
        }
      ]
    },
    {
      "id": "phase-3-floating-palette",
      "name": "Floating NodePalette Toolbar",
      "type": "implementation",
      "description": "Convert fixed NodePalette sidebar to compact floating toolbar overlay",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create FloatingNodePalette component as dropdown/expandable toolbar",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/web/manager/components/flow-canvas/FloatingNodePalette.tsx"
          ],
          "patterns_from": [
            "src/web/manager/components/flow-canvas/NodePalette.tsx"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'FloatingNodePalette' src/web/manager/components/flow-canvas/FloatingNodePalette.tsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "FloatingNodePalette component created successfully with all required features: compact floating toolbar (48px circular button), expandable dropdown panel (280px width), all three node types (Input, Agent, Output) with drag-and-drop support, absolute positioning with configurable placement (top-left default, also supports top-right, bottom-left, bottom-right), smooth animations (slide-in/fade-in transitions), click-outside-to-close behavior, Escape key support, theme-aware styling, full accessibility (ARIA labels, keyboard navigation), and visual feedback during drag operations. Follows patterns from NodePalette.tsx including comprehensive JSDoc documentation, TypeScript interfaces, and proper component structure. Component is ready to be integrated into FlowEditorVisual layout.",
          "updated_at": "2026-01-02T19:14:07.356415+00:00"
        }
      ]
    },
    {
      "id": "phase-4-restructure-layout",
      "name": "Restructure FlowEditorVisual Layout",
      "type": "implementation",
      "description": "Integrate new components: minimal top bar, sidebar, floating palette, and expand canvas to 80-90% width",
      "depends_on": [
        "phase-1-toast-system",
        "phase-2-sidebar-component",
        "phase-3-floating-palette"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Refactor top bar to minimal design (flow name + Save/Cancel only)",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/FlowEditorVisual.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Visually inspect top bar: height \u226450px, contains only Back button, Flow name (editable), Save/Cancel buttons"
          },
          "status": "completed",
          "notes": "Successfully refactored top bar to minimal design. Header now has exactly 50px height with Back button, editable flow name input, and Save/Cancel buttons. Removed all metadata form elements from header. Error/validation displays moved below header in compact format.",
          "updated_at": "2026-01-02T19:16:37.444471+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Integrate ConfigSidebar to replace header metadata and footer triggers sections",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/FlowEditorVisual.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/web/manager/components/flow-canvas/ConfigSidebar.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify sidebar contains metadata and triggers sections; collapse/expand works; canvas width adjusts"
          },
          "status": "completed",
          "notes": "Successfully integrated ConfigSidebar component. Metadata (name, slug, description, category, status, version, isActive) now in collapsible left sidebar. Triggers (schedule & webhook) also moved to sidebar. Header simplified to show flow name display with Back/Save/Cancel. Footer removed. Sidebar collapse/expand working via ConfigSidebar's built-in functionality.",
          "updated_at": "2026-01-02T19:22:05.397428+00:00"
        },
        {
          "id": "subtask-4-3",
          "description": "Replace NodePalette with FloatingNodePalette in canvas area",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/FlowEditorVisual.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/web/manager/components/flow-canvas/FloatingNodePalette.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify FloatingNodePalette appears as overlay on canvas; does not reduce canvas dimensions; drag-drop works"
          },
          "status": "completed",
          "notes": "Successfully replaced NodePalette with FloatingNodePalette in FlowEditorVisual.tsx. The FloatingNodePalette now appears as an overlay on the canvas (absolute positioned at top-left) instead of taking up space in the flex layout. Updated all imports and documentation to reflect the new architecture. TypeScript compilation verified with no new errors. Changes committed to git.",
          "updated_at": "2026-01-02T19:23:49.787525+00:00"
        },
        {
          "id": "subtask-4-4",
          "description": "Convert validation messages to toast notifications",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/FlowEditorVisual.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/web/manager/contexts/ToastContext.tsx"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Trigger validation error (e.g., save with empty name); verify toast appears in top-right corner, not inline banner"
          },
          "status": "completed",
          "notes": "Successfully converted validation messages from inline banners to toast notifications. Removed the error state and inline banner display (lines 703-751). Updated all validation error handling in handleSave and loadFlow to use addToast with appropriate error messages. Added success toast on successful save. Validation state is still maintained for Save button disabling, but errors are now shown in top-right corner as toasts instead of inline banners.",
          "updated_at": "2026-01-02T19:26:45.262814+00:00"
        },
        {
          "id": "subtask-4-5",
          "description": "Adjust canvas layout to fill 80-90% width and full height",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/FlowEditorVisual.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3001/flows/new",
            "checks": [
              "Canvas occupies ~80-90% horizontal space",
              "Canvas full height (100vh minus top bar)",
              "Sidebar visible on left (collapsible)",
              "FloatingNodePalette appears as overlay",
              "No horizontal scroll"
            ]
          },
          "status": "completed",
          "notes": "Canvas layout adjusted successfully:\n- Root container: Added overflow-hidden to prevent horizontal scroll\n- Main canvas container: Added explicit height calc(100vh - 50px) for full viewport height\n- Canvas area: Added overflow-hidden h-full for proper containment\n- Canvas occupies ~83% width when sidebar expanded (320px), ~97% when collapsed (50px)\n- Full height achieved: 100vh minus 50px header\n- Sidebar remains collapsible on left\n- FloatingNodePalette and CanvasToolbar confirmed as overlays\n- No horizontal scroll issues",
          "updated_at": "2026-01-02T19:30:27.534738+00:00"
        }
      ]
    },
    {
      "id": "phase-5-responsive-design",
      "name": "Responsive Design and Edge Cases",
      "type": "implementation",
      "description": "Implement responsive behavior for mobile/tablet and handle edge cases (long names, multiple errors, etc.)",
      "depends_on": [
        "phase-4-restructure-layout"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add responsive breakpoints for mobile/tablet (sidebar auto-collapses <768px)",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/flow-canvas/ConfigSidebar.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3001/flows/new",
            "checks": [
              "Resize to <768px width",
              "Sidebar auto-collapses or becomes drawer",
              "Canvas remains usable",
              "FloatingNodePalette adjusts position"
            ]
          },
          "status": "completed",
          "notes": "Successfully implemented responsive breakpoints for ConfigSidebar. Sidebar auto-collapses at <768px viewport width and restores user preference at >=768px. User preferences are preserved separately from auto-collapse behavior. Manual toggle remains functional at all viewport sizes.",
          "updated_at": "2026-01-02T19:32:50.235933+00:00"
        },
        {
          "id": "subtask-5-2",
          "description": "Handle edge cases: long flow names (truncate), multiple validation errors (stack toasts)",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/FlowEditorVisual.tsx",
            "src/web/manager/components/ui/Toast.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Test with 100-char flow name (truncates with ellipsis); trigger multiple errors (toasts stack vertically)"
          },
          "status": "completed",
          "notes": "Successfully implemented edge case handling:\n\n1. Long flow names: Added truncation with ellipsis in header, including min-w-0, max-w-full, and title tooltip for full name display\n\n2. Multiple validation errors: Modified to create separate stacked toasts for each validation error instead of one combined message\n\n3. Toast container improvements: Increased gap to 12px, added max-height and overflow handling for proper stacking\n\nAll changes committed. Manual verification documented in EDGE_CASE_VERIFICATION.md",
          "updated_at": "2026-01-02T19:35:40.556867+00:00"
        },
        {
          "id": "subtask-5-3",
          "description": "Add localStorage persistence for sidebar collapsed state",
          "service": "main",
          "files_to_modify": [
            "src/web/manager/components/flow-canvas/ConfigSidebar.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Collapse sidebar, refresh page, verify sidebar remains collapsed"
          },
          "status": "completed",
          "notes": "localStorage persistence was already fully implemented in subtask-2-1 when ConfigSidebar was created. Implementation verified:\n- Loads from localStorage on mount (line 254: localStorage.getItem('flowEditor.sidebarCollapsed'))\n- Saves to localStorage when state changes (line 267: localStorage.setItem('flowEditor.sidebarCollapsed', String(isCollapsed)))\n- Only operates in uncontrolled mode\n- Preserves user preference separately from mobile auto-collapse\n- Uses correct key as specified in plan\n\nNo code changes needed. Feature is fully functional and ready for manual verification.",
          "updated_at": "2026-01-02T19:39:17.234326+00:00"
        }
      ]
    },
    {
      "id": "phase-6-verification",
      "name": "Testing and Verification",
      "type": "integration",
      "description": "Verify all existing functionality preserved and new layout works correctly",
      "depends_on": [
        "phase-5-responsive-design"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Verify all metadata fields functional in sidebar",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open flow editor",
              "Fill all metadata fields in sidebar (name, slug, description, category, status, version)",
              "Toggle isActive checkbox",
              "Save flow",
              "Verify all fields saved correctly by reloading flow"
            ]
          },
          "status": "pending",
          "notes": "No functional regression - all form inputs work identically to before"
        },
        {
          "id": "subtask-6-2",
          "description": "Verify trigger and schedule configuration functional in sidebar",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open flow editor",
              "Expand triggers section in sidebar",
              "Enable webhook trigger, set secret",
              "Configure schedule (cron expression)",
              "Save flow",
              "Verify webhook and schedule saved correctly"
            ]
          },
          "status": "pending",
          "notes": "FlowScheduleConfig component must work in sidebar context"
        },
        {
          "id": "subtask-6-3",
          "description": "Verify node operations (add, edit, delete, connect) work with new layout",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open FloatingNodePalette",
              "Drag Input node to canvas",
              "Drag Agent node to canvas",
              "Connect Input \u2192 Agent",
              "Click Agent node to open config panel",
              "Edit node properties",
              "Save flow",
              "Verify flow nodes saved correctly"
            ]
          },
          "status": "pending",
          "notes": "ReactFlow integration must remain fully functional - no canvas operation breakage"
        },
        {
          "id": "subtask-6-4",
          "description": "Verify validation messages appear as toasts and block save when errors exist",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open flow editor",
              "Leave flow name empty",
              "Click Save",
              "Verify error toast appears ('Flow name is required')",
              "Verify Save button disabled or save blocked",
              "Fill flow name",
              "Verify toast dismissed or success toast appears",
              "Verify Save button enabled"
            ]
          },
          "status": "pending",
          "notes": "Toast messages must match previous inline validation messages; save blocking logic preserved"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 15,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": [
            "phase-1-toast-system",
            "phase-2-sidebar-component",
            "phase-3-floating-palette"
          ],
          "reason": "All three have no dependencies and work on different components, no file conflicts"
        }
      ],
      "recommended_workers": 3,
      "speedup_estimate": "2x faster than sequential (3 parallel phases initially, then sequential integration)"
    },
    "startup_command": "npm run dev"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "Canvas occupies 80-90% screen width and full height (minus top bar)",
      "Sidebar contains metadata and triggers, is collapsible",
      "Top bar is minimal (\u226450px height, flow name + Save/Cancel only)",
      "FloatingNodePalette appears as canvas overlay, not fixed sidebar",
      "Validation messages appear as toasts in top-right corner",
      "All existing functionality preserved (no functional regression)",
      "Responsive design works on mobile/tablet (<768px)",
      "No console errors or warnings",
      "All original tests pass (if any exist)"
    ],
    "verification_steps": [
      {
        "name": "Component Unit Tests",
        "command": "npm test -- --testPathPattern='FlowEditorVisual|Toast|ConfigSidebar|FloatingNodePalette'",
        "expected_outcome": "All tests pass or no tests exist (component tests may not be present)",
        "type": "test",
        "required": false,
        "blocking": false
      },
      {
        "name": "Browser Manual Verification",
        "command": "npm run dev",
        "expected_outcome": "Navigate to http://localhost:3001/flows/new and verify layout changes visually",
        "type": "manual",
        "required": true,
        "blocking": true
      },
      {
        "name": "Functional Regression Test",
        "command": "Manual E2E test flow: Create flow \u2192 Fill metadata \u2192 Add nodes \u2192 Configure triggers \u2192 Save",
        "expected_outcome": "Flow saved successfully with all data preserved",
        "type": "manual",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk UI refactor requires verification that all existing functionality (metadata editing, trigger config, node operations, save/cancel) remains functional after layout restructuring. Manual browser verification is critical since automated UI tests may not exist for this component."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": false,
      "commands": [
        "npm test"
      ],
      "minimum_coverage": null,
      "notes": "Unit tests may not exist for UI components; if they do, they must pass"
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "Manual integration test via browser"
      ],
      "services_to_test": [
        "main"
      ],
      "notes": "Must verify metadata form, trigger configuration, node operations, and save functionality all work in new layout"
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "Manual E2E flow creation and editing"
      ],
      "flows": [
        "create-new-flow-with-metadata-triggers-nodes",
        "edit-existing-flow-verify-data-preserved",
        "sidebar-collapse-expand-canvas-resize"
      ],
      "notes": "Critical E2E flows to verify before sign-off"
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3001/flows/new",
          "checks": [
            "Canvas occupies 80-90% width, full height",
            "Sidebar visible on left (320px when expanded)",
            "Top bar minimal (\u226450px)",
            "FloatingNodePalette appears as overlay on canvas",
            "Toasts appear in top-right corner on validation errors",
            "No console errors",
            "Sidebar collapse/expand works smoothly",
            "Responsive: sidebar auto-collapses at <768px width"
          ]
        },
        {
          "url": "http://localhost:3001/flows/{existing-flow-id}/edit",
          "checks": [
            "Existing flow loads correctly in new layout",
            "All metadata displayed in sidebar",
            "Canvas shows existing nodes/edges",
            "No data loss or display issues"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": [],
      "notes": "No database schema changes for this UI-only task"
    }
  },
  "qa_signoff": null,
  "last_updated": "2026-01-02T19:39:17.234352+00:00"
}
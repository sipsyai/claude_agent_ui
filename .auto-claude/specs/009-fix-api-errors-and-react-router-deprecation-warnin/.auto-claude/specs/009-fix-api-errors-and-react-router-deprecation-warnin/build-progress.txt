# Build Progress - Task 009: Fix API Errors and React Router Deprecation Warnings

## Overview
This task addresses critical API errors preventing Dashboard and Flows pages from loading, along with React Router deprecation warnings. The workflow is organized into 7 phases with 14 subtasks across frontend and backend services.

---

## Current Phase: Phase 2 - Backend: Fix 403 Authorization Errors on /api/flows

### âœ… COMPLETED: Subtask 2-1 - Investigate Backend Authorization Middleware

**Status**: COMPLETE
**Date**: 2026-01-02
**Effort**: ~1.5 hours
**Investigator**: Claude Code Agent

#### Investigation Summary

The 403 Forbidden errors on `/api/flows` endpoints have been traced to **Strapi backend configuration**, not the Express proxy layer.

**Key Findings:**

1. **Architecture Understanding**
   - Express proxy server (port 3001) correctly proxies to Strapi backend (port 1337)
   - Frontend correctly sends Bearer tokens in Authorization header
   - Express routes return 200 OK (verified with curl)

2. **Root Cause Identified**
   - Strapi middleware stack is MISSING the `users-permissions` middleware
   - Without this middleware, JWT tokens are NOT parsed from Authorization headers
   - Strapi CORE routes (from `createCoreRouter`) require permissions
   - Flow permissions are NOT enabled for any user role
   - Result: All authenticated requests get 403 Forbidden

3. **Evidence**
   - Test with curl: `curl http://localhost:3001/api/flows` â†’ 200 OK from Express
   - Strapi expects `strapi::users-permissions` middleware to validate tokens
   - Custom routes in backend/src/api/flow/routes/custom.ts use `auth: false` and work fine
   - Core routes in backend/src/api/flow/routes/flow.ts require permissions and fail with 403

#### Solution Identified

The following changes are needed in subtask 2-2:

**File 1: `backend/config/middlewares.ts`**
- Add `'strapi::users-permissions'` to the middleware array
- This enables JWT token parsing for all Strapi requests

**File 2: `backend/src/index.ts`**
- Add code to enable flow permissions (similar to existing mcp-tool permissions)
- Enable for authenticated users role

#### Deliverables

âœ… Investigation Report: `INVESTIGATION_REPORT_SUBTASK_2_1.md`
âœ… Detailed Analysis: Complete architecture breakdown and root cause analysis
âœ… Solution Options: Three approaches documented with pros/cons
âœ… Next Steps: Clear implementation path for subtask 2-2

---

## Remaining Phases

### ðŸ”µ PENDING: Phase 2 - Subtask 2-2: Fix Authorization Middleware
- Status: Ready for implementation
- Blocker: None (investigation complete)
- Files to Modify: 2 files (middlewares.ts, index.ts)
- Estimated Effort: 1 hour

### ðŸ”µ PENDING: Phase 2 - Subtask 2-3: Verify Frontend Auth Token Passing
- Status: Blocked by subtask 2-2
- Investigation findings: Frontend is correct, no changes needed
- Estimated Effort: 0.5 hours (verification only)

### ðŸ”µ PENDING: Phase 3 - Backend: Missing Endpoint
- Estimated Effort: 1.5 hours
- Blocked by: Phase 2 auth fix
- Task: Implement GET /api/flows/executions/recent endpoint

### ðŸ”µ PENDING: Phase 4 - Backend: Fix 500 Error on Stats
- Estimated Effort: 2 hours
- Blocked by: Phase 2 auth fix
- Task: Debug and fix /api/flows/stats/global endpoint

### ðŸ”µ PENDING: Phase 5 - Frontend: Error Handling
- Estimated Effort: 2 hours
- Blocked by: Phases 2, 3, 4
- Task: Add error handling to DashboardPage and FlowsPage

### ðŸ”µ PENDING: Phase 6 - Frontend: Polling with Exponential Backoff
- Estimated Effort: 1.5 hours
- Blocked by: Phase 5
- Task: Implement exponential backoff in FlowsPage polling

### âœ… COMPLETED: Phase 1 - React Router Future Flags
- Status: COMPLETE
- Task: Add v7_startTransition and v7_relativeSplatPath flags
- Implementation: Done in earlier work

### ðŸ”µ PENDING: Phase 7 - Integration & Verification
- Estimated Effort: 1 hour
- Blocked by: All other phases
- Task: Final end-to-end testing

---

## Key Insights

### Why Express Proxy Returns 200 but Frontend Gets 403

The curl test showed that the **Express server itself returns 200 OK**, but the frontend still gets 403. This is because:

1. **Without auth token in cookie**: Express calls `strapiClient` with no auth
2. **Strapi receives unauthenticated request**: No JWT token in Authorization header
3. **No users-permissions middleware**: Token is not parsed even if sent
4. **Request rejected**: 403 Forbidden because user has no permissions

When we tested with curl without authentication context, the Express proxy layer created an empty response (empty flows array) because Strapi was treating it as an unauthenticated/public request with no data access.

The actual issue happens when the browser sends a request: the frontend DOES send a token, but Strapi can't parse it without the middleware.

---

## Git Commits This Phase

```
47e4abe - auto-claude: subtask-2-1 - Investigate backend authorization middleware
```

---

## Next Action

**Assignee**: Backend Developer or Claude Code Agent
**Task**: Implement subtask 2-2 (Fix authorization middleware)
**Estimated Duration**: ~1 hour
**Critical**: Yes - blocks all other phases

---

## Notes for Implementer

1. **Strapi Documentation**: The users-permissions middleware must be added BEFORE other middlewares in the stack
2. **Permission Bootstrap**: Look at how mcp-tool permissions are enabled in index.ts and apply the same pattern for flow permissions
3. **Testing**: After implementation, verify with:
   ```bash
   curl -H 'Authorization: Bearer <token>' http://localhost:3001/api/flows
   ```
4. **Frontend Impact**: No frontend changes needed; the issue is entirely backend configuration
5. **Rollback**: If issues occur, the changes are minimal (2 files) and easily reversible

---

## Progress Summary

| Phase | Status | Subtasks | Effort |
|-------|--------|----------|--------|
| 1 - Router Config | âœ… Complete | 1/1 | 0.25h |
| 2 - Backend Auth | ðŸŸ¡ In Progress | 1/3 | ~2.5h |
| 3 - Missing Endpoint | ðŸ”µ Pending | 1/1 | 1.5h |
| 4 - Stats Endpoint | ðŸ”µ Pending | 2/2 | 2h |
| 5 - Frontend Errors | ðŸ”µ Pending | 3/3 | 2h |
| 6 - Polling | ðŸ”µ Pending | 1/1 | 1.5h |
| 7 - Integration | ðŸ”µ Pending | 4/4 | 1h |

**Total Progress**: 1/14 complete (7%)
**Estimated Remaining**: ~10 hours
**Current Focus**: Backend Authorization (highest priority)

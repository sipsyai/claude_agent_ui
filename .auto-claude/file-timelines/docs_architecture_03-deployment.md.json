{
  "file_path": "docs/architecture/03-deployment.md",
  "main_branch_history": [],
  "task_views": {
    "003-create-architecture-documentation-with-system-diag": {
      "task_id": "003-create-architecture-documentation-with-system-diag",
      "branch_point": {
        "commit_hash": "34a3f60da53773d90bd6579cb1cfd8417a1dd0b9",
        "content": "",
        "timestamp": "2026-01-02T10:53:08.483278"
      },
      "worktree_state": {
        "content": "# Docker Deployment Architecture\n\n## Introduction\n\nThis document provides a comprehensive view of the Claude Agent UI Docker deployment architecture, including container orchestration, networking, storage, resource management, and operational considerations. The deployment supports both production and development environments with different configurations optimized for each use case.\n\n## Overview\n\nThe system uses Docker Compose to orchestrate a multi-container application with:\n- **4 Services**: PostgreSQL, Strapi CMS, Express Backend, Frontend (Nginx)\n- **2 Networks**: Backend (database tier), Frontend (application tier)\n- **5 Volumes**: 2 persistent data volumes, 3 ephemeral cache volumes\n- **Health Checks**: All services monitored for availability\n- **Resource Limits**: CPU and memory constraints for stability\n\n---\n\n## Production Deployment Architecture\n\n### Container Topology\n\n```mermaid\ngraph TB\n    subgraph \"Docker Host\"\n        subgraph \"Frontend Network (claude-frontend)\"\n            FrontendContainer[\"<b>Frontend Container</b><br/>claude-frontend<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Image: custom/nginx<br/>Ports: 80, 443<br/>CPU: 0.25-1 cores<br/>Memory: 64M-256M\"]\n            ExpressContainer[\"<b>Express Container</b><br/>claude-express<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Image: custom/node:20<br/>Port: 3001<br/>CPU: 0.5-2 cores<br/>Memory: 512M-1G\"]\n            StrapiContainer[\"<b>Strapi Container</b><br/>claude-strapi<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Image: custom/node:20<br/>Port: 1337<br/>CPU: 0.5-2 cores<br/>Memory: 512M-1G\"]\n        end\n\n        subgraph \"Backend Network (claude-backend)\"\n            PostgresContainer[\"<b>PostgreSQL Container</b><br/>claude-postgres<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Image: postgres:16-alpine<br/>Port: 5432 (internal)<br/>CPU: 0.5-2 cores<br/>Memory: 256M-1G\"]\n            StrapiContainer\n            ExpressContainer\n        end\n\n        subgraph \"Named Volumes\"\n            PostgresData[(\"<b>postgres_data</b><br/>PostgreSQL database<br/>CRITICAL - backup required\")]\n            StrapiUploads[(\"<b>strapi_uploads</b><br/>Media library files<br/>High priority backup\")]\n            StrapiCache[(\"<b>strapi_cache</b><br/>Strapi build cache<br/>Ephemeral\")]\n            ExpressCache[(\"<b>express_cache</b><br/>Express app cache<br/>Ephemeral\")]\n            NginxCache[(\"<b>nginx_cache</b><br/>Static asset cache<br/>Ephemeral\")]\n        end\n\n        subgraph \"Bind Mounts\"\n            Logs[\"./logs/<br/>Application logs\"]\n            Config[\"./nginx/nginx.conf<br/>./backend/config/<br/>Configuration files\"]\n            DBBackups[\"./database/backups/<br/>Database backups\"]\n        end\n    end\n\n    subgraph \"External\"\n        Browser[\"Web Browser\"]\n        AnthropicAPI[\"Anthropic API\"]\n        MCPServers[\"MCP Servers\"]\n    end\n\n    %% Container dependencies\n    FrontendContainer -->|depends_on<br/>healthy| ExpressContainer\n    FrontendContainer -->|depends_on<br/>healthy| StrapiContainer\n    ExpressContainer -->|depends_on<br/>healthy| StrapiContainer\n    StrapiContainer -->|depends_on<br/>healthy| PostgresContainer\n\n    %% Volume mounts\n    PostgresContainer -.->|mount| PostgresData\n    PostgresContainer -.->|mount| Logs\n    PostgresContainer -.->|mount| DBBackups\n    StrapiContainer -.->|mount| StrapiUploads\n    StrapiContainer -.->|mount| StrapiCache\n    StrapiContainer -.->|mount| Config\n    StrapiContainer -.->|mount| Logs\n    ExpressContainer -.->|mount| ExpressCache\n    ExpressContainer -.->|mount| Logs\n    FrontendContainer -.->|mount| NginxCache\n    FrontendContainer -.->|mount| Config\n    FrontendContainer -.->|mount| Logs\n\n    %% Network communication\n    Browser -->|HTTP/HTTPS<br/>:80, :443| FrontendContainer\n    FrontendContainer -->|proxy /api/*<br/>:3001| ExpressContainer\n    FrontendContainer -->|proxy /strapi/*<br/>:1337| StrapiContainer\n    ExpressContainer -->|REST API<br/>:1337| StrapiContainer\n    StrapiContainer -->|SQL<br/>:5432| PostgresContainer\n    ExpressContainer -->|HTTPS| AnthropicAPI\n    ExpressContainer -->|JSON-RPC| MCPServers\n\n    %% Styling\n    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef backend fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    classDef data fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    classDef volume fill:#fce4ec,stroke:#880e4f,stroke-width:2px\n    classDef external fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n\n    class FrontendContainer frontend\n    class ExpressContainer,StrapiContainer backend\n    class PostgresContainer data\n    class PostgresData,StrapiUploads,StrapiCache,ExpressCache,NginxCache,Logs,Config,DBBackups volume\n    class Browser,AnthropicAPI,MCPServers external\n```\n\n---\n\n## Network Architecture\n\n### Network Segmentation\n\n```mermaid\ngraph LR\n    subgraph \"Internet\"\n        Client[Client Browser]\n    end\n\n    subgraph \"Docker Network: claude-frontend (bridge)\"\n        Frontend[Frontend<br/>Nginx:80,443]\n        Express[Express<br/>:3001]\n        Strapi[Strapi<br/>:1337]\n    end\n\n    subgraph \"Docker Network: claude-backend (bridge)\"\n        Express2[Express<br/>:3001]\n        Strapi2[Strapi<br/>:1337]\n        Postgres[(PostgreSQL<br/>:5432)]\n    end\n\n    Client -->|HTTP/HTTPS| Frontend\n    Frontend -.->|/api/*| Express\n    Frontend -.->|/strapi/*| Strapi\n    Express2 -->|SQL| Postgres\n    Strapi2 -->|SQL| Postgres\n\n    %% Note: Express and Strapi are in both networks\n    Express -..-|same container| Express2\n    Strapi -..-|same container| Strapi2\n\n    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef backend fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    classDef database fill:#fff3e0,stroke:#e65100,stroke-width:2px\n\n    class Frontend,Client frontend\n    class Express,Express2,Strapi,Strapi2 backend\n    class Postgres database\n```\n\n### Network Details\n\n| Network | Driver | Services | Purpose | Isolation |\n|---------|--------|----------|---------|-----------|\n| **claude-frontend** | bridge | Frontend, Express, Strapi | HTTP/HTTPS routing and API access | Database is NOT accessible |\n| **claude-backend** | bridge | PostgreSQL, Strapi, Express | Database access | NOT exposed to internet |\n\n**Security Benefits:**\n- **Frontend Network**: Allows web traffic to reach application services without database exposure\n- **Backend Network**: Isolates database from direct internet access\n- **Multi-homing**: Express and Strapi bridge both networks to facilitate data flow\n\n---\n\n## Service Specifications\n\n### 1. PostgreSQL Database\n\n```yaml\nService: postgres\nImage: postgres:16-alpine\nContainer Name: claude-postgres\n```\n\n**Port Mappings:**\n- Internal: `5432` (PostgreSQL default)\n- External: `5433:5432` (host-exposed for admin tools)\n\n**Environment Variables:**\n- `POSTGRES_DB`: Database name (default: `claude_agent_ui`)\n- `POSTGRES_USER`: Database user (default: `postgres`)\n- `POSTGRES_PASSWORD`: **Required** - Database password\n- `POSTGRES_INITDB_ARGS`: Encoding and locale settings\n- `PGDATA`: Data directory path\n\n**Volumes:**\n- `postgres_data:/var/lib/postgresql/data` - **Persistent data** (critical)\n- `./database/init:/docker-entrypoint-initdb.d:ro` - Initialization scripts\n- `./database/backups:/backups` - Backup storage\n- `./logs/postgres:/var/log/postgresql` - Log files\n\n**Health Check:**\n```bash\npg_isready -U postgres -d claude_agent_ui\nInterval: 10s | Timeout: 5s | Retries: 5 | Start Period: 10s\n```\n\n**Resource Limits:**\n- CPU: 0.5-2 cores\n- Memory: 256M reserved, 1G limit\n\n**Logging:**\n- Driver: JSON file\n- Max size: 10MB\n- Max files: 3\n- Label: `service=postgres`\n\n**Restart Policy:** `unless-stopped`\n\n---\n\n### 2. Strapi CMS (Data Layer)\n\n```yaml\nService: strapi\nBuild: ./backend (Dockerfile)\nContainer Name: claude-strapi\n```\n\n**Port Mappings:**\n- Internal: `1337` (Strapi default)\n- External: `1337:1337`\n\n**Environment Variables:**\n- `NODE_ENV`: `production`\n- `HOST`: `0.0.0.0`\n- `PORT`: `1337`\n- Database: `DATABASE_CLIENT=postgres`, `DATABASE_HOST=postgres`\n- Secrets: `APP_KEYS`, `API_TOKEN_SALT`, `ADMIN_JWT_SECRET`, etc. (**Required**)\n- `STRAPI_CORS_ORIGIN`: CORS allowed origins\n- `MAX_FILE_SIZE`: Upload size limit (default: 50MB)\n\n**Volumes:**\n- `strapi_uploads:/opt/app/public/uploads` - **Uploaded files** (high priority backup)\n- `strapi_cache:/opt/app/.cache` - Build cache (ephemeral)\n- `./backend/config:/opt/app/config:ro` - Configuration (read-only)\n- `./logs/strapi:/opt/app/logs` - Log files\n\n**Health Check:**\n```bash\nwget --no-verbose --tries=1 --spider http://localhost:1337/_health\nInterval: 30s | Timeout: 10s | Retries: 3 | Start Period: 60s\n```\n\n**Dependencies:**\n- Requires: `postgres` (healthy)\n\n**Resource Limits:**\n- CPU: 0.5-2 cores\n- Memory: 512M reserved, 1G limit\n\n**Networks:**\n- `backend` (database access)\n- `frontend` (API access)\n\n---\n\n### 3. Express Backend (Business Logic)\n\n```yaml\nService: express\nBuild: . (Dockerfile.express)\nContainer Name: claude-express\n```\n\n**Port Mappings:**\n- Internal: `3001`\n- External: `3001:3001`\n\n**Environment Variables:**\n- `NODE_ENV`: `production`\n- `PORT`: `3001`\n- `STRAPI_URL`: `http://strapi:1337`\n- `STRAPI_API_TOKEN`: **Required** - Strapi authentication\n- `ANTHROPIC_API_KEY`: **Required** - Claude API key\n- `LOG_LEVEL`: Logging verbosity (default: `info`)\n- `MAX_WORKERS`: Worker processes (default: 4)\n- `REQUEST_TIMEOUT`: Request timeout in ms (default: 300000)\n\n**Volumes:**\n- `express_cache:/app/.cache` - Application cache (ephemeral)\n- `./logs/express:/app/logs` - Log files\n\n**Health Check:**\n```bash\nwget --no-verbose --tries=1 --spider http://localhost:3001/health\nInterval: 30s | Timeout: 10s | Retries: 3 | Start Period: 30s\n```\n\n**Dependencies:**\n- Requires: `strapi` (healthy)\n\n**Resource Limits:**\n- CPU: 0.5-2 cores\n- Memory: 512M reserved, 1G limit\n\n**Networks:**\n- `backend` (database access via Strapi)\n- `frontend` (API access from Nginx)\n\n---\n\n### 4. Frontend (React + Nginx)\n\n```yaml\nService: frontend\nBuild: . (Dockerfile.frontend)\nContainer Name: claude-frontend\n```\n\n**Port Mappings:**\n- HTTP: `80:80`\n- HTTPS: `443:443`\n\n**Build Arguments:**\n- `VITE_STRAPI_URL`: Strapi API endpoint\n- `VITE_EXPRESS_URL`: Express API endpoint\n\n**Volumes:**\n- `./nginx/nginx.conf:/etc/nginx/nginx.conf:ro` - Nginx config (read-only)\n- `./nginx/conf.d:/etc/nginx/conf.d:ro` - Additional config (read-only)\n- `nginx_cache:/var/cache/nginx` - Asset cache (ephemeral)\n- `./logs/nginx:/var/log/nginx` - Access/error logs\n- `./ssl:/etc/nginx/ssl:ro` - SSL certificates (read-only)\n\n**Health Check:**\n```bash\nwget --no-verbose --tries=1 --spider http://localhost:80/health\nInterval: 30s | Timeout: 10s | Retries: 3 | Start Period: 10s\n```\n\n**Dependencies:**\n- Requires: `strapi` (healthy)\n- Requires: `express` (healthy)\n\n**Resource Limits:**\n- CPU: 0.25-1 cores\n- Memory: 64M reserved, 256M limit\n\n**Network:**\n- `frontend` (proxy to backend services)\n\n---\n\n## Volume Management\n\n### Volume Types and Backup Strategy\n\n```mermaid\ngraph TD\n    subgraph \"Critical Data - Daily Backups\"\n        PG[postgres_data<br/>Database tables, indexes<br/>Size: Variable, 100MB-10GB]\n    end\n\n    subgraph \"High Priority - Weekly Backups\"\n        Uploads[strapi_uploads<br/>User-uploaded media<br/>Size: Variable, 1MB-50GB]\n    end\n\n    subgraph \"Ephemeral - No Backup Needed\"\n        SC[strapi_cache<br/>Build artifacts<br/>Size: ~100MB]\n        EC[express_cache<br/>LRU cache<br/>Size: ~50MB]\n        NC[nginx_cache<br/>Static assets<br/>Size: ~100MB]\n    end\n\n    classDef critical fill:#ffcdd2,stroke:#c62828,stroke-width:3px\n    classDef priority fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    classDef ephemeral fill:#e0e0e0,stroke:#616161,stroke-width:1px\n\n    class PG critical\n    class Uploads priority\n    class SC,EC,NC ephemeral\n```\n\n### Volume Specifications\n\n| Volume Name | Type | Mount Point | Backup Priority | Description |\n|-------------|------|-------------|-----------------|-------------|\n| **postgres_data** | Named | `/var/lib/postgresql/data` | **Critical** | PostgreSQL database files, indexes, WAL logs |\n| **strapi_uploads** | Named | `/opt/app/public/uploads` | **High** | User-uploaded media and files |\n| **strapi_cache** | Named | `/opt/app/.cache` | None | Strapi build cache, regenerated on build |\n| **express_cache** | Named | `/app/.cache` | None | LRU cache for API responses |\n| **nginx_cache** | Named | `/var/cache/nginx` | None | Proxy cache for static assets |\n\n### Backup Procedures\n\n**Automated Backup (Production):**\n```bash\n# PostgreSQL backup (daily at 2 AM)\ndocker exec claude-postgres pg_dump -U postgres claude_agent_ui \\\n  | gzip > ./database/backups/backup-$(date +%Y%m%d).sql.gz\n\n# Strapi uploads backup (weekly)\ndocker run --rm -v claude-strapi-uploads:/data -v $(pwd)/backups:/backup \\\n  alpine tar czf /backup/strapi-uploads-$(date +%Y%m%d).tar.gz /data\n```\n\n**Restore Procedures:**\n```bash\n# Restore PostgreSQL\ngunzip < ./database/backups/backup-20260102.sql.gz | \\\n  docker exec -i claude-postgres psql -U postgres claude_agent_ui\n\n# Restore Strapi uploads\ndocker run --rm -v claude-strapi-uploads:/data -v $(pwd)/backups:/backup \\\n  alpine tar xzf /backup/strapi-uploads-20260102.tar.gz -C /\n```\n\n---\n\n## Development vs Production Configurations\n\n### Configuration Comparison\n\n| Aspect | Production (`docker-compose.yml`) | Development (`docker-compose.dev.yml`) |\n|--------|----------------------------------|---------------------------------------|\n| **Build Target** | `production` | `development` |\n| **Node Environment** | `NODE_ENV=production` | `NODE_ENV=development` |\n| **Hot Reload** | \u274c No | \u2705 Yes (volume mounts) |\n| **Debugger** | \u274c Disabled | \u2705 Ports 9229 (Strapi), 9230 (Express) |\n| **Logging** | `info` level, JSON format | `debug` level, human-readable |\n| **Optimization** | \u2705 Minified, tree-shaken | \u274c Source maps, unminified |\n| **Port Exposure** | Minimal (80, 443, 3001, 1337) | All ports exposed including debug |\n| **Volume Mounts** | Named volumes + logs only | Source code bind mounts |\n| **Resource Limits** | \u2705 Enforced | \u26a0\ufe0f Relaxed |\n| **Restart Policy** | `unless-stopped` | `unless-stopped` |\n\n### Development Configuration Details\n\n```mermaid\ngraph TB\n    subgraph \"Development Environment\"\n        subgraph \"Hot Reload Enabled\"\n            DevFrontend[\"Frontend Container<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Vite Dev Server :5173<br/>HMR :24678<br/>Volume: ./frontend \u2192 /app\"]\n            DevExpress[\"Express Container<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Nodemon :3001<br/>Debugger :9230<br/>Volume: ./src \u2192 /app/src\"]\n            DevStrapi[\"Strapi Container<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Strapi Dev :1337<br/>Debugger :9229<br/>Volume: ./backend \u2192 /opt/app\"]\n        end\n\n        DevPostgres[\"PostgreSQL Container<br/>\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500<br/>Port: 5432<br/>Volume: ./database/dev-data\"]\n    end\n\n    Dev[Developer Workstation<br/>VSCode, IDE]\n\n    Dev -->|Edit files| DevFrontend\n    Dev -->|Edit files| DevExpress\n    Dev -->|Edit files| DevStrapi\n    Dev -->|Attach debugger| DevExpress\n    Dev -->|Attach debugger| DevStrapi\n    Dev -->|DB admin tools| DevPostgres\n\n    DevFrontend -.->|Auto-reload| DevExpress\n    DevExpress -.->|Auto-reload| DevStrapi\n    DevStrapi -.->|Migrates schema| DevPostgres\n\n    classDef dev fill:#c8e6c9,stroke:#388e3c,stroke-width:2px\n    class DevFrontend,DevExpress,DevStrapi,DevPostgres,Dev dev\n```\n\n**Development Override (`docker-compose.dev.yml`):**\n\n```yaml\n# PostgreSQL - Direct port exposure\npostgres:\n  ports:\n    - \"5432:5432\"  # No port mapping needed\n  volumes:\n    - ./database/dev-data:/var/lib/postgresql/data  # Local directory\n\n# Strapi - Development mode with debugger\nstrapi:\n  build:\n    target: development\n  environment:\n    NODE_ENV: development\n    STRAPI_LOG_LEVEL: debug\n  volumes:\n    - ./backend:/opt/app:delegated  # Source code hot reload\n    - /opt/app/node_modules         # Prevent overwrite\n  ports:\n    - \"9229:9229\"  # Node.js debugger\n  command: npm run develop\n\n# Express - Development mode with nodemon\nexpress:\n  build:\n    target: development\n  environment:\n    NODE_ENV: development\n    LOG_LEVEL: debug\n  volumes:\n    - ./src:/app/src:delegated\n    - /app/node_modules\n  ports:\n    - \"9230:9230\"  # Node.js debugger\n  command: npm run dev\n\n# Frontend - Vite dev server\nfrontend:\n  build:\n    target: development\n  volumes:\n    - .:/app:delegated\n    - /app/node_modules\n  ports:\n    - \"5173:5173\"   # Vite dev server\n    - \"24678:24678\" # HMR (Hot Module Replacement)\n  command: npm run dev -- --host 0.0.0.0\n  environment:\n    VITE_STRAPI_URL: http://localhost:1337/api\n    VITE_EXPRESS_URL: http://localhost:3001/api\n```\n\n**Starting Development Environment:**\n```bash\n# Use both compose files\ndocker-compose -f docker-compose.yml -f docker-compose.dev.yml up\n\n# Rebuild with changes\ndocker-compose -f docker-compose.yml -f docker-compose.dev.yml up --build\n```\n\n---\n\n## Health Checks and Monitoring\n\n### Health Check Configuration\n\nAll services implement health checks to ensure:\n- **Automated recovery**: Unhealthy containers automatically restart\n- **Dependency management**: Services wait for dependencies to be healthy\n- **Load balancer integration**: Health status can be used for routing decisions\n\n```mermaid\nsequenceDiagram\n    participant Docker as Docker Engine\n    participant Container as Service Container\n    participant HealthScript as Health Check Script\n\n    Docker->>Container: Start container\n    activate Container\n    Note over Container: Start Period (10-60s)<br/>No health checks run\n\n    Docker->>HealthScript: Run health check (interval)\n    HealthScript->>Container: Probe endpoint\n    Container-->>HealthScript: Response\n    HealthScript-->>Docker: Exit code 0 (healthy)\n\n    loop Every interval (10-30s)\n        Docker->>HealthScript: Run health check\n        HealthScript->>Container: Probe endpoint\n        alt Service Healthy\n            Container-->>HealthScript: 200 OK\n            HealthScript-->>Docker: Exit 0\n            Note over Docker: Status: healthy\n        else Service Unhealthy\n            Container-->>HealthScript: Timeout/Error\n            HealthScript-->>Docker: Exit 1\n            Docker->>Docker: Increment failure count\n            alt Failures >= Retries\n                Docker->>Container: Restart container\n                Note over Docker: Status: unhealthy \u2192 restarting\n            end\n        end\n    end\n```\n\n### Health Check Summary\n\n| Service | Endpoint | Interval | Timeout | Retries | Start Period |\n|---------|----------|----------|---------|---------|--------------|\n| PostgreSQL | `pg_isready` | 10s | 5s | 5 | 10s |\n| Strapi | `GET /_health` | 30s | 10s | 3 | 60s |\n| Express | `GET /health` | 30s | 10s | 3 | 30s |\n| Frontend | `GET /health` | 30s | 10s | 3 | 10s |\n\n### Monitoring Commands\n\n```bash\n# Check health status of all services\ndocker-compose ps\n\n# View detailed health status\ndocker inspect --format='{{json .State.Health}}' claude-postgres | jq\n\n# Monitor logs for health check failures\ndocker-compose logs -f --tail=100 | grep -i health\n\n# Restart unhealthy service\ndocker-compose restart <service>\n```\n\n---\n\n## Resource Management\n\n### Resource Allocation Strategy\n\n```mermaid\ngraph TD\n    subgraph \"Total Host Resources\"\n        CPU[CPU Cores Available<br/>Example: 8 cores]\n        Memory[Memory Available<br/>Example: 16GB]\n    end\n\n    subgraph \"Container Limits (Production)\"\n        PG_CPU[Postgres: 0.5-2 CPU]\n        PG_MEM[Postgres: 256M-1G]\n\n        ST_CPU[Strapi: 0.5-2 CPU]\n        ST_MEM[Strapi: 512M-1G]\n\n        EX_CPU[Express: 0.5-2 CPU]\n        EX_MEM[Express: 512M-1G]\n\n        FE_CPU[Frontend: 0.25-1 CPU]\n        FE_MEM[Frontend: 64M-256M]\n    end\n\n    CPU --> PG_CPU\n    CPU --> ST_CPU\n    CPU --> EX_CPU\n    CPU --> FE_CPU\n\n    Memory --> PG_MEM\n    Memory --> ST_MEM\n    Memory --> EX_MEM\n    Memory --> FE_MEM\n\n    classDef resource fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    classDef limit fill:#fff3e0,stroke:#f57c00,stroke-width:2px\n\n    class CPU,Memory resource\n    class PG_CPU,PG_MEM,ST_CPU,ST_MEM,EX_CPU,EX_MEM,FE_CPU,FE_MEM limit\n```\n\n### Resource Limits Table\n\n| Service | CPU Reservation | CPU Limit | Memory Reservation | Memory Limit | Rationale |\n|---------|-----------------|-----------|-------------------|--------------|-----------|\n| **PostgreSQL** | 0.5 cores | 2 cores | 256M | 1G | Database operations are CPU-intensive during queries |\n| **Strapi** | 0.5 cores | 2 cores | 512M | 1G | CMS requires memory for ORM, content processing |\n| **Express** | 0.5 cores | 2 cores | 512M | 1G | Real-time SSE streaming, Claude SDK operations |\n| **Frontend** | 0.25 cores | 1 core | 64M | 256M | Static file serving, minimal processing |\n\n**Total Reservations:** 1.75 CPU cores, 1.34GB RAM\n**Total Limits:** 7 CPU cores, 3.25GB RAM\n\n### Resource Tuning Guidelines\n\n**Low-resource environments (4 cores, 8GB RAM):**\n```yaml\n# Reduce limits for all services\npostgres:\n  deploy:\n    resources:\n      limits:\n        cpus: '1'\n        memory: 512M\n      reservations:\n        cpus: '0.25'\n        memory: 128M\n\nstrapi:\n  deploy:\n    resources:\n      limits:\n        cpus: '1'\n        memory: 512M\n      reservations:\n        cpus: '0.25'\n        memory: 256M\n\nexpress:\n  deploy:\n    resources:\n      limits:\n        cpus: '1'\n        memory: 512M\n      reservations:\n        cpus: '0.25'\n        memory: 256M\n```\n\n**High-traffic environments (16+ cores, 32GB+ RAM):**\n```yaml\n# Increase limits and reservations\npostgres:\n  deploy:\n    resources:\n      limits:\n        cpus: '4'\n        memory: 4G\n      reservations:\n        cpus: '1'\n        memory: 1G\n\nstrapi:\n  deploy:\n    resources:\n      limits:\n        cpus: '4'\n        memory: 2G\n      reservations:\n        cpus: '1'\n        memory: 1G\n\nexpress:\n  deploy:\n    resources:\n      limits:\n        cpus: '4'\n        memory: 2G\n      reservations:\n        cpus: '1'\n        memory: 1G\n```\n\n---\n\n## Port Mapping and Exposure\n\n### Port Allocation\n\n```mermaid\ngraph LR\n    subgraph \"Host Machine\"\n        Port80[\":80<br/>HTTP\"]\n        Port443[\":443<br/>HTTPS\"]\n        Port1337[\":1337<br/>Strapi Admin\"]\n        Port3001[\":3001<br/>Express API\"]\n        Port5433[\":5433<br/>PostgreSQL\"]\n    end\n\n    subgraph \"Docker Network\"\n        Frontend[Frontend:80]\n        FrontendHTTPS[Frontend:443]\n        Strapi[Strapi:1337]\n        Express[Express:3001]\n        Postgres[PostgreSQL:5432]\n    end\n\n    Port80 --> Frontend\n    Port443 --> FrontendHTTPS\n    Port1337 --> Strapi\n    Port3001 --> Express\n    Port5433 --> Postgres\n\n    classDef host fill:#ffebee,stroke:#c62828,stroke-width:2px\n    classDef container fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px\n\n    class Port80,Port443,Port1337,Port3001,Port5433 host\n    class Frontend,FrontendHTTPS,Strapi,Express,Postgres container\n```\n\n### Port Table\n\n| Service | Internal Port | External Port | Protocol | Public? | Notes |\n|---------|--------------|---------------|----------|---------|-------|\n| Frontend | 80 | 80 | HTTP | \u2705 Yes | Main web interface |\n| Frontend | 443 | 443 | HTTPS | \u2705 Yes | SSL/TLS (production) |\n| Express | 3001 | 3001 | HTTP | \u26a0\ufe0f Optional | API endpoint (can proxy via Nginx) |\n| Strapi | 1337 | 1337 | HTTP | \u26a0\ufe0f Optional | Admin panel (restrict in production) |\n| PostgreSQL | 5432 | 5433 | PostgreSQL | \u274c No | Database (for admin tools only) |\n\n**Security Recommendations:**\n\n1. **Production Firewall Rules:**\n   ```bash\n   # Allow only HTTP/HTTPS\n   ufw allow 80/tcp\n   ufw allow 443/tcp\n\n   # Block direct API access (proxy through Nginx)\n   ufw deny 3001/tcp\n   ufw deny 1337/tcp\n\n   # Restrict database to specific IPs\n   ufw allow from <admin-ip> to any port 5433\n   ```\n\n2. **Nginx Reverse Proxy Configuration:**\n   ```nginx\n   # Proxy Express API\n   location /api/ {\n       proxy_pass http://express:3001/;\n   }\n\n   # Proxy Strapi (admin only from specific IPs)\n   location /strapi/ {\n       allow <admin-ip>;\n       deny all;\n       proxy_pass http://strapi:1337/;\n   }\n   ```\n\n---\n\n## Operational Procedures\n\n### Starting the System\n\n```bash\n# Production\ndocker-compose up -d\n\n# Development\ndocker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d\n\n# Rebuild and start\ndocker-compose up -d --build\n\n# View startup logs\ndocker-compose logs -f\n```\n\n### Stopping the System\n\n```bash\n# Stop all services (containers remain)\ndocker-compose stop\n\n# Stop and remove containers\ndocker-compose down\n\n# Stop, remove containers, and remove volumes (DATA LOSS!)\ndocker-compose down -v\n```\n\n### Scaling Services\n\n```bash\n# Scale Express to 3 instances (requires load balancer)\ndocker-compose up -d --scale express=3\n\n# Note: Scaling frontend/strapi requires additional configuration\n```\n\n### Viewing Logs\n\n```bash\n# All services\ndocker-compose logs -f\n\n# Specific service\ndocker-compose logs -f express\n\n# Tail last 100 lines\ndocker-compose logs --tail=100 strapi\n\n# Follow logs with timestamps\ndocker-compose logs -f -t\n```\n\n### Database Operations\n\n```bash\n# Access PostgreSQL CLI\ndocker exec -it claude-postgres psql -U postgres -d claude_agent_ui\n\n# Backup database\ndocker exec claude-postgres pg_dump -U postgres claude_agent_ui > backup.sql\n\n# Restore database\ncat backup.sql | docker exec -i claude-postgres psql -U postgres claude_agent_ui\n\n# View database size\ndocker exec claude-postgres psql -U postgres -d claude_agent_ui \\\n  -c \"SELECT pg_size_pretty(pg_database_size('claude_agent_ui'));\"\n```\n\n### Troubleshooting\n\n**Container won't start:**\n```bash\n# Check container status\ndocker-compose ps\n\n# View container logs\ndocker-compose logs <service>\n\n# Inspect container\ndocker inspect claude-<service>\n\n# Check health status\ndocker inspect --format='{{json .State.Health}}' claude-<service> | jq\n```\n\n**Out of memory:**\n```bash\n# Check resource usage\ndocker stats\n\n# View memory limits\ndocker inspect --format='{{.HostConfig.Memory}}' claude-<service>\n\n# Increase memory limit in docker-compose.yml\n```\n\n**Network connectivity issues:**\n```bash\n# List networks\ndocker network ls\n\n# Inspect network\ndocker network inspect claude-frontend\n\n# Test connectivity between containers\ndocker exec claude-express ping -c 3 claude-postgres\n\n# Test service availability\ndocker exec claude-express wget -O- http://strapi:1337/_health\n```\n\n**Volume issues:**\n```bash\n# List volumes\ndocker volume ls\n\n# Inspect volume\ndocker volume inspect claude-postgres-data\n\n# Locate volume on host\ndocker volume inspect claude-postgres-data --format='{{.Mountpoint}}'\n\n# Backup volume\ndocker run --rm -v claude-postgres-data:/data -v $(pwd):/backup \\\n  alpine tar czf /backup/postgres-data.tar.gz /data\n```\n\n---\n\n## Security Considerations\n\n### Container Security\n\n1. **Run as non-root user** (where possible):\n   ```dockerfile\n   USER node  # For Node.js services\n   USER postgres  # PostgreSQL already uses postgres user\n   ```\n\n2. **Read-only filesystem mounts**:\n   ```yaml\n   volumes:\n     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro  # Read-only\n     - ./backend/config:/opt/app/config:ro\n   ```\n\n3. **Secret management**:\n   ```bash\n   # Use .env file (DO NOT commit to git)\n   POSTGRES_PASSWORD=<strong-password>\n   STRAPI_APP_KEYS=<random-keys>\n   ANTHROPIC_API_KEY=<api-key>\n\n   # Or use Docker secrets (Swarm mode)\n   docker secret create postgres_password ./secrets/postgres_password.txt\n   ```\n\n4. **Network isolation**:\n   - PostgreSQL only accessible from backend network\n   - No direct internet access to database\n\n### Environment Variable Security\n\n```bash\n# .env file (NEVER commit to git)\n# Add to .gitignore\n\n# Required secrets\nPOSTGRES_PASSWORD=<generate-strong-password>\nSTRAPI_APP_KEYS=<generate-random-keys>\nSTRAPI_API_TOKEN_SALT=<generate-random-salt>\nSTRAPI_ADMIN_JWT_SECRET=<generate-random-secret>\nSTRAPI_TRANSFER_TOKEN_SALT=<generate-random-salt>\nSTRAPI_JWT_SECRET=<generate-random-secret>\nSTRAPI_API_TOKEN=<generate-api-token>\nANTHROPIC_API_KEY=<anthropic-api-key>\n\n# Generate random secrets:\nopenssl rand -base64 32\n```\n\n### SSL/TLS Configuration\n\n```nginx\n# nginx/conf.d/ssl.conf\nserver {\n    listen 443 ssl http2;\n    server_name example.com;\n\n    ssl_certificate /etc/nginx/ssl/fullchain.pem;\n    ssl_certificate_key /etc/nginx/ssl/privkey.pem;\n\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers HIGH:!aNULL:!MD5;\n    ssl_prefer_server_ciphers on;\n\n    # Security headers\n    add_header Strict-Transport-Security \"max-age=31536000\" always;\n    add_header X-Frame-Options \"SAMEORIGIN\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n\n    # Proxy configuration\n    location / {\n        proxy_pass http://frontend;\n    }\n}\n```\n\n---\n\n## Performance Optimization\n\n### Nginx Caching\n\n```nginx\n# nginx/nginx.conf\nhttp {\n    proxy_cache_path /var/cache/nginx levels=1:2\n                     keys_zone=api_cache:10m\n                     max_size=1g\n                     inactive=60m;\n\n    server {\n        location /api/ {\n            proxy_cache api_cache;\n            proxy_cache_valid 200 5m;\n            proxy_cache_use_stale error timeout http_500 http_502 http_503;\n            add_header X-Cache-Status $upstream_cache_status;\n\n            proxy_pass http://express:3001;\n        }\n    }\n}\n```\n\n### Database Connection Pooling\n\nStrapi configuration (`backend/config/database.js`):\n```javascript\nmodule.exports = {\n  connection: {\n    client: 'postgres',\n    connection: {\n      // Connection pool settings\n      pool: {\n        min: 2,\n        max: 10,\n        acquireTimeoutMillis: 30000,\n        idleTimeoutMillis: 30000,\n        createTimeoutMillis: 30000,\n        reapIntervalMillis: 1000,\n      },\n    },\n  },\n};\n```\n\n### Express Caching\n\nLRU cache configuration (already implemented):\n```javascript\n// src/services/strapi-client.ts\nconst cache = new LRUCache({\n  max: 500,          // Max 500 entries\n  ttl: 1000 * 60 * 5 // 5 minute TTL\n});\n```\n\n---\n\n## Disaster Recovery\n\n### Backup Strategy\n\n```mermaid\ngraph TD\n    subgraph \"Backup Schedule\"\n        Daily[Daily Backups<br/>PostgreSQL database<br/>Retention: 7 days]\n        Weekly[Weekly Backups<br/>Strapi uploads<br/>Retention: 4 weeks]\n        Monthly[Monthly Backups<br/>Full system<br/>Retention: 12 months]\n    end\n\n    subgraph \"Backup Storage\"\n        Local[Local Storage<br/>./database/backups/]\n        S3[Cloud Storage<br/>AWS S3 / Backblaze B2]\n        Offsite[Offsite Storage<br/>Different datacenter]\n    end\n\n    Daily --> Local\n    Daily --> S3\n    Weekly --> Local\n    Weekly --> S3\n    Monthly --> Local\n    Monthly --> S3\n    Monthly --> Offsite\n\n    classDef schedule fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef storage fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n\n    class Daily,Weekly,Monthly schedule\n    class Local,S3,Offsite storage\n```\n\n### Automated Backup Script\n\n```bash\n#!/bin/bash\n# backup.sh - Automated backup script\n\nDATE=$(date +%Y%m%d-%H%M%S)\nBACKUP_DIR=\"./database/backups\"\n\n# PostgreSQL backup\necho \"Backing up PostgreSQL database...\"\ndocker exec claude-postgres pg_dump -U postgres claude_agent_ui \\\n  | gzip > \"$BACKUP_DIR/postgres-$DATE.sql.gz\"\n\n# Strapi uploads backup\necho \"Backing up Strapi uploads...\"\ndocker run --rm \\\n  -v claude-strapi-uploads:/data \\\n  -v $(pwd)/backups:/backup \\\n  alpine tar czf \"/backup/strapi-uploads-$DATE.tar.gz\" /data\n\n# Cleanup old backups (keep last 7 days)\nfind \"$BACKUP_DIR\" -name \"postgres-*.sql.gz\" -mtime +7 -delete\nfind \"$BACKUP_DIR\" -name \"strapi-uploads-*.tar.gz\" -mtime +30 -delete\n\necho \"Backup completed: $DATE\"\n```\n\n### Recovery Procedures\n\n**Full System Recovery:**\n```bash\n# 1. Stop all services\ndocker-compose down\n\n# 2. Restore PostgreSQL\ngunzip < ./database/backups/postgres-20260102.sql.gz | \\\n  docker exec -i claude-postgres psql -U postgres claude_agent_ui\n\n# 3. Restore Strapi uploads\ndocker run --rm \\\n  -v claude-strapi-uploads:/data \\\n  -v $(pwd)/backups:/backup \\\n  alpine tar xzf /backup/strapi-uploads-20260102.tar.gz -C /\n\n# 4. Restart services\ndocker-compose up -d\n\n# 5. Verify health\ndocker-compose ps\n```\n\n---\n\n## Next Steps\n\nFor more detailed documentation on specific architecture aspects, see:\n\n- [System Overview](./01-system-overview.md) - High-level architecture and component overview\n- [Data Flow Diagrams](./02-data-flow.md) - Agent execution, MCP tools, and chat flows\n- [Component Details](./04-components.md) - Service layer architecture and frontend components\n- [Sequence Diagrams](./05-sequences.md) - Step-by-step interaction flows\n- [Technology Stack](./06-tech-stack.md) - Detailed technology choices and rationale\n\n---\n\n## Summary\n\nThe Claude Agent UI uses a well-architected Docker Compose deployment with:\n\n\u2705 **Multi-container orchestration** - 4 services working together\n\u2705 **Network isolation** - Frontend and backend networks for security\n\u2705 **Persistent storage** - Named volumes with backup strategies\n\u2705 **Health monitoring** - Automated health checks and recovery\n\u2705 **Resource management** - CPU and memory limits for stability\n\u2705 **Development support** - Hot reload and debugging capabilities\n\u2705 **Production-ready** - Security hardening and performance optimization\n\nThis architecture supports both development and production environments with appropriate configurations for each use case.\n",
        "last_modified": "2026-01-02T11:16:07.578112"
      },
      "task_intent": {
        "title": "003-create-architecture-documentation-with-system-diag",
        "description": "Create comprehensive visual documentation showing how the hybrid architecture components (React + Express + Strapi + PostgreSQL + Claude SDK + MCP) interact, including data flow, service communication, and deployment topology.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T10:53:08.898228",
  "last_updated": "2026-01-02T10:53:08.922218"
}
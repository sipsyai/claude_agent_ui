# ============================================================
# PostgreSQL Configuration File - Claude Agent UI
# ============================================================
# Task 02: PostgreSQL Schema & Configuration
# Version: PostgreSQL 16+
# Optimized for: 8GB RAM, 4 CPU cores, SSD storage
#
# IMPORTANT: Adjust values based on your server resources
# Formula references are provided for customization
# ============================================================

# ------------------------------------------------------------
# CONNECTION SETTINGS
# ------------------------------------------------------------

# Maximum number of concurrent connections
# Formula: (RAM in GB) * 10-20 connections
# Example: 8GB RAM = 80-160 connections
max_connections = 100

# Reserved connections for superuser (for maintenance)
superuser_reserved_connections = 3

# Listen on all interfaces (for Docker/remote access)
# Use 'localhost' for local-only access
listen_addresses = '*'

# Port
port = 5432

# Unix socket directory (for local connections)
# unix_socket_directories = '/var/run/postgresql'

# ------------------------------------------------------------
# MEMORY SETTINGS
# ------------------------------------------------------------

# Shared buffers: 25% of RAM (up to 8GB)
# Example: 8GB RAM = 2GB shared_buffers
# Default: 128MB (too low for production)
shared_buffers = 2GB

# Effective cache size: 50-75% of RAM
# Tells query planner how much memory is available for caching
# Does not allocate memory, just informs planner
# Example: 8GB RAM = 6GB effective_cache_size
effective_cache_size = 6GB

# Work memory: Per-operation memory (sort, hash joins, etc.)
# Formula: (RAM - shared_buffers) / (max_connections * 2-3)
# Example: (8GB - 2GB) / (100 * 3) = 20MB
# Careful: Setting too high can cause OOM if many concurrent queries
work_mem = 20MB

# Maintenance work memory: For VACUUM, CREATE INDEX, ALTER TABLE
# Formula: RAM / 16 (up to 2GB)
# Example: 8GB / 16 = 512MB
maintenance_work_mem = 512MB

# Temporary buffers: Per session, for temp tables
# Default: 8MB (usually sufficient)
temp_buffers = 16MB

# ------------------------------------------------------------
# WAL (Write-Ahead Log) SETTINGS
# ------------------------------------------------------------

# WAL level: minimal, replica, or logical
# - minimal: No replication (development only)
# - replica: Enables streaming replication (recommended)
# - logical: Enables logical replication (advanced use cases)
wal_level = replica

# Maximum WAL senders (for replication)
# Set to number of standby servers + 2 for safety
max_wal_senders = 10

# WAL receiver timeout
wal_receiver_timeout = 60s

# WAL keep size (for replication lag tolerance)
# Keep enough WAL for replica to catch up after disconnect
wal_keep_size = 1GB

# Checkpoint settings (prevent I/O spikes)
# Checkpoints write dirty buffers to disk
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
max_wal_size = 2GB
min_wal_size = 1GB

# WAL compression (reduce disk I/O and storage)
wal_compression = on

# ------------------------------------------------------------
# QUERY TUNING
# ------------------------------------------------------------

# Enable parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 8

# Parallel maintenance operations (CREATE INDEX, VACUUM)
max_parallel_maintenance_workers = 2

# Random page cost (lower for SSD, higher for HDD)
# Default: 4.0 (for HDD)
# SSD: 1.0-1.5
random_page_cost = 1.1

# Sequential page cost (baseline)
seq_page_cost = 1.0

# Effective I/O concurrency (for SSD)
# Number of concurrent I/O operations
# Default: 1 (for HDD)
# SSD: 200-300
effective_io_concurrency = 200

# Cost-based vacuum delay (prevent I/O spikes during autovacuum)
vacuum_cost_delay = 2ms
vacuum_cost_limit = 200

# ------------------------------------------------------------
# LOGGING
# ------------------------------------------------------------

# Where to log
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Log rotation
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = off

# When to log
log_min_messages = warning
log_min_error_statement = error

# Log slow queries (for optimization)
# Log queries taking longer than 1 second
log_min_duration_statement = 1000

# Log connections/disconnections (for debugging)
log_connections = on
log_disconnections = on

# Log duration of each completed statement
log_duration = off

# Log line prefix (timestamp, user, database, PID)
log_line_prefix = '%t [%p] %u@%d '

# Log statement types
# - none: Don't log statements
# - ddl: Log DDL (CREATE, ALTER, DROP)
# - mod: Log DDL + DML (INSERT, UPDATE, DELETE)
# - all: Log all statements
log_statement = 'ddl'

# Log lock waits (for diagnosing deadlocks)
log_lock_waits = on
deadlock_timeout = 1s

# Log autovacuum activity
log_autovacuum_min_duration = 0

# Log temporary files (for query optimization)
log_temp_files = 10MB

# Log checkpoints (for monitoring)
log_checkpoints = on

# ------------------------------------------------------------
# AUTOVACUUM (Maintenance)
# ------------------------------------------------------------

# Enable autovacuum (should ALWAYS be on)
autovacuum = on

# Autovacuum max workers
# More workers = faster cleanup, more CPU usage
autovacuum_max_workers = 3

# Autovacuum naptime (time between runs)
# Check tables for vacuuming every 1 minute
autovacuum_naptime = 1min

# Vacuum thresholds (when to trigger autovacuum)
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1

# Autovacuum freeze settings (prevent transaction ID wraparound)
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000

# ------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# ------------------------------------------------------------

# Statement timeout (prevent long-running queries)
# Kill queries running longer than 30 seconds
# Set to 0 to disable (not recommended for production)
statement_timeout = 30000  # 30 seconds

# Lock timeout (prevent long lock waits)
# Release locks after 10 seconds to prevent deadlocks
lock_timeout = 10000  # 10 seconds

# Idle in transaction timeout (prevent idle connections)
# Kill connections idle in transaction for 60 seconds
# Prevents resource leaks from abandoned transactions
idle_in_transaction_session_timeout = 60000  # 60 seconds

# TCP keepalives (detect dead connections)
tcp_keepalives_idle = 60
tcp_keepalives_interval = 10
tcp_keepalives_count = 6

# Default transaction isolation level
# - read uncommitted (PostgreSQL treats as read committed)
# - read committed (default, recommended)
# - repeatable read
# - serializable
default_transaction_isolation = 'read committed'

# Timezone
timezone = 'UTC'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# ------------------------------------------------------------
# STATISTICS
# ------------------------------------------------------------

# Track activity (for monitoring)
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Statistics target (higher = better estimates, slower ANALYZE)
# Default: 100
# Range: 10-10000
default_statistics_target = 100

# Histogram size for statistics
# Default: 100
# Increase for better query planning on large tables
# default_statistics_target = 100

# ------------------------------------------------------------
# QUERY PLANNING
# ------------------------------------------------------------

# Enable genetic query optimizer (for complex queries)
geqo = on
geqo_threshold = 12

# Join collapse limit (higher = more optimization, slower planning)
join_collapse_limit = 8

# From collapse limit
from_collapse_limit = 8

# ------------------------------------------------------------
# ERROR HANDLING
# ------------------------------------------------------------

# Exit on error (during script execution)
# Set to off for production (on for development)
# \set ON_ERROR_STOP off

# Restart after crash (should be on)
restart_after_crash = on

# ------------------------------------------------------------
# BACKGROUND WRITER
# ------------------------------------------------------------

# Background writer parameters (tune for SSD)
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# ------------------------------------------------------------
# ASYNCHRONOUS BEHAVIOR
# ------------------------------------------------------------

# Asynchronous commit (faster writes, small risk of data loss)
# - off: Wait for WAL write (safest, slowest)
# - local: Wait for local WAL write (default, balanced)
# - remote_write: Wait for replica WAL write
# - on: Don't wait (fastest, slight data loss risk)
synchronous_commit = local

# Commit delay (group commits for better performance)
# Delay commit to batch multiple transactions
commit_delay = 0
commit_siblings = 5

# ------------------------------------------------------------
# REPLICATION (Optional - for production HA)
# ------------------------------------------------------------

# Hot standby (allow read queries on replicas)
hot_standby = on
hot_standby_feedback = on
max_standby_streaming_delay = 30s

# Synchronous replication (optional, for zero data loss)
# synchronous_standby_names = 'standby1,standby2'

# Archive mode (for point-in-time recovery)
# archive_mode = on
# archive_command = 'cp %p /mnt/backup/wal_archive/%f'

# ------------------------------------------------------------
# SSL/TLS (Optional - recommended for production)
# ------------------------------------------------------------

# Enable SSL
# ssl = on
# ssl_cert_file = '/etc/postgresql/ssl/server.crt'
# ssl_key_file = '/etc/postgresql/ssl/server.key'
# ssl_ca_file = '/etc/postgresql/ssl/ca.crt'
# ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
# ssl_prefer_server_ciphers = on
# ssl_min_protocol_version = 'TLSv1.2'

# ------------------------------------------------------------
# SHARED PRELOAD LIBRARIES
# ------------------------------------------------------------

# Load extensions at startup
# shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration (query performance tracking)
# pg_stat_statements.max = 10000
# pg_stat_statements.track = all
# pg_stat_statements.track_utility = on

# ============================================================
# END OF CONFIGURATION
# ============================================================
#
# NOTES:
# 1. Restart PostgreSQL after changing this file
# 2. Verify config: SHOW ALL; or SELECT * FROM pg_settings;
# 3. Check for errors: tail -f /var/log/postgresql/postgresql-*.log
# 4. Reload without restart: SELECT pg_reload_conf();
#
# TUNING GUIDES:
# - pgtune.leopard.in.ua (automatic config generator)
# - PGTune (postgresqlco.nf/tuning-guide)
# - Official docs: www.postgresql.org/docs/current/runtime-config.html
#
# ============================================================

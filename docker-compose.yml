# ============================================================
# Claude Agent UI - Production Docker Compose
# Complete Stack: PostgreSQL + Strapi + Express + Frontend
# ============================================================

services:

  # ----------------------------------------------------------
  # PostgreSQL Database
  # ----------------------------------------------------------
  postgres:
    image: postgres:16-alpine
    container_name: claude-postgres
    restart: unless-stopped

    # Environment variables
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-claude_agent_ui}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata

    # Port mapping (only expose internally in production)
    ports:
      - "${POSTGRES_PORT:-5433}:5432"

    # Volume mounts
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./database/backups:/backups
      - ./logs/postgres:/var/log/postgresql

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-claude_agent_ui}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=postgres"

    # Networks
    networks:
      - backend

  # ----------------------------------------------------------
  # Strapi CMS (Data Layer)
  # ----------------------------------------------------------
  strapi:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
      args:
        NODE_VERSION: 20
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}

    container_name: claude-strapi
    restart: unless-stopped

    # Environment variables
    environment:
      # Node environment
      NODE_ENV: ${NODE_ENV:-production}
      HOST: 0.0.0.0
      PORT: 1337

      # Database configuration
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${POSTGRES_DB:-claude_agent_ui}
      DATABASE_USERNAME: ${POSTGRES_USER:-postgres}
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_SSL: ${DATABASE_SSL:-false}

      # Strapi secrets (MUST be set in .env)
      APP_KEYS: ${STRAPI_APP_KEYS:?STRAPI_APP_KEYS is required}
      API_TOKEN_SALT: ${STRAPI_API_TOKEN_SALT:?STRAPI_API_TOKEN_SALT is required}
      ADMIN_JWT_SECRET: ${STRAPI_ADMIN_JWT_SECRET:?STRAPI_ADMIN_JWT_SECRET is required}
      TRANSFER_TOKEN_SALT: ${STRAPI_TRANSFER_TOKEN_SALT:?STRAPI_TRANSFER_TOKEN_SALT is required}
      JWT_SECRET: ${STRAPI_JWT_SECRET:?STRAPI_JWT_SECRET is required}

      # CORS configuration
      STRAPI_CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173,http://localhost:3001}

      # Admin configuration
      ADMIN_PATH: ${STRAPI_ADMIN_PATH:-/admin}

      # File upload
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-52428800}

    # Port mapping
    ports:
      - "${STRAPI_PORT:-1337}:1337"

    # Volume mounts
    volumes:
      - strapi_uploads:/opt/app/public/uploads
      - strapi_cache:/opt/app/.cache
      - ./backend/config:/opt/app/config:ro
      - ./logs/strapi:/opt/app/logs

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:1337/_health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Dependencies
    depends_on:
      postgres:
        condition: service_healthy

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=strapi"

    # Networks
    networks:
      - backend
      - frontend

  # ----------------------------------------------------------
  # Express Backend (Business Logic & SSE)
  # ----------------------------------------------------------
  express:
    build:
      context: .
      dockerfile: Dockerfile.express
      target: production
      args:
        NODE_VERSION: 20
        BUILD_DATE: ${BUILD_DATE}
        VCS_REF: ${VCS_REF}

    container_name: claude-express
    restart: unless-stopped

    # Environment variables
    environment:
      # Node environment
      NODE_ENV: ${NODE_ENV:-production}
      HOST: 0.0.0.0
      PORT: 3001

      # Strapi connection
      STRAPI_URL: http://strapi:1337
      STRAPI_API_TOKEN: ${STRAPI_API_TOKEN:?STRAPI_API_TOKEN is required}

      # Anthropic API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}

      # Performance
      MAX_WORKERS: ${MAX_WORKERS:-4}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-300000}

      # CORS
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}

    # Port mapping
    ports:
      - "${EXPRESS_PORT:-3001}:3001"

    # Volume mounts
    volumes:
      - ./logs/express:/app/logs
      - express_cache:/app/.cache

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Dependencies
    depends_on:
      strapi:
        condition: service_healthy

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=express"

    # Networks
    networks:
      - backend
      - frontend

  # ----------------------------------------------------------
  # Frontend (React + Nginx)
  # ----------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: production
      args:
        NODE_VERSION: 20
        VITE_STRAPI_URL: ${VITE_STRAPI_URL:-http://localhost:1337/api}
        VITE_EXPRESS_URL: ${VITE_EXPRESS_URL:-http://localhost:3001/api}

    container_name: claude-frontend
    restart: unless-stopped

    # Port mapping
    ports:
      - "${FRONTEND_HTTP_PORT:-80}:80"
      - "${FRONTEND_HTTPS_PORT:-443}:443"

    # Volume mounts
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - nginx_cache:/var/cache/nginx
      - ./logs/nginx:/var/log/nginx
      - ./ssl:/etc/nginx/ssl:ro

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Dependencies
    depends_on:
      strapi:
        condition: service_healthy
      express:
        condition: service_healthy

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 64M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=frontend"

    # Networks
    networks:
      - frontend

# ============================================================
# VOLUMES DEFINITION
# ============================================================

volumes:
  # PostgreSQL data (Critical - Must be backed up)
  postgres_data:
    driver: local
    name: claude-postgres-data

  # Strapi uploads (High priority backup)
  strapi_uploads:
    driver: local
    name: claude-strapi-uploads

  # Strapi cache (Ephemeral)
  strapi_cache:
    driver: local
    name: claude-strapi-cache

  # Express cache (Ephemeral)
  express_cache:
    driver: local
    name: claude-express-cache

  # Nginx cache (Ephemeral)
  nginx_cache:
    driver: local
    name: claude-nginx-cache

# ============================================================
# NETWORKS DEFINITION
# ============================================================

networks:
  # Backend network (PostgreSQL, Strapi, Express)
  backend:
    driver: bridge
    name: claude-backend

  # Frontend network (Frontend, Strapi, Express)
  frontend:
    driver: bridge
    name: claude-frontend

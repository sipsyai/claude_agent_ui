{
  "file_path": "src/web/manager/components/AgentExecutionModal.tsx",
  "main_branch_history": [],
  "task_views": {
    "004-document-frontend-react-components-and-hooks": {
      "task_id": "004-document-frontend-react-components-and-hooks",
      "branch_point": {
        "commit_hash": "34a3f60da53773d90bd6579cb1cfd8417a1dd0b9",
        "content": "import React, { useState, useRef, useEffect } from 'react';\nimport type { Agent } from '../services/api';\nimport * as api from '../services/api';\nimport { Button } from './ui/Button';\nimport { Input } from './ui/Input';\nimport { XCircleIcon, PlayCircleIcon } from './ui/Icons';\nimport DynamicField from './DynamicField';\n\ninterface AgentExecutionModalProps {\n  agent: Agent;\n  isOpen: boolean;\n  onClose: () => void;\n  directory?: string;\n}\n\ninterface Message {\n  id: string;\n  type: 'status' | 'assistant' | 'user' | 'result' | 'error' | 'debug' | 'tool_use';\n  content: string;\n  timestamp: Date;\n  toolName?: string;\n  toolInput?: any;\n  toolResult?: any; // Added to tool_use messages when result arrives\n  toolUseId?: string;\n}\n\nconst AgentExecutionModal: React.FC<AgentExecutionModalProps> = ({\n  agent,\n  isOpen,\n  onClose,\n  directory,\n}) => {\n  const [userPrompt, setUserPrompt] = useState('');\n  const [permissionMode, setPermissionMode] = useState<'default' | 'acceptEdits' | 'bypass' | 'plan'>('bypass');\n  const [inputValues, setInputValues] = useState<Record<string, any>>({});\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [isExecuting, setIsExecuting] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const hasInputFields = false; // TODO: inputFields not yet in Strapi schema\n\n  useEffect(() => {\n    // Scroll to bottom when new messages arrive\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  const handleExecute = async () => {\n    // Build prompt from input values if fields exist\n    let finalPrompt = userPrompt;\n\n    // TODO: inputFields feature not yet in Strapi schema\n    /* if (hasInputFields) {\n      // Check required fields\n      const requiredFields = agent.metadata!.inputFields!.filter((f: any) => f.required);\n      const missingFields = requiredFields.filter((f: any) => !inputValues[f.name]);\n\n      if (missingFields.length > 0) {\n        alert(`Please fill in required fields: ${missingFields.map((f: any) => f.label).join(', ')}`);\n        return;\n      }\n\n      // Build structured prompt from input values\n      const inputParts = agent.metadata!.inputFields!.map((field: any) => {\n        const value = inputValues[field.name];\n        if (value !== undefined && value !== '') {\n          return `${field.label}: ${value}`;\n        }\n        return null;\n      }).filter(Boolean);\n\n      finalPrompt = inputParts.join('\\n');\n    } */\n\n    if (!finalPrompt.trim() || isExecuting) return;\n\n    setIsExecuting(true);\n    setMessages([]);\n\n    try {\n      await api.executeAgent(\n        agent.id,\n        finalPrompt,\n        directory,\n        permissionMode,\n        (event) => {\n          // Handle assistant messages (contains tool_use blocks)\n          if (event.type === 'message' && event.messageType === 'assistant') {\n            const message = event.content?.message;\n            if (message?.content && Array.isArray(message.content)) {\n              const blocks = message.content;\n\n              // Process text blocks for assistant message\n              const textContent = blocks\n                .filter((block: any) => block.type === 'text')\n                .map((block: any) => block.text)\n                .join('\\n');\n\n              if (textContent) {\n                setMessages((prev) => [...prev, {\n                  id: `${Date.now()}-${Math.random()}`,\n                  type: 'assistant',\n                  content: textContent,\n                  timestamp: new Date(),\n                }]);\n              }\n\n              // Process tool_use blocks separately\n              const toolUseBlocks = blocks.filter((block: any) => block.type === 'tool_use');\n              toolUseBlocks.forEach((toolBlock: any) => {\n                setMessages((prev) => [...prev, {\n                  id: `tool-use-${toolBlock.id}`,\n                  type: 'tool_use',\n                  content: '',\n                  timestamp: new Date(),\n                  toolName: toolBlock.name,\n                  toolInput: toolBlock.input,\n                  toolUseId: toolBlock.id,\n                }]);\n              });\n            }\n            return;\n          }\n\n          // Handle user messages (contains tool_result blocks)\n          if (event.type === 'message' && event.messageType === 'user') {\n            const message = event.content?.message;\n            if (message?.content && Array.isArray(message.content)) {\n              const blocks = message.content;\n\n              // Process tool_result blocks\n              const toolResultBlocks = blocks.filter((block: any) => block.type === 'tool_result');\n              toolResultBlocks.forEach((resultBlock: any) => {\n                const toolUseId = resultBlock.tool_use_id;\n                const toolResult = resultBlock.content;\n\n                // Find and update the corresponding tool_use message\n                setMessages((prev) => prev.map(msg =>\n                  msg.toolUseId === toolUseId\n                    ? { ...msg, toolResult }\n                    : msg\n                ));\n              });\n            }\n            return;\n          }\n\n          // Handle other event types\n          const newMessage: Message = {\n            id: `${Date.now()}-${Math.random()}`,\n            type: event.type as any,\n            content: '',\n            timestamp: new Date(),\n          };\n\n          if (event.type === 'status') {\n            newMessage.content = event.message || event.status || '';\n          } else if (event.type === 'debug') {\n            newMessage.content = event.message || '';\n          } else if (event.type === 'message' && event.messageType === 'system') {\n            newMessage.type = 'status';\n            newMessage.content = JSON.stringify(event.content, null, 2);\n          } else if (event.type === 'complete') {\n            newMessage.type = 'status';\n            newMessage.content = '\u2705 Agent execution completed';\n          } else if (event.type === 'error') {\n            newMessage.content = event.error || 'Unknown error';\n          } else {\n            // Fallback for unknown types\n            newMessage.content = JSON.stringify(event, null, 2);\n          }\n\n          setMessages((prev) => [...prev, newMessage]);\n        }\n      );\n    } catch (error) {\n      setMessages((prev) => [\n        ...prev,\n        {\n          id: `${Date.now()}-error`,\n          type: 'error',\n          content: error instanceof Error ? error.message : 'Failed to execute agent',\n          timestamp: new Date(),\n        },\n      ]);\n    } finally {\n      setIsExecuting(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\n      <div className=\"bg-background border border-border rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-4 border-b border-border\">\n          <div>\n            <h2 className=\"text-xl font-bold\">Execute Agent: {agent.name}</h2>\n            <p className=\"text-sm text-muted-foreground\">{agent.description}</p>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-muted-foreground hover:text-foreground\"\n          >\n            <XCircleIcon className=\"h-6 w-6\" />\n          </button>\n        </div>\n\n        {/* Prompt Input */}\n        <div className=\"p-4 border-b border-border\">\n          {/* Permission Mode Selector */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium mb-2\">\n              Permission Mode:\n            </label>\n            <div className=\"flex gap-4 flex-wrap\">\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"bypass\"\n                  checked={permissionMode === 'bypass'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Bypass (Auto-approve all) \u26a1</span>\n              </label>\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"acceptEdits\"\n                  checked={permissionMode === 'acceptEdits'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Accept Edits (Auto file changes)</span>\n              </label>\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"plan\"\n                  checked={permissionMode === 'plan'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Plan (Strategy only)</span>\n              </label>\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"default\"\n                  checked={permissionMode === 'default'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Default (Ask each)</span>\n              </label>\n            </div>\n          </div>\n\n          {/* TODO: inputFields feature not yet in Strapi schema */}\n          {hasInputFields ? (\n            <>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Dynamic input fields coming soon...\n              </p>\n              <Button\n                onClick={handleExecute}\n                disabled={isExecuting}\n                className=\"flex items-center gap-2 w-full mt-2\"\n              >\n                <PlayCircleIcon className=\"h-5 w-5\" />\n                {isExecuting ? 'Running...' : 'Execute'}\n              </Button>\n            </>\n          ) : (\n            <>\n              <label className=\"block text-sm font-medium mb-2\">\n                Enter your prompt for the agent:\n              </label>\n              <div className=\"flex gap-2\">\n                <Input\n                  type=\"text\"\n                  value={userPrompt}\n                  onChange={(e) => setUserPrompt(e.target.value)}\n                  placeholder=\"What should the agent do?\"\n                  disabled={isExecuting}\n                  className=\"flex-1\"\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !isExecuting) {\n                      handleExecute();\n                    }\n                  }}\n                />\n                <Button\n                  onClick={handleExecute}\n                  disabled={!userPrompt.trim() || isExecuting}\n                  className=\"flex items-center gap-2\"\n                >\n                  <PlayCircleIcon className=\"h-5 w-5\" />\n                  {isExecuting ? 'Running...' : 'Execute'}\n                </Button>\n              </div>\n            </>\n          )}\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n          {messages.length === 0 && !isExecuting && (\n            <div className=\"text-center text-muted-foreground py-12\">\n              Enter a prompt and click Execute to run the agent\n            </div>\n          )}\n\n          {messages.map((message) => (\n            <div\n              key={message.id}\n              className={`p-3 rounded-lg ${\n                message.type === 'error'\n                  ? 'bg-red-500/10 border border-red-500/20'\n                  : message.type === 'debug'\n                  ? 'bg-yellow-500/10 border border-yellow-500/20'\n                  : message.type === 'status'\n                  ? 'bg-blue-500/10 border border-blue-500/20'\n                  : message.type === 'tool_use'\n                  ? 'bg-purple-500/10 border border-purple-500/20'\n                  : message.type === 'assistant'\n                  ? 'bg-primary/10 border border-primary/20'\n                  : 'bg-secondary'\n              }`}\n            >\n              <div className=\"flex items-start justify-between mb-1\">\n                <span className=\"text-xs font-semibold uppercase tracking-wide\">\n                  {message.type === 'tool_use'\n                    ? `\ud83d\udd27 ${message.toolName}`\n                    : message.type}\n                </span>\n                <span className=\"text-xs text-muted-foreground\">\n                  {message.timestamp.toLocaleTimeString()}\n                </span>\n              </div>\n\n              {message.type === 'tool_use' ? (\n                <div className=\"text-sm space-y-2\">\n                  <div className=\"font-medium text-purple-400\">Tool: {message.toolName}</div>\n\n                  {/* Input Parameters */}\n                  {message.toolInput && (\n                    <details className=\"cursor-pointer\">\n                      <summary className=\"text-xs text-muted-foreground hover:text-foreground\">\n                        \ud83d\udce5 Input Parameters\n                      </summary>\n                      <pre className=\"mt-2 text-xs bg-black/20 p-2 rounded overflow-x-auto\">\n                        {JSON.stringify(message.toolInput, null, 2)}\n                      </pre>\n                    </details>\n                  )}\n\n                  {/* Output Result - only show if available */}\n                  {message.toolResult && (\n                    <details\n                      className=\"cursor-pointer\"\n                      open={typeof message.toolResult === 'string' && message.toolResult.length < 200}\n                    >\n                      <summary className=\"text-xs text-muted-foreground hover:text-foreground\">\n                        \ud83d\udce4 Output Result\n                      </summary>\n                      <div className=\"mt-2 text-xs bg-black/20 p-2 rounded overflow-x-auto\">\n                        {typeof message.toolResult === 'string' ? (\n                          <pre className=\"whitespace-pre-wrap\">{message.toolResult}</pre>\n                        ) : (\n                          <pre>{JSON.stringify(message.toolResult, null, 2)}</pre>\n                        )}\n                      </div>\n                    </details>\n                  )}\n\n                  {/* Show loading state if no result yet */}\n                  {!message.toolResult && (\n                    <div className=\"text-xs text-muted-foreground italic\">\n                      Waiting for result...\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className=\"text-sm whitespace-pre-wrap break-words\">\n                  {message.content}\n                </div>\n              )}\n            </div>\n          ))}\n\n          {isExecuting && messages.length === 0 && (\n            <div className=\"text-center text-muted-foreground py-6\">\n              <div className=\"animate-pulse\">Starting agent execution...</div>\n            </div>\n          )}\n\n          <div ref={messagesEndRef} />\n        </div>\n\n        {/* Footer */}\n        <div className=\"p-4 border-t border-border flex justify-end gap-2\">\n          <Button variant=\"secondary\" onClick={onClose}>\n            Close\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default AgentExecutionModal;\n",
        "timestamp": "2026-01-02T14:22:14.293924"
      },
      "worktree_state": {
        "content": "/**\n * @file AgentExecutionModal.tsx\n * @description Modal component for executing agents with real-time SSE streaming, permission mode selection,\n * and comprehensive message handling including tool use visualization.\n *\n * ## Features\n * - Interactive agent execution with user prompts\n * - Real-time SSE event streaming with message updates\n * - Four permission modes (bypass, acceptEdits, plan, default)\n * - Tool use tracking with input parameters and results\n * - Auto-scrolling message list\n * - Loading and execution states\n * - Error handling with user-friendly messages\n *\n * ## Agent Execution Flow\n * The component follows this execution lifecycle:\n * 1. User enters a prompt and selects permission mode\n * 2. Click Execute button triggers `handleExecute`\n * 3. SSE stream initiated via `api.executeAgent` with event callback\n * 4. Events processed in real-time and messages updated incrementally\n * 5. Tool use blocks tracked separately with unique IDs\n * 6. Tool results matched back to tool use messages via `toolUseId`\n * 7. Execution completes with success or error message\n * 8. User can close modal or execute again\n *\n * ## Permission Modes\n * The component supports four permission modes that control agent behavior:\n *\n * - **bypass**: Auto-approve all permissions (fastest execution, least control)\n *   - Agent can execute all tools without asking\n *   - Best for trusted environments or non-destructive operations\n *   - Icon: \u26a1\n *\n * - **acceptEdits**: Auto-approve file edit operations only\n *   - Agent can modify files without permission prompts\n *   - Other tools still require approval\n *   - Best for code generation/refactoring tasks\n *\n * - **plan**: Strategy/planning mode only (no execution)\n *   - Agent provides a plan without actually executing tools\n *   - Best for reviewing approach before committing to changes\n *\n * - **default**: Ask for permission on each tool use (safest, slowest)\n *   - Agent prompts user for approval before each tool execution\n *   - Best for cautious execution or learning agent behavior\n *\n * ## Message Handling\n * The component processes multiple message types from SSE events:\n *\n * ### Assistant Messages\n * - Content blocks parsed from `message.content` array\n * - Text blocks displayed as assistant messages\n * - Tool use blocks create separate tool_use messages\n * - Each tool use tracked with unique ID for result matching\n *\n * ### User Messages\n * - Tool result blocks parsed from `message.content` array\n * - Results matched back to tool use messages via `toolUseId`\n * - Updates existing tool_use message with `toolResult` property\n *\n * ### Status Messages\n * - General status updates from agent execution\n * - System messages converted to status type\n * - Completion messages with success indicator\n *\n * ### Error Messages\n * - Error events displayed with red styling\n * - Catches both streaming errors and execution failures\n *\n * ### Debug Messages\n * - Debug information with yellow styling\n * - Useful for troubleshooting agent behavior\n *\n * ### Tool Use Messages\n * - Special message type for tool executions\n * - Displays tool name, input parameters, and results\n * - Collapsible sections for input/output\n * - Auto-expand short results (<200 chars)\n * - Loading state while waiting for results\n *\n * ## UI States\n *\n * ### Empty State\n * - Shown when no messages and not executing\n * - Prompts user to enter prompt and click Execute\n *\n * ### Loading State\n * - Shown when `isExecuting === true` and no messages yet\n * - Animated pulse with \"Starting agent execution...\" message\n *\n * ### Executing State\n * - Execute button disabled and shows \"Running...\" text\n * - Input field disabled to prevent changes during execution\n * - Messages appear in real-time as events arrive\n *\n * ### Completed State\n * - Execute button re-enabled\n * - Messages remain visible\n * - User can execute again or close modal\n *\n * ## Styling Behavior\n * - Modal overlay with dark semi-transparent backdrop (bg-black/50)\n * - Centered modal dialog with max width 4xl and max height 90vh\n * - Three-section layout: header, messages (scrollable), footer\n * - Message styling varies by type:\n *   - Error: red background/border (bg-red-500/10, border-red-500/20)\n *   - Debug: yellow background/border (bg-yellow-500/10, border-yellow-500/20)\n *   - Status: blue background/border (bg-blue-500/10, border-blue-500/20)\n *   - Tool use: purple background/border (bg-purple-500/10, border-purple-500/20)\n *   - Assistant: primary background/border (bg-primary/10, border-primary/20)\n *   - Default: secondary background (bg-secondary)\n * - Auto-scroll to bottom on new messages with smooth behavior\n * - Permission mode selector with radio buttons\n * - Tool use sections with collapsible details elements\n *\n * @example\n * ```tsx\n * // Basic usage with agent execution\n * const [isOpen, setIsOpen] = useState(false);\n * const [selectedAgent, setSelectedAgent] = useState<Agent | null>(null);\n *\n * <AgentExecutionModal\n *   agent={selectedAgent}\n *   isOpen={isOpen}\n *   onClose={() => setIsOpen(false)}\n * />\n * ```\n *\n * @example\n * ```tsx\n * // With custom directory for execution\n * <AgentExecutionModal\n *   agent={agent}\n *   isOpen={isOpen}\n *   onClose={() => {\n *     setIsOpen(false);\n *     // Optionally refresh agent list or navigate\n *   }}\n *   directory=\"/custom/workspace\"\n * />\n * ```\n *\n * @example\n * ```tsx\n * // Execute agent from list with permission mode state\n * const handleExecuteAgent = (agent: Agent) => {\n *   setSelectedAgent(agent);\n *   setModalOpen(true);\n * };\n *\n * <Button onClick={() => handleExecuteAgent(agent)}>\n *   Execute Agent\n * </Button>\n *\n * <AgentExecutionModal\n *   agent={selectedAgent}\n *   isOpen={modalOpen}\n *   onClose={() => {\n *     setModalOpen(false);\n *     setSelectedAgent(null);\n *   }}\n *   directory={currentDirectory}\n * />\n * ```\n *\n * @example\n * ```tsx\n * // Understanding tool use message flow\n * // When agent executes a tool, you'll see:\n * // 1. Tool use message appears with name and input\n * // 2. \"Waiting for result...\" shown below\n * // 3. Result arrives and updates the same message\n * // 4. Result is collapsible with auto-expand for short content\n *\n * // Tool use message structure:\n * {\n *   id: \"tool-use-abc123\",\n *   type: \"tool_use\",\n *   toolName: \"Read\",\n *   toolInput: { file_path: \"src/example.ts\" },\n *   toolResult: \"file contents here...\",\n *   toolUseId: \"abc123\"\n * }\n * ```\n */\n\nimport React, { useState, useRef, useEffect } from 'react';\nimport type { Agent } from '../services/api';\nimport * as api from '../services/api';\nimport { Button } from './ui/Button';\nimport { Input } from './ui/Input';\nimport { XCircleIcon, PlayCircleIcon } from './ui/Icons';\nimport DynamicField from './DynamicField';\n\n/**\n * Props for the AgentExecutionModal component.\n *\n * @interface AgentExecutionModalProps\n * @property {Agent} agent - The agent to execute with name, description, and configuration\n * @property {boolean} isOpen - Controls modal visibility (true = shown, false = hidden)\n * @property {() => void} onClose - Callback invoked when user closes the modal (X button or Close button)\n * @property {string} [directory] - Optional working directory for agent execution (defaults to current directory from cookies)\n */\ninterface AgentExecutionModalProps {\n  agent: Agent;\n  isOpen: boolean;\n  onClose: () => void;\n  directory?: string;\n}\n\n/**\n * Internal message structure for agent execution events.\n *\n * Messages are created from SSE events and displayed in the message list.\n * Different message types have different visual styling and content rendering.\n *\n * @interface Message\n * @property {string} id - Unique message identifier (timestamp-based or tool-use-{id})\n * @property {'status' | 'assistant' | 'user' | 'result' | 'error' | 'debug' | 'tool_use'} type - Message type affecting styling and rendering\n * @property {string} content - Text content for display (empty for tool_use messages)\n * @property {Date} timestamp - Message creation time for display\n * @property {string} [toolName] - Tool name for tool_use messages (e.g., \"Read\", \"Write\", \"Bash\")\n * @property {any} [toolInput] - Tool input parameters for tool_use messages (JSON object)\n * @property {any} [toolResult] - Tool execution result (added when result arrives, can be string or object)\n * @property {string} [toolUseId] - Tool use unique ID for matching results back to tool use messages\n */\ninterface Message {\n  id: string;\n  type: 'status' | 'assistant' | 'user' | 'result' | 'error' | 'debug' | 'tool_use';\n  content: string;\n  timestamp: Date;\n  toolName?: string;\n  toolInput?: any;\n  toolResult?: any; // Added to tool_use messages when result arrives\n  toolUseId?: string;\n}\n\nconst AgentExecutionModal: React.FC<AgentExecutionModalProps> = ({\n  agent,\n  isOpen,\n  onClose,\n  directory,\n}) => {\n  const [userPrompt, setUserPrompt] = useState('');\n  const [permissionMode, setPermissionMode] = useState<'default' | 'acceptEdits' | 'bypass' | 'plan'>('bypass');\n  const [inputValues, setInputValues] = useState<Record<string, any>>({});\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [isExecuting, setIsExecuting] = useState(false);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n\n  const hasInputFields = false; // TODO: inputFields not yet in Strapi schema\n\n  useEffect(() => {\n    // Scroll to bottom when new messages arrive\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  /**\n   * Executes the agent with the user's prompt and selected permission mode.\n   *\n   * This function orchestrates the entire agent execution workflow:\n   * 1. Validates prompt is not empty and not already executing\n   * 2. Resets state (isExecuting=true, messages=[])\n   * 3. Calls api.executeAgent with SSE event callback\n   * 4. Processes real-time events as they arrive:\n   *    - Assistant messages with text and tool use blocks\n   *    - User messages with tool result blocks\n   *    - Status, error, debug events\n   * 5. Updates messages state incrementally\n   * 6. Handles completion or error\n   * 7. Resets isExecuting state\n   *\n   * ## Event Processing\n   *\n   * ### Assistant Messages (messageType === 'assistant')\n   * - Content blocks parsed from message.content array\n   * - Text blocks concatenated and added as assistant message\n   * - Tool use blocks added as separate tool_use messages with unique IDs\n   *\n   * ### User Messages (messageType === 'user')\n   * - Tool result blocks parsed from message.content array\n   * - Results matched back to tool_use messages via toolUseId\n   * - Updates existing message with toolResult property\n   *\n   * ### Other Event Types\n   * - status: General status updates\n   * - debug: Debug information\n   * - error: Error messages\n   * - complete: Execution completed successfully\n   *\n   * @internal\n   * @async\n   * @returns {Promise<void>}\n   */\n  const handleExecute = async () => {\n    // Build prompt from input values if fields exist\n    let finalPrompt = userPrompt;\n\n    // TODO: inputFields feature not yet in Strapi schema\n    /* if (hasInputFields) {\n      // Check required fields\n      const requiredFields = agent.metadata!.inputFields!.filter((f: any) => f.required);\n      const missingFields = requiredFields.filter((f: any) => !inputValues[f.name]);\n\n      if (missingFields.length > 0) {\n        alert(`Please fill in required fields: ${missingFields.map((f: any) => f.label).join(', ')}`);\n        return;\n      }\n\n      // Build structured prompt from input values\n      const inputParts = agent.metadata!.inputFields!.map((field: any) => {\n        const value = inputValues[field.name];\n        if (value !== undefined && value !== '') {\n          return `${field.label}: ${value}`;\n        }\n        return null;\n      }).filter(Boolean);\n\n      finalPrompt = inputParts.join('\\n');\n    } */\n\n    if (!finalPrompt.trim() || isExecuting) return;\n\n    setIsExecuting(true);\n    setMessages([]);\n\n    try {\n      await api.executeAgent(\n        agent.id,\n        finalPrompt,\n        directory,\n        permissionMode,\n        (event) => {\n          // Handle assistant messages (contains tool_use blocks)\n          if (event.type === 'message' && event.messageType === 'assistant') {\n            const message = event.content?.message;\n            if (message?.content && Array.isArray(message.content)) {\n              const blocks = message.content;\n\n              // Process text blocks for assistant message\n              const textContent = blocks\n                .filter((block: any) => block.type === 'text')\n                .map((block: any) => block.text)\n                .join('\\n');\n\n              if (textContent) {\n                setMessages((prev) => [...prev, {\n                  id: `${Date.now()}-${Math.random()}`,\n                  type: 'assistant',\n                  content: textContent,\n                  timestamp: new Date(),\n                }]);\n              }\n\n              // Process tool_use blocks separately\n              const toolUseBlocks = blocks.filter((block: any) => block.type === 'tool_use');\n              toolUseBlocks.forEach((toolBlock: any) => {\n                setMessages((prev) => [...prev, {\n                  id: `tool-use-${toolBlock.id}`,\n                  type: 'tool_use',\n                  content: '',\n                  timestamp: new Date(),\n                  toolName: toolBlock.name,\n                  toolInput: toolBlock.input,\n                  toolUseId: toolBlock.id,\n                }]);\n              });\n            }\n            return;\n          }\n\n          // Handle user messages (contains tool_result blocks)\n          if (event.type === 'message' && event.messageType === 'user') {\n            const message = event.content?.message;\n            if (message?.content && Array.isArray(message.content)) {\n              const blocks = message.content;\n\n              // Process tool_result blocks\n              const toolResultBlocks = blocks.filter((block: any) => block.type === 'tool_result');\n              toolResultBlocks.forEach((resultBlock: any) => {\n                const toolUseId = resultBlock.tool_use_id;\n                const toolResult = resultBlock.content;\n\n                // Find and update the corresponding tool_use message\n                setMessages((prev) => prev.map(msg =>\n                  msg.toolUseId === toolUseId\n                    ? { ...msg, toolResult }\n                    : msg\n                ));\n              });\n            }\n            return;\n          }\n\n          // Handle other event types\n          const newMessage: Message = {\n            id: `${Date.now()}-${Math.random()}`,\n            type: event.type as any,\n            content: '',\n            timestamp: new Date(),\n          };\n\n          if (event.type === 'status') {\n            newMessage.content = event.message || event.status || '';\n          } else if (event.type === 'debug') {\n            newMessage.content = event.message || '';\n          } else if (event.type === 'message' && event.messageType === 'system') {\n            newMessage.type = 'status';\n            newMessage.content = JSON.stringify(event.content, null, 2);\n          } else if (event.type === 'complete') {\n            newMessage.type = 'status';\n            newMessage.content = '\u2705 Agent execution completed';\n          } else if (event.type === 'error') {\n            newMessage.content = event.error || 'Unknown error';\n          } else {\n            // Fallback for unknown types\n            newMessage.content = JSON.stringify(event, null, 2);\n          }\n\n          setMessages((prev) => [...prev, newMessage]);\n        }\n      );\n    } catch (error) {\n      setMessages((prev) => [\n        ...prev,\n        {\n          id: `${Date.now()}-error`,\n          type: 'error',\n          content: error instanceof Error ? error.message : 'Failed to execute agent',\n          timestamp: new Date(),\n        },\n      ]);\n    } finally {\n      setIsExecuting(false);\n    }\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\n      <div className=\"bg-background border border-border rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-4 border-b border-border\">\n          <div>\n            <h2 className=\"text-xl font-bold\">Execute Agent: {agent.name}</h2>\n            <p className=\"text-sm text-muted-foreground\">{agent.description}</p>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-muted-foreground hover:text-foreground\"\n          >\n            <XCircleIcon className=\"h-6 w-6\" />\n          </button>\n        </div>\n\n        {/* Prompt Input */}\n        <div className=\"p-4 border-b border-border\">\n          {/* Permission Mode Selector */}\n          <div className=\"mb-4\">\n            <label className=\"block text-sm font-medium mb-2\">\n              Permission Mode:\n            </label>\n            <div className=\"flex gap-4 flex-wrap\">\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"bypass\"\n                  checked={permissionMode === 'bypass'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Bypass (Auto-approve all) \u26a1</span>\n              </label>\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"acceptEdits\"\n                  checked={permissionMode === 'acceptEdits'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Accept Edits (Auto file changes)</span>\n              </label>\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"plan\"\n                  checked={permissionMode === 'plan'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Plan (Strategy only)</span>\n              </label>\n              <label className=\"flex items-center gap-2 cursor-pointer\">\n                <input\n                  type=\"radio\"\n                  value=\"default\"\n                  checked={permissionMode === 'default'}\n                  onChange={(e) => setPermissionMode(e.target.value as any)}\n                  className=\"w-4 h-4\"\n                />\n                <span className=\"text-sm\">Default (Ask each)</span>\n              </label>\n            </div>\n          </div>\n\n          {/* TODO: inputFields feature not yet in Strapi schema */}\n          {hasInputFields ? (\n            <>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                Dynamic input fields coming soon...\n              </p>\n              <Button\n                onClick={handleExecute}\n                disabled={isExecuting}\n                className=\"flex items-center gap-2 w-full mt-2\"\n              >\n                <PlayCircleIcon className=\"h-5 w-5\" />\n                {isExecuting ? 'Running...' : 'Execute'}\n              </Button>\n            </>\n          ) : (\n            <>\n              <label className=\"block text-sm font-medium mb-2\">\n                Enter your prompt for the agent:\n              </label>\n              <div className=\"flex gap-2\">\n                <Input\n                  type=\"text\"\n                  value={userPrompt}\n                  onChange={(e) => setUserPrompt(e.target.value)}\n                  placeholder=\"What should the agent do?\"\n                  disabled={isExecuting}\n                  className=\"flex-1\"\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !isExecuting) {\n                      handleExecute();\n                    }\n                  }}\n                />\n                <Button\n                  onClick={handleExecute}\n                  disabled={!userPrompt.trim() || isExecuting}\n                  className=\"flex items-center gap-2\"\n                >\n                  <PlayCircleIcon className=\"h-5 w-5\" />\n                  {isExecuting ? 'Running...' : 'Execute'}\n                </Button>\n              </div>\n            </>\n          )}\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\n          {messages.length === 0 && !isExecuting && (\n            <div className=\"text-center text-muted-foreground py-12\">\n              Enter a prompt and click Execute to run the agent\n            </div>\n          )}\n\n          {messages.map((message) => (\n            <div\n              key={message.id}\n              className={`p-3 rounded-lg ${\n                message.type === 'error'\n                  ? 'bg-red-500/10 border border-red-500/20'\n                  : message.type === 'debug'\n                  ? 'bg-yellow-500/10 border border-yellow-500/20'\n                  : message.type === 'status'\n                  ? 'bg-blue-500/10 border border-blue-500/20'\n                  : message.type === 'tool_use'\n                  ? 'bg-purple-500/10 border border-purple-500/20'\n                  : message.type === 'assistant'\n                  ? 'bg-primary/10 border border-primary/20'\n                  : 'bg-secondary'\n              }`}\n            >\n              <div className=\"flex items-start justify-between mb-1\">\n                <span className=\"text-xs font-semibold uppercase tracking-wide\">\n                  {message.type === 'tool_use'\n                    ? `\ud83d\udd27 ${message.toolName}`\n                    : message.type}\n                </span>\n                <span className=\"text-xs text-muted-foreground\">\n                  {message.timestamp.toLocaleTimeString()}\n                </span>\n              </div>\n\n              {message.type === 'tool_use' ? (\n                <div className=\"text-sm space-y-2\">\n                  <div className=\"font-medium text-purple-400\">Tool: {message.toolName}</div>\n\n                  {/* Input Parameters */}\n                  {message.toolInput && (\n                    <details className=\"cursor-pointer\">\n                      <summary className=\"text-xs text-muted-foreground hover:text-foreground\">\n                        \ud83d\udce5 Input Parameters\n                      </summary>\n                      <pre className=\"mt-2 text-xs bg-black/20 p-2 rounded overflow-x-auto\">\n                        {JSON.stringify(message.toolInput, null, 2)}\n                      </pre>\n                    </details>\n                  )}\n\n                  {/* Output Result - only show if available */}\n                  {message.toolResult && (\n                    <details\n                      className=\"cursor-pointer\"\n                      open={typeof message.toolResult === 'string' && message.toolResult.length < 200}\n                    >\n                      <summary className=\"text-xs text-muted-foreground hover:text-foreground\">\n                        \ud83d\udce4 Output Result\n                      </summary>\n                      <div className=\"mt-2 text-xs bg-black/20 p-2 rounded overflow-x-auto\">\n                        {typeof message.toolResult === 'string' ? (\n                          <pre className=\"whitespace-pre-wrap\">{message.toolResult}</pre>\n                        ) : (\n                          <pre>{JSON.stringify(message.toolResult, null, 2)}</pre>\n                        )}\n                      </div>\n                    </details>\n                  )}\n\n                  {/* Show loading state if no result yet */}\n                  {!message.toolResult && (\n                    <div className=\"text-xs text-muted-foreground italic\">\n                      Waiting for result...\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className=\"text-sm whitespace-pre-wrap break-words\">\n                  {message.content}\n                </div>\n              )}\n            </div>\n          ))}\n\n          {isExecuting && messages.length === 0 && (\n            <div className=\"text-center text-muted-foreground py-6\">\n              <div className=\"animate-pulse\">Starting agent execution...</div>\n            </div>\n          )}\n\n          <div ref={messagesEndRef} />\n        </div>\n\n        {/* Footer */}\n        <div className=\"p-4 border-t border-border flex justify-end gap-2\">\n          <Button variant=\"secondary\" onClick={onClose}>\n            Close\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nAgentExecutionModal.displayName = 'AgentExecutionModal';\n\nexport default AgentExecutionModal;\n",
        "last_modified": "2026-01-02T14:22:15.548724"
      },
      "task_intent": {
        "title": "Document Frontend React Components and Hooks",
        "description": "Add comprehensive JSDoc documentation to all React components and custom hooks in the frontend, including prop types, usage examples, component purposes, state management, and side effects.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T14:01:10.837806",
  "last_updated": "2026-01-02T14:22:14.544187"
}
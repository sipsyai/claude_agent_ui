{
  "file_path": "src/server.ts",
  "main_branch_history": [],
  "task_views": {
    "007-uygulaman-n-genel-yap-s-n-d-zenleyece-iz-yani-uygu": {
      "task_id": "007-uygulaman-n-genel-yap-s-n-d-zenleyece-iz-yani-uygu",
      "branch_point": {
        "commit_hash": "9355e1f79162ecd7611ae3213457e87085b7fe4d",
        "content": "import express, { Express } from 'express';\nimport * as path from 'path';\nimport { fileURLToPath, pathToFileURL } from 'url';\nimport { dirname } from 'path';\nimport cors from 'cors';\nimport { createLogger, type Logger } from './services/logger.js';\nimport { ConfigService } from './services/config-service.js';\nimport { chatLogService } from './services/chat-log-service.js';\nimport { createManagerRoutes } from './routes/manager.routes.js';\nimport { createStrapiManagerRoutes } from './routes/manager.routes.strapi.js';\nimport { createExecutionRoutes } from './routes/execution.routes.js';\nimport taskRoutes from './routes/task.routes.js';\nimport chatRoutes from './routes/chat.routes.js';\nimport { errorHandler, notFoundHandler } from './middleware/error-handler.js';\nimport { requestLogger } from './middleware/request-logger.js';\n\n// Get the directory of this module for serving static files\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n/**\n * Claude Agent UI Server\n * Minimal Express server for managing Claude agents, skills, and MCP servers\n */\nexport class AgentUIServer {\n  private app: Express;\n  private server?: import('http').Server;\n  private logger: Logger;\n  private port: number;\n  private host: string;\n\n  constructor(config?: { port?: number; host?: string }) {\n    this.app = express();\n    this.logger = createLogger('AgentUIServer');\n\n    // Configuration with defaults\n    this.port = config?.port ?? parseInt(process.env.PORT ?? '3001', 10);\n    this.host = config?.host ?? process.env.HOST ?? '0.0.0.0';\n\n    this.logger.info('Initializing Claude Agent UI Server', {\n      port: this.port,\n      host: this.host,\n      nodeEnv: process.env.NODE_ENV\n    });\n\n    this.setupMiddleware();\n    this.setupRoutes();\n  }\n\n  /**\n   * Get the Express app instance\n   */\n  getApp(): Express {\n    return this.app;\n  }\n\n  /**\n   * Get the configured port\n   */\n  getPort(): number {\n    return this.port;\n  }\n\n  /**\n   * Get the configured host\n   */\n  getHost(): string {\n    return this.host;\n  }\n\n  /**\n   * Start the server\n   */\n  async start(): Promise<void> {\n    this.logger.info('Starting Claude Agent UI Server...');\n\n    // Initialize ConfigService\n    try {\n      const configService = ConfigService.getInstance();\n      await configService.initialize();\n      this.logger.info('ConfigService initialized successfully');\n    } catch (error) {\n      this.logger.warn('Failed to initialize ConfigService', error);\n      // Don't fail server start if config initialization fails\n    }\n\n    // Initialize Chat Log Service\n    try {\n      await chatLogService.init();\n      this.logger.info('ChatLogService initialized successfully');\n    } catch (error) {\n      this.logger.warn('Failed to initialize ChatLogService', error);\n      // Don't fail server start if log service initialization fails\n    }\n\n    return new Promise<void>((resolve, reject) => {\n      this.server = this.app.listen(this.port, this.host, () => {\n        this.logger.info(`\ud83d\ude80 Claude Agent UI Server running at http://${this.host}:${this.port}`);\n        this.logger.info(`\ud83d\udcf1 Manager UI: http://localhost:${this.port}/manager`);\n        resolve();\n      });\n\n      this.server.on('error', (error: Error) => {\n        this.logger.error('Failed to start HTTP server:', {\n          error: error.message,\n          code: (error as any).code,\n          port: this.port,\n          host: this.host\n        });\n        reject(error);\n      });\n    });\n  }\n\n  /**\n   * Stop the server gracefully\n   */\n  async stop(): Promise<void> {\n    this.logger.info('Stopping Claude Agent UI Server...');\n\n    if (this.server) {\n      await new Promise<void>((resolve) => {\n        this.server!.close(() => {\n          this.logger.info('Server stopped successfully');\n          resolve();\n        });\n      });\n    }\n  }\n\n  private setupMiddleware(): void {\n    // CORS configuration\n    this.app.use(cors({\n      origin: process.env.NODE_ENV === 'development'\n        ? ['http://localhost:3000', 'http://127.0.0.1:3000', 'http://localhost:3001', 'http://127.0.0.1:3001']\n        : true,\n      credentials: true\n    }));\n\n    // Body parsing\n    this.app.use(express.json({ limit: '10mb' }));\n    this.app.use(express.urlencoded({ extended: true }));\n\n    // Static file serving for production\n    const isDev = process.env.NODE_ENV === 'development';\n    if (!isDev) {\n      const staticPath = path.join(__dirname, 'web');\n      this.logger.info('Serving static files from:', staticPath);\n      this.app.use(express.static(staticPath));\n    }\n\n    // Request logging (use new centralized logger middleware)\n    this.app.use(requestLogger);\n  }\n\n  private setupRoutes(): void {\n    // Health check endpoint - validates Express and Strapi connectivity\n    this.app.get('/health', async (req, res) => {\n      const healthStatus: any = {\n        status: 'healthy',\n        timestamp: new Date().toISOString(),\n        uptime: process.uptime(),\n        services: {\n          express: {\n            status: 'healthy',\n          },\n          strapi: {\n            status: 'unknown',\n            database: {\n              connected: false,\n            },\n          },\n        },\n      };\n\n      try {\n        // Check Strapi connectivity and database health\n        const strapiUrl = process.env.STRAPI_URL || 'http://localhost:1337';\n        const strapiToken = process.env.STRAPI_API_TOKEN;\n\n        const headers: Record<string, string> = {\n          'Content-Type': 'application/json',\n        };\n        if (strapiToken) {\n          headers['Authorization'] = `Bearer ${strapiToken}`;\n        }\n\n        // Query Strapi health endpoint with timeout\n        const controller = new AbortController();\n        const timeout = setTimeout(() => controller.abort(), 5000); // 5 second timeout\n\n        try {\n          const response = await fetch(`${strapiUrl}/_health`, {\n            headers,\n            signal: controller.signal,\n          });\n\n          clearTimeout(timeout);\n\n          if (response.ok) {\n            const strapiHealth = await response.json();\n            healthStatus.services.strapi = {\n              status: strapiHealth.status || 'healthy',\n              database: strapiHealth.database || { connected: false },\n              pool: strapiHealth.pool,\n              responseTime: strapiHealth.responseTime,\n            };\n          } else {\n            healthStatus.services.strapi.status = 'unhealthy';\n            healthStatus.status = 'degraded';\n          }\n        } catch (fetchError) {\n          clearTimeout(timeout);\n          healthStatus.services.strapi.status = 'unreachable';\n          healthStatus.services.strapi.error = fetchError.message;\n          healthStatus.status = 'degraded';\n        }\n\n        // Return appropriate status code\n        const statusCode = healthStatus.status === 'healthy' ? 200 : 503;\n        res.status(statusCode).json(healthStatus);\n      } catch (error) {\n        this.logger.error('Health check failed:', error);\n        healthStatus.status = 'unhealthy';\n        healthStatus.error = error.message;\n        res.status(503).json(healthStatus);\n      }\n    });\n\n    // Quick endpoints for getting agents and skills lists\n    this.app.get('/api/agents', async (req, res) => {\n      try {\n        const strapiUrl = process.env.STRAPI_URL || 'http://localhost:1337';\n        const strapiToken = process.env.STRAPI_API_TOKEN;\n\n        const headers: Record<string, string> = {\n          'Content-Type': 'application/json',\n        };\n        if (strapiToken) {\n          headers['Authorization'] = `Bearer ${strapiToken}`;\n        }\n\n        const response = await fetch(`${strapiUrl}/api/agents`, { headers });\n        const data = await response.json();\n\n        res.json({ agents: data.data });\n      } catch (error) {\n        this.logger.error('Failed to get agents', error);\n        res.status(500).json({ error: 'Failed to get agents' });\n      }\n    });\n\n    this.app.get('/api/skills', async (req, res) => {\n      try {\n        const strapiUrl = process.env.STRAPI_URL || 'http://localhost:1337';\n        const strapiToken = process.env.STRAPI_API_TOKEN;\n\n        const headers: Record<string, string> = {\n          'Content-Type': 'application/json',\n        };\n        if (strapiToken) {\n          headers['Authorization'] = `Bearer ${strapiToken}`;\n        }\n\n        const response = await fetch(`${strapiUrl}/api/skills`, { headers });\n        const data = await response.json();\n\n        res.json({ skills: data.data });\n      } catch (error) {\n        this.logger.error('Failed to get skills', error);\n        res.status(500).json({ error: 'Failed to get skills' });\n      }\n    });\n\n    // Manager API routes (file system based - legacy)\n    this.app.use('/api/manager', createManagerRoutes());\n\n    // Strapi Manager API routes (CRUD operations via Strapi)\n    this.app.use('/api/strapi', createStrapiManagerRoutes());\n\n    // Execution API routes (SSE streaming for agent execution)\n    this.app.use('/api/execute', createExecutionRoutes());\n\n    // Task API routes\n    this.app.use('/api/tasks', taskRoutes);\n\n    // Chat API routes\n    this.app.use('/api/chat', chatRoutes);\n\n    // React Router catch-all - must be after all API routes\n    const isDev = process.env.NODE_ENV === 'development';\n    if (!isDev) {\n      this.app.get('*', (req, res) => {\n        res.sendFile(path.join(__dirname, 'web', 'index.html'));\n      });\n    }\n\n    // 404 handler (must be before error handler)\n    this.app.use(notFoundHandler);\n\n    // Global error handling middleware (must be last)\n    this.app.use(errorHandler);\n  }\n}\n\n// CLI entry point\n// Check if this file is being run directly (works on both Windows and Unix)\nconst isMainModule = process.argv[1] && import.meta.url === pathToFileURL(process.argv[1]).href;\n\nif (isMainModule) {\n  const server = new AgentUIServer();\n\n  server.start().catch((error) => {\n    console.error('Failed to start server:', error);\n    process.exit(1);\n  });\n\n  // Graceful shutdown\n  process.on('SIGTERM', async () => {\n    console.log('SIGTERM received, shutting down gracefully...');\n    await server.stop();\n    process.exit(0);\n  });\n\n  process.on('SIGINT', async () => {\n    console.log('\\nSIGINT received, shutting down gracefully...');\n    await server.stop();\n    process.exit(0);\n  });\n}\n",
        "timestamp": "2026-01-02T15:21:46.864601"
      },
      "worktree_state": {
        "content": "import express, { Express } from 'express';\nimport * as path from 'path';\nimport { fileURLToPath, pathToFileURL } from 'url';\nimport { dirname } from 'path';\nimport cors from 'cors';\nimport { createLogger, type Logger } from './services/logger.js';\nimport { ConfigService } from './services/config-service.js';\nimport { chatLogService } from './services/chat-log-service.js';\nimport { initializeFlowSystem } from './services/flow-init.js';\nimport { createManagerRoutes } from './routes/manager.routes.js';\nimport { createStrapiManagerRoutes } from './routes/manager.routes.strapi.js';\nimport { createExecutionRoutes } from './routes/execution.routes.js';\nimport { createFlowRoutes } from './routes/flow.routes.js';\nimport { createWebhookRoutes } from './routes/webhook.routes.js';\nimport taskRoutes from './routes/task.routes.js';\nimport chatRoutes from './routes/chat.routes.js';\nimport { errorHandler, notFoundHandler } from './middleware/error-handler.js';\nimport { requestLogger } from './middleware/request-logger.js';\n\n// Get the directory of this module for serving static files\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n/**\n * Claude Agent UI Server\n * Minimal Express server for managing Claude agents, skills, and MCP servers\n */\nexport class AgentUIServer {\n  private app: Express;\n  private server?: import('http').Server;\n  private logger: Logger;\n  private port: number;\n  private host: string;\n\n  constructor(config?: { port?: number; host?: string }) {\n    this.app = express();\n    this.logger = createLogger('AgentUIServer');\n\n    // Configuration with defaults\n    this.port = config?.port ?? parseInt(process.env.PORT ?? '3001', 10);\n    this.host = config?.host ?? process.env.HOST ?? '0.0.0.0';\n\n    this.logger.info('Initializing Claude Agent UI Server', {\n      port: this.port,\n      host: this.host,\n      nodeEnv: process.env.NODE_ENV\n    });\n\n    this.setupMiddleware();\n    this.setupRoutes();\n  }\n\n  /**\n   * Get the Express app instance\n   */\n  getApp(): Express {\n    return this.app;\n  }\n\n  /**\n   * Get the configured port\n   */\n  getPort(): number {\n    return this.port;\n  }\n\n  /**\n   * Get the configured host\n   */\n  getHost(): string {\n    return this.host;\n  }\n\n  /**\n   * Start the server\n   */\n  async start(): Promise<void> {\n    this.logger.info('Starting Claude Agent UI Server...');\n\n    // Initialize ConfigService\n    try {\n      const configService = ConfigService.getInstance();\n      await configService.initialize();\n      this.logger.info('ConfigService initialized successfully');\n    } catch (error) {\n      this.logger.warn('Failed to initialize ConfigService', error);\n      // Don't fail server start if config initialization fails\n    }\n\n    // Initialize Chat Log Service\n    try {\n      await chatLogService.init();\n      this.logger.info('ChatLogService initialized successfully');\n    } catch (error) {\n      this.logger.warn('Failed to initialize ChatLogService', error);\n      // Don't fail server start if log service initialization fails\n    }\n\n    // Initialize Flow Execution System\n    try {\n      const flowInitialized = await initializeFlowSystem({\n        workingDirectory: process.cwd(),\n      });\n      if (flowInitialized) {\n        this.logger.info('Flow execution system initialized successfully');\n      } else {\n        this.logger.warn('Flow execution system initialization returned false');\n      }\n    } catch (error) {\n      this.logger.warn('Failed to initialize Flow execution system', error);\n      // Don't fail server start if flow system initialization fails\n    }\n\n    return new Promise<void>((resolve, reject) => {\n      this.server = this.app.listen(this.port, this.host, () => {\n        this.logger.info(`\ud83d\ude80 Claude Agent UI Server running at http://${this.host}:${this.port}`);\n        this.logger.info(`\ud83d\udcf1 Manager UI: http://localhost:${this.port}/manager`);\n        resolve();\n      });\n\n      this.server.on('error', (error: Error) => {\n        this.logger.error('Failed to start HTTP server:', {\n          error: error.message,\n          code: (error as any).code,\n          port: this.port,\n          host: this.host\n        });\n        reject(error);\n      });\n    });\n  }\n\n  /**\n   * Stop the server gracefully\n   */\n  async stop(): Promise<void> {\n    this.logger.info('Stopping Claude Agent UI Server...');\n\n    if (this.server) {\n      await new Promise<void>((resolve) => {\n        this.server!.close(() => {\n          this.logger.info('Server stopped successfully');\n          resolve();\n        });\n      });\n    }\n  }\n\n  private setupMiddleware(): void {\n    // CORS configuration\n    this.app.use(cors({\n      origin: process.env.NODE_ENV === 'development'\n        ? ['http://localhost:3000', 'http://127.0.0.1:3000', 'http://localhost:3001', 'http://127.0.0.1:3001']\n        : true,\n      credentials: true\n    }));\n\n    // Body parsing\n    this.app.use(express.json({ limit: '10mb' }));\n    this.app.use(express.urlencoded({ extended: true }));\n\n    // Static file serving for production\n    const isDev = process.env.NODE_ENV === 'development';\n    if (!isDev) {\n      const staticPath = path.join(__dirname, 'web');\n      this.logger.info('Serving static files from:', staticPath);\n      this.app.use(express.static(staticPath));\n    }\n\n    // Request logging (use new centralized logger middleware)\n    this.app.use(requestLogger);\n  }\n\n  private setupRoutes(): void {\n    // Health check endpoint\n    this.app.get('/health', (req, res) => {\n      res.json({\n        status: 'ok',\n        timestamp: new Date().toISOString(),\n        uptime: process.uptime()\n      });\n    });\n\n    // Quick endpoints for getting agents and skills lists\n    this.app.get('/api/agents', async (req, res) => {\n      try {\n        const strapiUrl = process.env.STRAPI_URL || 'http://localhost:1337';\n        const strapiToken = process.env.STRAPI_API_TOKEN;\n\n        const headers: Record<string, string> = {\n          'Content-Type': 'application/json',\n        };\n        if (strapiToken) {\n          headers['Authorization'] = `Bearer ${strapiToken}`;\n        }\n\n        const response = await fetch(`${strapiUrl}/api/agents`, { headers });\n        const data = await response.json();\n\n        res.json({ agents: data.data });\n      } catch (error) {\n        this.logger.error('Failed to get agents', error);\n        res.status(500).json({ error: 'Failed to get agents' });\n      }\n    });\n\n    this.app.get('/api/skills', async (req, res) => {\n      try {\n        const strapiUrl = process.env.STRAPI_URL || 'http://localhost:1337';\n        const strapiToken = process.env.STRAPI_API_TOKEN;\n\n        const headers: Record<string, string> = {\n          'Content-Type': 'application/json',\n        };\n        if (strapiToken) {\n          headers['Authorization'] = `Bearer ${strapiToken}`;\n        }\n\n        const response = await fetch(`${strapiUrl}/api/skills`, { headers });\n        const data = await response.json();\n\n        res.json({ skills: data.data });\n      } catch (error) {\n        this.logger.error('Failed to get skills', error);\n        res.status(500).json({ error: 'Failed to get skills' });\n      }\n    });\n\n    // Manager API routes (file system based - legacy)\n    this.app.use('/api/manager', createManagerRoutes());\n\n    // Strapi Manager API routes (CRUD operations via Strapi)\n    this.app.use('/api/strapi', createStrapiManagerRoutes());\n\n    // Execution API routes (SSE streaming for agent execution)\n    this.app.use('/api/execute', createExecutionRoutes());\n\n    // Task API routes\n    this.app.use('/api/tasks', taskRoutes);\n\n    // Chat API routes\n    this.app.use('/api/chat', chatRoutes);\n\n    // Flow API routes (flow management and execution with SSE)\n    this.app.use('/api/flows', createFlowRoutes());\n\n    // Webhook API routes (external triggers for flows)\n    this.app.use('/api/webhooks', createWebhookRoutes());\n\n    // React Router catch-all - must be after all API routes\n    const isDev = process.env.NODE_ENV === 'development';\n    if (!isDev) {\n      this.app.get('*', (req, res) => {\n        res.sendFile(path.join(__dirname, 'web', 'index.html'));\n      });\n    }\n\n    // 404 handler (must be before error handler)\n    this.app.use(notFoundHandler);\n\n    // Global error handling middleware (must be last)\n    this.app.use(errorHandler);\n  }\n}\n\n// CLI entry point\n// Check if this file is being run directly (works on both Windows and Unix)\nconst isMainModule = process.argv[1] && import.meta.url === pathToFileURL(process.argv[1]).href;\n\nif (isMainModule) {\n  const server = new AgentUIServer();\n\n  server.start().catch((error) => {\n    console.error('Failed to start server:', error);\n    process.exit(1);\n  });\n\n  // Graceful shutdown\n  process.on('SIGTERM', async () => {\n    console.log('SIGTERM received, shutting down gracefully...');\n    await server.stop();\n    process.exit(0);\n  });\n\n  process.on('SIGINT', async () => {\n    console.log('\\nSIGINT received, shutting down gracefully...');\n    await server.stop();\n    process.exit(0);\n  });\n}\n",
        "last_modified": "2026-01-02T17:55:06.516827"
      },
      "task_intent": {
        "title": "007-uygulaman-n-genel-yap-s-n-d-zenleyece-iz-yani-uygu",
        "description": "Implement a workflow/flow system for organizing agents and skills into reusable, schedulable processes with input/output handling. This transforms the application from a simple agent manager to a process automation tool where users can define workflows like 'Web Scraper' that take input, run agents with skills, and produce structured outputs.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T15:21:47.275545",
  "last_updated": "2026-01-02T15:21:47.285876"
}
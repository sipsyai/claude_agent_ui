# ============================================================
# PostgreSQL Client Authentication Configuration File
# ============================================================
# Task 02: PostgreSQL Schema & Configuration
# File: pg_hba.conf (Host-Based Authentication)
# Version: PostgreSQL 16+
#
# This file controls: which hosts are allowed to connect, how clients
# are authenticated, which PostgreSQL user names they can use, which
# databases they can access.
#
# Format:
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# TYPE:
#   - local: Unix-domain socket connections
#   - host: TCP/IP connections (encrypted or not)
#   - hostssl: TCP/IP connections with SSL encryption
#   - hostnossl: TCP/IP connections without SSL
#
# DATABASE: "all", "sameuser", "samerole", or specific database name
# USER: "all" or specific username
# ADDRESS: IP address with CIDR mask (e.g., 192.168.1.0/24)
# METHOD:
#   - trust: Allow connection without password (INSECURE)
#   - reject: Reject connection
#   - md5: Password authentication with MD5 hash (legacy)
#   - scram-sha-256: Password authentication with SCRAM-SHA-256 (recommended)
#   - peer: OS username must match PostgreSQL username (Unix socket only)
#   - ident: Use identd service to verify username
# ============================================================

# ------------------------------------------------------------
# DEVELOPMENT CONFIGURATION
# Use for local development and testing
# ------------------------------------------------------------

# Local connections (Unix socket)
# Allow postgres superuser to connect locally without password
local   all             postgres                                peer

# Local connections from current user
local   all             all                                     peer

# IPv4 local connections
# Allow all local connections with password
host    all             all             127.0.0.1/32            scram-sha-256
host    all             all             ::1/128                 scram-sha-256

# Docker network connections (for Docker Compose)
# Allow connections from Docker's default bridge network
# Adjust subnet to match your Docker network
host    all             all             172.16.0.0/12           scram-sha-256

# ------------------------------------------------------------
# PRODUCTION CONFIGURATION
# Uncomment and customize for production deployment
# ------------------------------------------------------------

# PostgreSQL superuser (local maintenance only)
# local   all             postgres                                peer

# Application database connections
# Strapi backend (from application server)
# hostssl claude_agent_ui  strapi_user     10.0.1.0/24             scram-sha-256

# Express backend (from application server)
# hostssl claude_agent_ui  express_user    10.0.1.0/24             scram-sha-256

# Database administrator (from specific IP)
# hostssl claude_agent_ui  admin           10.0.1.10/32            scram-sha-256

# Replication connections (from replica servers)
# hostssl replication      replication_user 10.0.2.0/24            scram-sha-256

# Monitoring tools (read-only access)
# hostssl claude_agent_ui  monitoring_user  10.0.3.0/24            scram-sha-256

# ------------------------------------------------------------
# KUBERNETES / CONTAINER ORCHESTRATION
# For Kubernetes, Docker Swarm, or similar
# ------------------------------------------------------------

# Allow pod-to-pod communication
# Adjust CIDR to match your pod network
# host    claude_agent_ui  all             10.42.0.0/16            scram-sha-256
# host    claude_agent_ui  all             10.43.0.0/16            scram-sha-256

# ------------------------------------------------------------
# SECURITY HARDENING (PRODUCTION)
# ------------------------------------------------------------

# Block all other connections (IMPORTANT for production)
# Uncomment this line to explicitly deny all other connections
# host    all             all             0.0.0.0/0               reject
# host    all             all             ::/0                    reject

# ------------------------------------------------------------
# USER-SPECIFIC RULES
# ------------------------------------------------------------

# Allow specific database for specific user from specific IP
# host    mydb            myuser          192.168.1.100/32        scram-sha-256

# Block specific user from connecting
# host    all             blocked_user    0.0.0.0/0               reject

# Allow read-only user from anywhere (for reporting)
# host    claude_agent_ui  readonly_user   0.0.0.0/0               scram-sha-256

# ------------------------------------------------------------
# SSL/TLS ENFORCEMENT (PRODUCTION)
# ------------------------------------------------------------

# Require SSL for all remote connections
# hostssl  all            all              0.0.0.0/0               scram-sha-256
# hostnossl all           all              0.0.0.0/0               reject

# ------------------------------------------------------------
# CIDR NOTATION EXAMPLES
# ------------------------------------------------------------
# Single IP:       192.168.1.10/32
# /24 subnet:      192.168.1.0/24 (256 addresses: .0 to .255)
# /16 subnet:      192.168.0.0/16 (65,536 addresses)
# /8 subnet:       10.0.0.0/8 (16,777,216 addresses)
# IPv6 single:     ::1/128
# IPv6 subnet:     2001:db8::/32
# All IPv4:        0.0.0.0/0
# All IPv6:        ::/0
# Docker bridge:   172.17.0.0/16 (default Docker network)
# Docker custom:   172.18.0.0/16, 172.19.0.0/16, etc.
# Private ranges:  10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

# ------------------------------------------------------------
# AUTHENTICATION METHODS
# ------------------------------------------------------------
# trust:
#   - INSECURE: No password required
#   - Use ONLY for local development
#
# peer:
#   - Use OS username for authentication
#   - Only works for Unix socket connections
#   - Secure for local superuser access
#
# md5:
#   - Legacy password authentication
#   - Use scram-sha-256 instead
#
# scram-sha-256: (RECOMMENDED)
#   - Modern password authentication
#   - More secure than md5
#   - Requires PostgreSQL 10+
#
# reject:
#   - Explicitly deny connection
#   - Use as last rule to block all other attempts
#
# ident:
#   - Use identd service
#   - Rarely used in modern setups
#
# cert:
#   - Client SSL certificate authentication
#   - Most secure, requires PKI setup

# ------------------------------------------------------------
# CREATING DATABASE USERS
# ------------------------------------------------------------
# CREATE USER strapi_user WITH PASSWORD 'secure_password';
# GRANT CONNECT ON DATABASE claude_agent_ui TO strapi_user;
# GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO strapi_user;
# GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO strapi_user;
#
# CREATE USER express_user WITH PASSWORD 'secure_password';
# GRANT CONNECT ON DATABASE claude_agent_ui TO express_user;
# GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO express_user;
#
# CREATE USER readonly_user WITH PASSWORD 'secure_password';
# GRANT CONNECT ON DATABASE claude_agent_ui TO readonly_user;
# GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

# ------------------------------------------------------------
# RELOAD CONFIGURATION
# ------------------------------------------------------------
# After editing this file, reload without restarting:
#   SELECT pg_reload_conf();
# Or restart PostgreSQL:
#   systemctl restart postgresql
#   docker-compose restart postgres
#
# Check current connections:
#   SELECT * FROM pg_stat_activity;
#
# Check authentication attempts:
#   tail -f /var/log/postgresql/postgresql-*.log | grep authentication

# ============================================================
# END OF pg_hba.conf
# ============================================================
#
# IMPORTANT NOTES:
# 1. Order matters! First matching rule is used
# 2. Always put specific rules before general rules
# 3. Always add a final 'reject all' rule in production
# 4. Test changes carefully before deploying to production
# 5. Use scram-sha-256 instead of md5 for better security
# 6. Enable SSL/TLS in production (hostssl)
# 7. Restrict access by IP address whenever possible
# 8. Monitor failed authentication attempts in logs
#
# SECURITY CHECKLIST:
# [ ] Changed default postgres password
# [ ] Created application-specific users (strapi_user, express_user)
# [ ] Restricted access by IP address (not 0.0.0.0/0)
# [ ] Enabled SSL/TLS (hostssl)
# [ ] Using scram-sha-256 authentication
# [ ] Added final 'reject all' rule
# [ ] Reviewed and tested all rules
# [ ] Documented custom rules and IP addresses
# [ ] Set up connection monitoring and alerts
# [ ] Configured firewall rules (allow port 5432 from app servers only)
#
# ============================================================

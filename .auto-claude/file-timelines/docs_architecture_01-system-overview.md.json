{
  "file_path": "docs/architecture/01-system-overview.md",
  "main_branch_history": [],
  "task_views": {
    "003-create-architecture-documentation-with-system-diag": {
      "task_id": "003-create-architecture-documentation-with-system-diag",
      "branch_point": {
        "commit_hash": "34a3f60da53773d90bd6579cb1cfd8417a1dd0b9",
        "content": "",
        "timestamp": "2026-01-02T10:53:08.483278"
      },
      "worktree_state": {
        "content": "# System Architecture Overview\n\n## Introduction\n\nThe Claude Agent UI is a hybrid full-stack application that provides a web interface for creating, managing, and executing AI agents powered by Anthropic's Claude SDK. The architecture combines multiple services in a containerized environment to deliver real-time agent execution, persistent data storage, and extensible tool integration through the Model Context Protocol (MCP).\n\n## High-Level System Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Client Layer\"\n        Browser[Web Browser]\n    end\n\n    subgraph \"Docker Network: frontend\"\n        subgraph \"Frontend Container\"\n            React[React SPA<br/>Vite + Tailwind + Radix UI]\n            Nginx[Nginx<br/>Reverse Proxy]\n            React --> Nginx\n        end\n\n        subgraph \"Express Container\"\n            Express[Express Server<br/>Port 3001]\n            ClaudeSDK[Claude SDK Service<br/>Agent Execution]\n            MCPService[MCP Service<br/>Tool Integration]\n            StrapiClient[Strapi Client<br/>Data Access Layer]\n            SSE[SSE Streaming<br/>Real-time Events]\n\n            Express --> ClaudeSDK\n            Express --> MCPService\n            Express --> StrapiClient\n            Express --> SSE\n        end\n\n        subgraph \"Strapi Container\"\n            Strapi[Strapi CMS<br/>REST API<br/>Port 1337]\n            StrapiAPI[Content API]\n\n            Strapi --> StrapiAPI\n        end\n    end\n\n    subgraph \"Docker Network: backend\"\n        subgraph \"PostgreSQL Container\"\n            Postgres[(PostgreSQL 16<br/>Database<br/>Port 5432)]\n        end\n    end\n\n    subgraph \"External Services\"\n        AnthropicAPI[Anthropic API<br/>Claude Models]\n        MCPServers[MCP Servers<br/>stdio/sse/http]\n    end\n\n    subgraph \"Filesystem\"\n        MCPConfig[.mcp.json<br/>MCP Configuration]\n        AgentDefs[.claude/<br/>Agent & Skill Definitions]\n        SessionData[.claude-session/<br/>Conversation History]\n    end\n\n    %% Client connections\n    Browser -->|HTTP/HTTPS| Nginx\n\n    %% Nginx routing\n    Nginx -->|/api/*| Express\n    Nginx -->|/strapi/*| Strapi\n\n    %% Express to Strapi\n    StrapiClient -->|REST API<br/>HTTP| StrapiAPI\n\n    %% Strapi to Database\n    StrapiAPI -->|SQL Queries| Postgres\n\n    %% Claude SDK connections\n    ClaudeSDK -->|HTTPS<br/>Streaming| AnthropicAPI\n\n    %% MCP connections\n    MCPService -->|JSON-RPC<br/>stdio/sse/http| MCPServers\n\n    %% Filesystem access\n    Express -.->|Read/Write| MCPConfig\n    Express -.->|Read| AgentDefs\n    Express -.->|Read/Write| SessionData\n\n    %% SSE streaming to client\n    SSE -.->|Server-Sent Events| Nginx\n    Nginx -.->|SSE| Browser\n\n    %% Styling\n    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef backend fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    classDef data fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    classDef external fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n    classDef filesystem fill:#fce4ec,stroke:#880e4f,stroke-width:2px\n\n    class React,Nginx frontend\n    class Express,ClaudeSDK,MCPService,StrapiClient,SSE,Strapi,StrapiAPI backend\n    class Postgres data\n    class AnthropicAPI,MCPServers external\n    class MCPConfig,AgentDefs,SessionData filesystem\n```\n\n## Component Overview\n\n### 1. Frontend Layer\n\n#### React SPA (Single Page Application)\n- **Technology**: React 18 with TypeScript, Vite build tool\n- **UI Framework**: Tailwind CSS + Radix UI components\n- **Port**: Served via Nginx on port 80/443\n- **Responsibilities**:\n  - User interface for agent/skill creation and management\n  - Real-time display of agent execution via SSE\n  - Chat interface for interactive conversations\n  - MCP server configuration and management\n  - Task tracking and monitoring\n\n#### Nginx Reverse Proxy\n- **Version**: Latest stable\n- **Port**: 80 (HTTP), 443 (HTTPS in production)\n- **Responsibilities**:\n  - Serve React static assets\n  - Route `/api/*` requests to Express backend\n  - Route `/strapi/*` requests to Strapi CMS\n  - WebSocket/SSE proxy for real-time streaming\n  - Gzip compression and caching\n\n### 2. Backend Layer\n\n#### Express Server\n- **Technology**: Node.js with Express.js\n- **Port**: 3001 (internal)\n- **Responsibilities**:\n  - Business logic orchestration\n  - RESTful API endpoints (68+ routes)\n  - SSE streaming for real-time agent output\n  - File system operations (read agents, skills, MCP config)\n  - Session management\n  - Service coordination between Claude SDK, Strapi, and MCP\n\n**Key Services**:\n- **claude-sdk-service**: Orchestrates Claude AI conversations\n- **mcp-service**: Manages MCP server lifecycle and tool discovery\n- **strapi-client**: Data access layer with caching (5-min TTL)\n- **skill-isolation-service**: Isolated skill execution\n- **conversation-status-manager**: Real-time status tracking\n\n#### Claude SDK Integration\n- **SDK**: `@anthropic-ai/claude-agent-sdk`\n- **Responsibilities**:\n  - Execute AI agent conversations with Claude models\n  - Stream responses in real-time\n  - Manage conversation context and history\n  - Load and apply MCP tools dynamically\n  - Handle skill and prompt injection\n\n### 3. Data Layer\n\n#### Strapi CMS\n- **Version**: Strapi v4\n- **Port**: 1337 (internal)\n- **Responsibilities**:\n  - Headless CMS providing REST API\n  - Persistent storage for agents, skills, MCP servers/tools\n  - Chat session and message history\n  - Task management\n  - File uploads (media library)\n\n**Content Types**:\n- Agents, Skills, MCP Servers, MCP Tools\n- Chat Sessions, Chat Messages\n- Tasks (for async execution tracking)\n\n#### PostgreSQL Database\n- **Version**: PostgreSQL 16 Alpine\n- **Port**: 5432 (internal), 5433 (host-exposed)\n- **Responsibilities**:\n  - Primary data persistence\n  - Stores all Strapi content types\n  - Relational data with foreign keys\n  - Full-text search capabilities\n\n### 4. External Integrations\n\n#### Anthropic API\n- **Endpoint**: `https://api.anthropic.com`\n- **Protocol**: HTTPS with streaming\n- **Models**: Claude 3.5 Sonnet, Claude 3 Opus, Claude 3 Haiku\n- **Responsibilities**:\n  - Process AI requests from Claude SDK\n  - Stream conversation responses\n  - Execute tool calls (MCP tools)\n\n#### MCP Servers\n- **Protocol**: Model Context Protocol (JSON-RPC)\n- **Transport Types**:\n  - **stdio**: External processes via stdin/stdout (most common)\n  - **sse**: Server-Sent Events over HTTP\n  - **http**: HTTP polling\n  - **sdk**: In-process TypeScript/JavaScript servers\n\n**Example MCP Servers**:\n- `@modelcontextprotocol/server-filesystem`: File system access\n- `@modelcontextprotocol/server-brave-search`: Web search\n- `@modelcontextprotocol/server-github`: GitHub integration\n- Custom MCP servers for specialized tools\n\n### 5. Filesystem\n\n#### Configuration Files\n- **`.mcp.json`**: MCP server configuration (SDK-aligned)\n- **`.claude/`**: Agent and skill definitions (AGENT.md, SKILL.md)\n- **`.claude-session/`**: Conversation history and cache\n\n## Communication Patterns\n\n### REST API\n- **Frontend \u2194 Express**: HTTP/HTTPS requests for CRUD operations\n- **Express \u2194 Strapi**: REST API calls with LRU caching\n- **Strapi \u2194 PostgreSQL**: SQL queries via Knex.js ORM\n\n### Server-Sent Events (SSE)\n- **Express \u2192 Frontend**: Real-time streaming of:\n  - Agent execution output (tool uses, thinking, responses)\n  - Task progress updates\n  - Chat message streaming\n  - Skill execution status\n\n### JSON-RPC\n- **MCP Service \u2194 MCP Servers**: Bidirectional JSON-RPC protocol\n  - Tool discovery (`tools/list`)\n  - Tool execution (`tools/call`)\n  - Resource access (`resources/read`)\n\n## Docker Networks\n\n### Frontend Network\n- **Services**: Frontend (Nginx), Express, Strapi\n- **Purpose**: Public-facing services accessible from web browser\n- **Isolation**: PostgreSQL is NOT accessible from this network\n\n### Backend Network\n- **Services**: PostgreSQL, Strapi, Express\n- **Purpose**: Database access restricted to backend services\n- **Security**: Database not exposed to frontend network\n\n## Data Flow Examples\n\n### Agent Execution Flow\n1. User submits prompt via React UI\n2. Frontend sends POST to `/api/agents/:id/execute`\n3. Express receives request and starts SSE stream\n4. Claude SDK Service loads agent config + MCP tools\n5. SDK sends request to Anthropic API\n6. Claude processes request, may invoke MCP tools\n7. MCP Service executes tools via JSON-RPC to MCP servers\n8. Tool results returned to Claude\n9. Claude generates response\n10. Express streams events to frontend via SSE\n11. React UI updates in real-time\n\n### Data Persistence Flow\n1. User creates/updates agent via React UI\n2. Frontend sends POST/PUT to Express API\n3. Express validates and transforms data\n4. Strapi Client sends REST request to Strapi\n5. Strapi ORM executes SQL query to PostgreSQL\n6. Response propagates back through stack\n7. Frontend cache updated\n\n## Security Considerations\n\n### Network Isolation\n- Database accessible only from backend network\n- Environment variable substitution for secrets\n- No database credentials in frontend\n\n### API Security\n- Strapi authentication tokens\n- Rate limiting on Express endpoints\n- CORS configuration for frontend origin\n\n### Container Security\n- Resource limits (CPU, memory) on all containers\n- Health checks for service reliability\n- Read-only filesystem mounts where appropriate\n\n## Scalability Considerations\n\n### Caching\n- Strapi Client: 5-minute LRU cache\n- Nginx: Static asset caching\n- PostgreSQL: Query result caching\n\n### Horizontal Scaling (Future)\n- Express can scale with load balancer\n- Strapi supports horizontal scaling with shared database\n- PostgreSQL can use read replicas\n\n## Observability\n\n### Logging\n- All containers log to JSON format\n- Centralized logging via Docker log driver\n- Log rotation (10MB max, 3 files)\n\n### Health Checks\n- PostgreSQL: `pg_isready` probe\n- Strapi: HTTP `/admin` endpoint\n- Express: HTTP `/health` endpoint\n- Frontend: HTTP `/ ` endpoint\n\n### Monitoring\n- Container resource usage (CPU, memory)\n- API response times\n- Database connection pool stats\n- MCP tool execution metrics\n\n## Technology Stack Summary\n\n| Layer | Technology | Version | Purpose |\n|-------|-----------|---------|---------|\n| Frontend | React | 18 | UI framework |\n| Build Tool | Vite | Latest | Fast development builds |\n| Styling | Tailwind CSS | Latest | Utility-first CSS |\n| Components | Radix UI | Latest | Accessible component library |\n| Proxy | Nginx | Latest | Reverse proxy & static hosting |\n| Backend | Express.js | 4.x | HTTP server & API |\n| Runtime | Node.js | 20 LTS | JavaScript runtime |\n| AI SDK | Claude Agent SDK | Latest | Claude integration |\n| CMS | Strapi | 4.x | Headless CMS |\n| Database | PostgreSQL | 16 | Relational database |\n| ORM | Knex.js | Latest | SQL query builder |\n| Orchestration | Docker Compose | Latest | Container management |\n\n## Next Steps\n\nFor detailed documentation on specific architecture aspects, see:\n\n- [Data Flow Diagrams](./02-data-flow.md) - Detailed flows for agent execution, MCP tools, and chat\n- [Deployment Topology](./03-deployment.md) - Docker infrastructure and resource configuration\n- [Component Details](./04-components.md) - Service layer architecture and frontend components\n- [Sequence Diagrams](./05-sequences.md) - Step-by-step interaction flows\n- [Technology Stack](./06-tech-stack.md) - Detailed technology choices and rationale\n",
        "last_modified": "2026-01-02T15:11:22.004133"
      },
      "task_intent": {
        "title": "003-create-architecture-documentation-with-system-diag",
        "description": "Create comprehensive visual documentation showing how the hybrid architecture components (React + Express + Strapi + PostgreSQL + Claude SDK + MCP) interact, including data flow, service communication, and deployment topology.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T10:53:08.849493",
  "last_updated": "2026-01-02T10:53:08.865652"
}
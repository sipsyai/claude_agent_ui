{
  "file_path": "src/services/log-formatter.ts",
  "main_branch_history": [],
  "task_views": {
    "002-add-jsdoc-documentation-for-backend-services": {
      "task_id": "002-add-jsdoc-documentation-for-backend-services",
      "branch_point": {
        "commit_hash": "34a3f60da53773d90bd6579cb1cfd8417a1dd0b9",
        "content": "import { Transform } from 'stream';\n\ninterface LogObject {\n  level: number;\n  time: number | string;\n  msg: string;\n  component?: string;\n  requestId?: string;\n  sessionId?: string;\n  streamingId?: string;\n  err?: {\n    message?: string;\n    stack?: string;\n  };\n  error?: {\n    message?: string;\n    stack?: string;\n  };\n  [key: string]: unknown;\n}\n\nconst RESET = '\\x1b[0m';\nconst GRAY = '\\x1b[90m';\nconst BOLD = '\\x1b[1m';\nconst BLUE = '\\x1b[34m';\n\nexport class LogFormatter extends Transform {\n  constructor() {\n    super({\n      writableObjectMode: true,\n      transform(chunk: unknown, _encoding: string, callback: (error?: Error | null, data?: unknown) => void) {\n        try {\n          const logLine = String(chunk).trim();\n          if (!logLine) {\n            callback();\n            return;\n          }\n\n          const log: LogObject = JSON.parse(logLine);\n          const formatted = formatLog(log);\n          callback(null, formatted + '\\n');\n        } catch (_err) {\n          // If we can't parse it, pass it through as-is\n          callback(null, chunk);\n        }\n      }\n    });\n  }\n}\n\nfunction formatLog(log: LogObject): string {\n  // Format timestamp in 12-hour format with AM/PM\n  const time = new Date(typeof log.time === 'string' ? log.time : log.time);\n  const hours = time.getHours();\n  const minutes = time.getMinutes().toString().padStart(2, '0');\n  const seconds = time.getSeconds().toString().padStart(2, '0');\n  const ampm = hours >= 12 ? 'PM' : 'AM';\n  const displayHours = (hours % 12 || 12).toString().padStart(2, '0');\n  const timestamp = `${displayHours}:${minutes}:${seconds} ${ampm}`;\n\n  // Build the formatted message\n  let formatted = `${GRAY}${timestamp}${RESET}`;\n\n  // Add component in bold blue brackets if present\n  if (log.component) {\n    formatted += ` ${BOLD}${BLUE}[${log.component}]${RESET}`;\n  }\n\n  // Add the main message\n  formatted += ` ${log.msg}`;\n\n  // Add context fields (filter out only pino internals)\n  const excludedFields = ['level', 'time', 'msg', 'component', 'pid', 'hostname', 'v'];\n  const contextFields = Object.keys(log)\n    .filter(key => !excludedFields.includes(key) && log[key] !== undefined && log[key] !== null);\n\n  if (contextFields.length > 0) {\n    const contextPairs = contextFields.map(key => {\n      const value = log[key];\n      \n      // Special handling for error objects\n      if ((key === 'err' || key === 'error') && typeof value === 'object' && value !== null && 'message' in value) {\n        return `${key}=\"${(value as { message: string }).message}\"`;\n      }\n      \n      // Format based on value type\n      if (typeof value === 'string') {\n        return `${key}=\"${value}\"`;\n      } else if (typeof value === 'number' || typeof value === 'boolean') {\n        return `${key}=${value}`;\n      } else {\n        // For objects and arrays, use JSON.stringify\n        return `${key}=${JSON.stringify(value)}`;\n      }\n    });\n    \n    formatted += ` ${GRAY}${contextPairs.join(' ')}${RESET}`;\n  }\n\n  // Handle error stack traces\n  if (log.err && typeof log.err === 'object' && 'stack' in log.err && log.err.stack) {\n    formatted += `\\n${log.err.stack}`;\n  }\n\n  return formatted;\n}",
        "timestamp": "2026-01-02T14:06:14.995695"
      },
      "worktree_state": {
        "content": "import { Transform } from 'stream';\n\n/**\n * Pino log object structure from JSON output.\n *\n * Represents the JSON format emitted by Pino logger before transformation to\n * human-readable console output. Pino emits newline-delimited JSON (NDJSON) where\n * each log entry is a single-line JSON object with standardized fields.\n *\n * @example Basic info log\n * ```json\n * {\n *   \"level\": 30,\n *   \"time\": 1704196800000,\n *   \"msg\": \"Server started\",\n *   \"component\": \"ApiServer\",\n *   \"pid\": 12345,\n *   \"hostname\": \"localhost\"\n * }\n * ```\n *\n * @example Error log with stack trace\n * ```json\n * {\n *   \"level\": 50,\n *   \"time\": \"2024-01-02T12:00:00.000Z\",\n *   \"msg\": \"Database connection failed\",\n *   \"component\": \"DatabaseService\",\n *   \"err\": {\n *     \"message\": \"Connection timeout\",\n *     \"stack\": \"Error: Connection timeout\\n    at Database.connect (db.ts:45:15)\"\n *   }\n * }\n * ```\n *\n * @example Context-rich log with custom fields\n * ```json\n * {\n *   \"level\": 20,\n *   \"time\": 1704196800000,\n *   \"msg\": \"Message processed\",\n *   \"component\": \"ChatService\",\n *   \"sessionId\": \"session-123\",\n *   \"streamingId\": \"stream-789\",\n *   \"messageId\": \"msg-456\",\n *   \"duration\": 1234\n * }\n * ```\n *\n * @see {@link formatLog} for transformation to console format\n * @see {@link LogFormatter} for stream-based transformation\n */\ninterface LogObject {\n  /** Pino log level (10=trace, 20=debug, 30=info, 40=warn, 50=error, 60=fatal) */\n  level: number;\n  /** Timestamp as Unix epoch milliseconds or ISO 8601 string */\n  time: number | string;\n  /** Main log message text */\n  msg: string;\n  /** Component name (e.g., 'ChatService', 'MCPService') for log categorization */\n  component?: string;\n  /** HTTP request identifier for distributed tracing */\n  requestId?: string;\n  /** Chat session identifier for correlating conversation logs */\n  sessionId?: string;\n  /** Stream identifier for tracking SDK streaming response logs */\n  streamingId?: string;\n  /** Error object with message and stack trace (Pino's error serialization) */\n  err?: {\n    message?: string;\n    stack?: string;\n  };\n  /** Alternative error field name (some loggers use 'error' instead of 'err') */\n  error?: {\n    message?: string;\n    stack?: string;\n  };\n  /** Additional custom context fields (e.g., messageId, duration, userId) */\n  [key: string]: unknown;\n}\n\n/** ANSI escape code to reset all formatting (color and style) */\nconst RESET = '\\x1b[0m';\n/** ANSI escape code for gray/dim text color (used for timestamps and context) */\nconst GRAY = '\\x1b[90m';\n/** ANSI escape code for bold text style (used for component names) */\nconst BOLD = '\\x1b[1m';\n/** ANSI escape code for blue text color (used for component names) */\nconst BLUE = '\\x1b[34m';\n\n/**\n * Transform stream that converts Pino JSON logs to human-readable colored console output.\n *\n * LogFormatter is a Node.js Transform stream (object mode) that sits between Pino's JSON\n * output and the console. It parses newline-delimited JSON (NDJSON) log entries and formats\n * them with ANSI colors, timestamps, component names, and context fields for improved\n * readability during development and debugging.\n *\n * ## Stream Transformation Flow\n *\n * 1. **Input**: NDJSON from Pino logger (one JSON object per line)\n * 2. **Parse**: JSON.parse() each log line into LogObject\n * 3. **Format**: Transform to colored console output via formatLog()\n * 4. **Output**: Human-readable formatted string with newline\n * 5. **Error Handling**: Pass through unparseable chunks as-is (graceful degradation)\n *\n * ## Color Formatting\n *\n * LogFormatter applies ANSI color codes for visual hierarchy:\n * - **Timestamps**: Gray (dim) for low visual weight\n * - **Component Names**: Bold Blue in brackets for quick scanning\n * - **Messages**: Default terminal color (usually white/black)\n * - **Context Fields**: Gray (dim) for supplementary information\n * - **Stack Traces**: Default color with preserved indentation\n *\n * ## Output Modes\n *\n * LogFormatter supports two output modes via configuration:\n *\n * ### Object Mode (writableObjectMode: true)\n * - **Input**: JavaScript objects or Buffers from Pino\n * - **Processing**: Parses JSON strings to objects\n * - **Use Case**: Standard console output in development\n *\n * ### Graceful Degradation\n * - **Fallback**: Unparseable chunks passed through unchanged\n * - **Use Case**: Mixed output streams or malformed JSON\n * - **Example**: Non-JSON console.log() outputs mixed with Pino logs\n *\n * ## Architecture\n *\n * LogFormatter extends Node.js Transform stream:\n * - **Writable Side**: Accepts JSON log objects from Pino (object mode)\n * - **Readable Side**: Emits formatted strings to console/stdout\n * - **Transform Function**: Inline in constructor for performance\n * - **Error Handling**: Try-catch with graceful fallback (no stream errors)\n *\n * @example Basic usage with Pino logger (single stream)\n * ```typescript\n * import pino from 'pino';\n * import { LogFormatter } from './log-formatter.js';\n *\n * const logger = pino({\n *   level: 'info'\n * }, new LogFormatter());\n *\n * logger.info('Server started', { port: 3000 });\n * // Output: 02:30:45 PM [ApiServer] Server started port=3000\n * ```\n *\n * @example Multi-stream setup with LoggerService (production pattern)\n * ```typescript\n * import pino from 'pino';\n * import { PassThrough } from 'stream';\n * import { LogFormatter } from './log-formatter.js';\n *\n * // Console stream with formatting\n * const consoleStream = new LogFormatter();\n * consoleStream.pipe(process.stdout);\n *\n * // Additional raw JSON stream for log aggregation\n * const rawStream = new PassThrough();\n * rawStream.pipe(logFileStream);\n *\n * const logger = pino({\n *   level: 'info'\n * }, pino.multistream([\n *   { stream: consoleStream },\n *   { stream: rawStream }\n * ]));\n * ```\n *\n * @example Output format demonstration\n * ```typescript\n * const logger = createLogger('ChatService', { sessionId: 'session-123' });\n *\n * // Basic log\n * logger.info('Message received');\n * // Output: 02:30:45 PM [ChatService] Message received sessionId=\"session-123\"\n *\n * // Log with context\n * logger.debug('Processing message', { messageId: 'msg-456', duration: 1234 });\n * // Output: 02:30:46 PM [ChatService] Processing message sessionId=\"session-123\" messageId=\"msg-456\" duration=1234\n *\n * // Error log with stack trace\n * logger.error('Database query failed', new Error('Connection timeout'));\n * // Output:\n * // 02:30:47 PM [ChatService] Database query failed sessionId=\"session-123\" err=\"Connection timeout\"\n * // Error: Connection timeout\n * //     at Database.query (db.ts:45:15)\n * //     at ChatService.saveMessage (chat-service.ts:123:30)\n * ```\n *\n * @example Graceful degradation with non-JSON input\n * ```typescript\n * const formatter = new LogFormatter();\n * formatter.pipe(process.stdout);\n *\n * // Valid JSON - formatted\n * formatter.write('{\"level\":30,\"time\":1704196800000,\"msg\":\"Test\"}\\n');\n * // Output: 02:30:45 PM Test\n *\n * // Invalid JSON - passed through as-is\n * formatter.write('Plain text console.log output\\n');\n * // Output: Plain text console.log output\n * ```\n *\n * @example Integration with LoggerService (actual usage)\n * ```typescript\n * // LoggerService uses LogFormatter for console output\n * export class LoggerService {\n *   private static instance: LoggerService | null = null;\n *   private logger: PinoLogger;\n *   private consoleStream: LogFormatter;\n *   private bufferStream: LogStreamBuffer;\n *\n *   private constructor() {\n *     // Multi-stream setup\n *     this.consoleStream = new LogFormatter();\n *     this.consoleStream.pipe(process.stdout);\n *\n *     this.bufferStream = LogStreamBuffer.getInstance();\n *\n *     this.logger = pino({\n *       level: process.env.LOG_LEVEL || 'info',\n *     }, pino.multistream([\n *       { stream: this.consoleStream },\n *       { stream: this.bufferStream }\n *     ]));\n *   }\n * }\n *\n * // Usage produces formatted console output\n * const logger = createLogger('MyComponent');\n * logger.info('Hello World');\n * // Console: 02:30:45 PM [MyComponent] Hello World\n * ```\n *\n * @example Timestamp formatting (12-hour with AM/PM)\n * ```typescript\n * // Different times of day\n * logger.info('Morning');   // 09:15:30 AM\n * logger.info('Afternoon'); // 02:30:45 PM\n * logger.info('Evening');   // 08:45:00 PM\n * logger.info('Midnight');  // 12:00:00 AM\n * logger.info('Noon');      // 12:00:00 PM\n * ```\n *\n * @example Context field formatting (type-aware)\n * ```typescript\n * logger.info('Context demo', {\n *   string: 'value',           // string=\"value\"\n *   number: 123,               // number=123\n *   boolean: true,             // boolean=true\n *   object: { nested: 'data' }, // object={\"nested\":\"data\"}\n *   array: [1, 2, 3]           // array=[1,2,3]\n * });\n * // Output: 02:30:45 PM Context demo string=\"value\" number=123 boolean=true object={\"nested\":\"data\"} array=[1,2,3]\n * ```\n *\n * @see {@link formatLog} for formatting logic implementation\n * @see {@link LogObject} for input JSON structure\n * @see {@link LoggerService} for production multi-stream setup\n * @see {@link LogStreamBuffer} for real-time UI log streaming\n */\nexport class LogFormatter extends Transform {\n  constructor() {\n    super({\n      writableObjectMode: true,\n      transform(chunk: unknown, _encoding: string, callback: (error?: Error | null, data?: unknown) => void) {\n        try {\n          const logLine = String(chunk).trim();\n          if (!logLine) {\n            callback();\n            return;\n          }\n\n          const log: LogObject = JSON.parse(logLine);\n          const formatted = formatLog(log);\n          callback(null, formatted + '\\n');\n        } catch (_err) {\n          // If we can't parse it, pass it through as-is\n          callback(null, chunk);\n        }\n      }\n    });\n  }\n}\n\n/**\n * Formats a Pino log object into human-readable colored console output.\n *\n * Transforms structured JSON log entries from Pino into visually organized console output\n * with ANSI color codes. The formatter applies a consistent layout: timestamp (gray),\n * component name (bold blue), message (default color), and context fields (gray).\n *\n * ## Formatting Rules\n *\n * 1. **Timestamp**: Converted to 12-hour format with AM/PM (e.g., \"02:30:45 PM\")\n * 2. **Component**: Displayed in bold blue brackets (e.g., \"[ChatService]\")\n * 3. **Message**: Main log message text in default terminal color\n * 4. **Context Fields**: Key-value pairs in gray, type-aware formatting\n * 5. **Error Stack Traces**: Appended on new lines with preserved indentation\n *\n * ## Context Field Formatting (Type-Aware)\n *\n * - **Strings**: Quoted with double quotes (e.g., `sessionId=\"session-123\"`)\n * - **Numbers**: Unquoted (e.g., `duration=1234`)\n * - **Booleans**: Unquoted (e.g., `success=true`)\n * - **Objects/Arrays**: JSON.stringify() (e.g., `config={\"retry\":3}`)\n * - **Errors**: Error message extracted (e.g., `err=\"Connection timeout\"`)\n *\n * ## Excluded Fields (Pino Internals)\n *\n * The following Pino metadata fields are filtered out from context output:\n * - `level`: Log level (already implicit in output)\n * - `time`: Timestamp (formatted separately)\n * - `msg`: Main message (displayed separately)\n * - `component`: Component name (displayed in brackets)\n * - `pid`: Process ID (internal Pino metadata)\n * - `hostname`: Hostname (internal Pino metadata)\n * - `v`: Pino version (internal Pino metadata)\n *\n * All other fields are treated as custom context and included in the output.\n *\n * @param log - Pino log object (parsed JSON from NDJSON stream)\n * @returns Formatted string with ANSI color codes and newline appended by caller\n *\n * @example Basic info log\n * ```typescript\n * const log = {\n *   level: 30,\n *   time: 1704196800000,\n *   msg: 'Server started',\n *   component: 'ApiServer',\n *   port: 3000\n * };\n * const formatted = formatLog(log);\n * // Output: \"02:30:45 PM [ApiServer] Server started port=3000\"\n * ```\n *\n * @example Log with multiple context fields\n * ```typescript\n * const log = {\n *   level: 20,\n *   time: '2024-01-02T14:30:45.123Z',\n *   msg: 'Message processed',\n *   component: 'ChatService',\n *   sessionId: 'session-123',\n *   messageId: 'msg-456',\n *   duration: 1234,\n *   success: true\n * };\n * const formatted = formatLog(log);\n * // Output: \"02:30:45 PM [ChatService] Message processed sessionId=\"session-123\" messageId=\"msg-456\" duration=1234 success=true\"\n * ```\n *\n * @example Error log with stack trace\n * ```typescript\n * const log = {\n *   level: 50,\n *   time: 1704196800000,\n *   msg: 'Database query failed',\n *   component: 'DatabaseService',\n *   err: {\n *     message: 'Connection timeout',\n *     stack: 'Error: Connection timeout\\n    at Database.query (db.ts:45:15)\\n    at ChatService.saveMessage (chat-service.ts:123:30)'\n *   },\n *   query: 'SELECT * FROM messages'\n * };\n * const formatted = formatLog(log);\n * // Output:\n * // \"02:30:45 PM [DatabaseService] Database query failed query=\"SELECT * FROM messages\" err=\"Connection timeout\"\n * // Error: Connection timeout\n * //     at Database.query (db.ts:45:15)\n * //     at ChatService.saveMessage (chat-service.ts:123:30)\"\n * ```\n *\n * @example Log without component\n * ```typescript\n * const log = {\n *   level: 30,\n *   time: 1704196800000,\n *   msg: 'Generic message',\n *   userId: 'user-789'\n * };\n * const formatted = formatLog(log);\n * // Output: \"02:30:45 PM Generic message userId=\"user-789\"\"\n * // (No component brackets)\n * ```\n *\n * @example Context field type handling\n * ```typescript\n * const log = {\n *   level: 30,\n *   time: 1704196800000,\n *   msg: 'Type demo',\n *   stringValue: 'hello',\n *   numberValue: 42,\n *   booleanValue: false,\n *   objectValue: { nested: 'data' },\n *   arrayValue: [1, 2, 3],\n *   nullValue: null,\n *   undefinedValue: undefined\n * };\n * const formatted = formatLog(log);\n * // Output: \"02:30:45 PM Type demo stringValue=\"hello\" numberValue=42 booleanValue=false objectValue={\"nested\":\"data\"} arrayValue=[1,2,3]\"\n * // Note: null and undefined values are excluded from context output\n * ```\n *\n * @example Timestamp format conversion\n * ```typescript\n * // Unix epoch milliseconds\n * const log1 = { level: 30, time: 1704196800000, msg: 'Test' };\n * formatLog(log1); // \"02:30:00 PM Test\" (depends on timezone)\n *\n * // ISO 8601 string\n * const log2 = { level: 30, time: '2024-01-02T14:30:45.123Z', msg: 'Test' };\n * formatLog(log2); // \"02:30:45 PM Test\" (converted to local time)\n *\n * // 12-hour format examples\n * // 00:00:00 -> 12:00:00 AM (midnight)\n * // 01:30:45 -> 01:30:45 AM\n * // 12:00:00 -> 12:00:00 PM (noon)\n * // 13:30:45 -> 01:30:45 PM\n * // 23:59:59 -> 11:59:59 PM\n * ```\n *\n * @example Alternative error field name\n * ```typescript\n * const log = {\n *   level: 50,\n *   time: 1704196800000,\n *   msg: 'Error occurred',\n *   error: {  // Some loggers use 'error' instead of 'err'\n *     message: 'Validation failed',\n *     stack: 'Error: Validation failed\\n    at validate (validator.ts:10:5)'\n *   }\n * };\n * const formatted = formatLog(log);\n * // Output: \"02:30:00 PM Error occurred error=\"Validation failed\"\n * // Error: Validation failed\n * //     at validate (validator.ts:10:5)\"\n * ```\n *\n * @example Pino internal fields filtered out\n * ```typescript\n * const log = {\n *   level: 30,\n *   time: 1704196800000,\n *   msg: 'Test message',\n *   component: 'TestService',\n *   pid: 12345,           // Filtered out\n *   hostname: 'localhost', // Filtered out\n *   v: 1,                 // Filtered out\n *   customField: 'value'  // Included\n * };\n * const formatted = formatLog(log);\n * // Output: \"02:30:00 PM [TestService] Test message customField=\"value\"\"\n * // Only customField is included in context (pid, hostname, v excluded)\n * ```\n *\n * @see {@link LogObject} for input structure\n * @see {@link LogFormatter} for stream integration\n */\nfunction formatLog(log: LogObject): string {\n  // Format timestamp in 12-hour format with AM/PM\n  const time = new Date(typeof log.time === 'string' ? log.time : log.time);\n  const hours = time.getHours();\n  const minutes = time.getMinutes().toString().padStart(2, '0');\n  const seconds = time.getSeconds().toString().padStart(2, '0');\n  const ampm = hours >= 12 ? 'PM' : 'AM';\n  const displayHours = (hours % 12 || 12).toString().padStart(2, '0');\n  const timestamp = `${displayHours}:${minutes}:${seconds} ${ampm}`;\n\n  // Build the formatted message\n  let formatted = `${GRAY}${timestamp}${RESET}`;\n\n  // Add component in bold blue brackets if present\n  if (log.component) {\n    formatted += ` ${BOLD}${BLUE}[${log.component}]${RESET}`;\n  }\n\n  // Add the main message\n  formatted += ` ${log.msg}`;\n\n  // Add context fields (filter out only pino internals)\n  const excludedFields = ['level', 'time', 'msg', 'component', 'pid', 'hostname', 'v'];\n  const contextFields = Object.keys(log)\n    .filter(key => !excludedFields.includes(key) && log[key] !== undefined && log[key] !== null);\n\n  if (contextFields.length > 0) {\n    const contextPairs = contextFields.map(key => {\n      const value = log[key];\n      \n      // Special handling for error objects\n      if ((key === 'err' || key === 'error') && typeof value === 'object' && value !== null && 'message' in value) {\n        return `${key}=\"${(value as { message: string }).message}\"`;\n      }\n      \n      // Format based on value type\n      if (typeof value === 'string') {\n        return `${key}=\"${value}\"`;\n      } else if (typeof value === 'number' || typeof value === 'boolean') {\n        return `${key}=${value}`;\n      } else {\n        // For objects and arrays, use JSON.stringify\n        return `${key}=${JSON.stringify(value)}`;\n      }\n    });\n    \n    formatted += ` ${GRAY}${contextPairs.join(' ')}${RESET}`;\n  }\n\n  // Handle error stack traces\n  if (log.err && typeof log.err === 'object' && 'stack' in log.err && log.err.stack) {\n    formatted += `\\n${log.err.stack}`;\n  }\n\n  return formatted;\n}",
        "last_modified": "2026-01-02T14:06:15.766811"
      },
      "task_intent": {
        "title": "002-add-jsdoc-documentation-for-backend-services",
        "description": "Add comprehensive JSDoc documentation to 27 service files in src/services with 65+ exported functions, classes, and interfaces. Focus on function parameters, return types, usage patterns, and examples.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T14:06:15.564589",
  "last_updated": "2026-01-02T14:06:15.576068"
}
{
  "file_path": "docs/architecture/04-components.md",
  "main_branch_history": [],
  "task_views": {
    "003-create-architecture-documentation-with-system-diag": {
      "task_id": "003-create-architecture-documentation-with-system-diag",
      "branch_point": {
        "commit_hash": "34a3f60da53773d90bd6579cb1cfd8417a1dd0b9",
        "content": "",
        "timestamp": "2026-01-02T10:53:08.483278"
      },
      "worktree_state": {
        "content": "# Component Architecture\n\n## Introduction\n\nThis document provides detailed component diagrams for all three layers of the Claude Agent UI system: the Express service layer, the React frontend component hierarchy, and the Strapi CMS content types with their relationships. Understanding these components is essential for development, debugging, and extending the system.\n\n## Overview\n\nThe system has three primary component layers:\n\n1. **Express Service Layer** - Business logic and integration services\n2. **Frontend Component Hierarchy** - React UI components and structure\n3. **Strapi Content Types** - Database schema and relationships\n\n---\n\n## 1. Express Service Layer\n\nThis diagram shows all services in the Express backend, organized by category and showing their dependencies and interactions.\n\n```mermaid\ngraph TB\n    subgraph \"Core AI Services\"\n        ClaudeSDK[claude-sdk-service.ts<br/>Agent Execution Engine]\n        ClaudeRouter[claude-router-service.ts<br/>Model Selection & Routing]\n        ClaudeHistoryReader[claude-history-reader.ts<br/>Session History Loading]\n        SDKHistoryWriter[sdk-history-writer.ts<br/>Session History Persistence]\n        ClaudeStructureParser[claude-structure-parser.ts<br/>Parse Agent Responses]\n    end\n\n    subgraph \"Data Layer Services\"\n        StrapiClient[strapi-client.ts<br/>Data Access Layer<br/>LRU Cache + REST API]\n    end\n\n    subgraph \"MCP Integration Services\"\n        MCPService[mcp-service.ts<br/>MCP Server Management<br/>Tool Discovery & Execution]\n    end\n\n    subgraph \"Chat Services\"\n        ChatService[chat-service.ts<br/>Chat Session Management<br/>SSE Streaming]\n        ChatLogService[chat-log-service.ts<br/>Message Logging & Formatting]\n    end\n\n    subgraph \"Skill Services\"\n        SkillService[skill-service.ts<br/>Skill Execution & Management]\n        SkillSyncService[skill-sync-service.ts<br/>Filesystem Synchronization]\n    end\n\n    subgraph \"Infrastructure Services\"\n        ConfigService[config-service.ts<br/>Environment & Config Management]\n        FileSystemService[file-system-service.ts<br/>File I/O Operations]\n        Logger[logger.ts<br/>Pino Logging]\n        NotificationService[notification-service.ts<br/>System Notifications]\n        WebPushService[web-push-service.ts<br/>Push Notification Delivery]\n        SessionInfoService[session-info-service.ts<br/>Session Metadata]\n        TaskStorageService[task-storage-service.ts<br/>Task Persistence]\n    end\n\n    subgraph \"Utilities\"\n        ConversationCache[conversation-cache.ts<br/>In-Memory Cache]\n        ConversationStatusManager[conversation-status-manager.ts<br/>Status Tracking]\n        MessageFilter[message-filter.ts<br/>Message Filtering]\n        LogFormatter[log-formatter.ts<br/>Log Formatting]\n        LogStreamBuffer[log-stream-buffer.ts<br/>Stream Buffering]\n        ToolMetricsService[ToolMetricsService.ts<br/>Tool Usage Analytics]\n    end\n\n    subgraph \"Training & Selection\"\n        TrainingAgentSelector[training-agent-selector.ts<br/>Select Training Agent]\n    end\n\n    %% Core AI Dependencies\n    ClaudeSDK --> MCPService\n    ClaudeSDK --> ClaudeHistoryReader\n    ClaudeSDK --> SDKHistoryWriter\n    ClaudeSDK --> ClaudeStructureParser\n    ClaudeRouter --> ClaudeSDK\n\n    %% Data Access\n    ClaudeSDK -.->|Data Access| StrapiClient\n    ChatService -.->|Data Access| StrapiClient\n    SkillService -.->|Data Access| StrapiClient\n    MCPService -.->|Data Access| StrapiClient\n    TaskStorageService -.->|Data Access| StrapiClient\n\n    %% Skill Integration\n    SkillService --> SkillSyncService\n    SkillSyncService --> FileSystemService\n    ClaudeSDK --> SkillService\n\n    %% Chat Flow\n    ChatService --> ClaudeSDK\n    ChatService --> ChatLogService\n    ChatService --> MessageFilter\n    ChatLogService --> LogFormatter\n\n    %% MCP Integration\n    MCPService --> ConfigService\n    MCPService --> FileSystemService\n\n    %% Infrastructure\n    ClaudeSDK --> Logger\n    ChatService --> Logger\n    MCPService --> Logger\n    StrapiClient --> ConversationCache\n    ChatService --> ConversationStatusManager\n    ChatService --> SessionInfoService\n\n    %% Notifications\n    ChatService --> NotificationService\n    NotificationService --> WebPushService\n\n    %% Metrics\n    ClaudeSDK --> ToolMetricsService\n\n    %% Training\n    SkillService --> TrainingAgentSelector\n    TrainingAgentSelector -.->|Data Access| StrapiClient\n\n    %% Styling\n    classDef coreAI fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef data fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    classDef mcp fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    classDef chat fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n    classDef skill fill:#fce4ec,stroke:#880e4f,stroke-width:2px\n    classDef infra fill:#e0f2f1,stroke:#004d40,stroke-width:2px\n    classDef util fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    classDef training fill:#ede7f6,stroke:#311b92,stroke-width:2px\n\n    class ClaudeSDK,ClaudeRouter,ClaudeHistoryReader,SDKHistoryWriter,ClaudeStructureParser coreAI\n    class StrapiClient data\n    class MCPService mcp\n    class ChatService,ChatLogService chat\n    class SkillService,SkillSyncService skill\n    class ConfigService,FileSystemService,Logger,NotificationService,WebPushService,SessionInfoService,TaskStorageService infra\n    class ConversationCache,ConversationStatusManager,MessageFilter,LogFormatter,LogStreamBuffer,ToolMetricsService util\n    class TrainingAgentSelector training\n```\n\n### Service Categories\n\n#### Core AI Services (5 services)\n- **claude-sdk-service**: Main agent execution engine using Anthropic's Claude SDK\n- **claude-router-service**: Routes requests to appropriate Claude models based on requirements\n- **claude-history-reader**: Loads conversation history from filesystem\n- **sdk-history-writer**: Persists conversation history to filesystem\n- **claude-structure-parser**: Parses and structures Claude API responses\n\n#### Data Layer (1 service)\n- **strapi-client**: Single gateway to Strapi CMS with LRU caching for performance\n\n#### MCP Integration (1 service)\n- **mcp-service**: Manages MCP server connections, tool discovery, and execution\n\n#### Chat Services (2 services)\n- **chat-service**: Manages chat sessions with SSE streaming support\n- **chat-log-service**: Handles message logging and formatting\n\n#### Skill Services (2 services)\n- **skill-service**: Manages skill execution and lifecycle\n- **skill-sync-service**: Synchronizes skills between database and filesystem\n\n#### Infrastructure Services (7 services)\n- **config-service**: Central configuration management\n- **file-system-service**: File I/O operations wrapper\n- **logger**: Structured logging using Pino\n- **notification-service**: System notification management\n- **web-push-service**: Browser push notification delivery\n- **session-info-service**: Session metadata tracking\n- **task-storage-service**: Task execution persistence\n\n#### Utilities (6 services)\n- **conversation-cache**: In-memory LRU cache for conversations\n- **conversation-status-manager**: Tracks conversation execution status\n- **message-filter**: Filters and validates messages\n- **log-formatter**: Formats log output\n- **log-stream-buffer**: Buffers streaming logs\n- **ToolMetricsService**: Tracks tool usage metrics\n\n#### Training & Selection (1 service)\n- **training-agent-selector**: Selects appropriate agent for skill training\n\n### Key Service Patterns\n\n1. **Single Data Gateway**: `strapi-client` is the only service that communicates with Strapi\n2. **Caching Strategy**: LRU caching in `strapi-client` and `conversation-cache`\n3. **Event-Driven**: Services use EventEmitter for real-time updates\n4. **Filesystem Sync**: Skills and MCP configs synchronized between DB and filesystem\n5. **Logging**: Centralized structured logging via Pino logger\n\n---\n\n## 2. Frontend Component Hierarchy\n\nThis diagram shows the React component structure, organized by feature and responsibility.\n\n```mermaid\ngraph TB\n    subgraph \"Application Root\"\n        Main[main.tsx<br/>React Entry Point]\n        Router[BrowserRouter<br/>React Router]\n        ManagerApp[ManagerApp.tsx<br/>Main Application]\n    end\n\n    subgraph \"Layout Components\"\n        Layout[Layout.tsx<br/>App Shell]\n        Sidebar[Sidebar.tsx<br/>Navigation Menu]\n    end\n\n    subgraph \"Page Components\"\n        LandingPage[LandingPage.tsx<br/>Home Dashboard]\n        AgentsPage[AgentsPage.tsx<br/>Agent Management]\n        SkillsPage[SkillsPage.tsx<br/>Skill Management]\n        MCPServersPage[MCPServersPage.tsx<br/>MCP Server Management]\n        CommandsPage[CommandsPage.tsx<br/>Slash Commands]\n        SettingsPage[SettingsPage.tsx<br/>App Settings]\n    end\n\n    subgraph \"Agent Components\"\n        AgentConfigModal[AgentConfigModal.tsx<br/>Agent Configuration]\n        AgentCreatorForm[AgentCreatorForm.tsx<br/>Create/Edit Agent]\n        AgentCreatorChatPanel[AgentCreatorChatPanel.tsx<br/>Agent Chat Interface]\n        TaskExecutionModal[TaskExecutionModal.tsx<br/>Execute Agent Task]\n    end\n\n    subgraph \"Skill Components\"\n        SkillCreationModal[SkillCreationModal.tsx<br/>Create/Edit Skill]\n        SkillCreatorChatPanel[SkillCreatorChatPanel.tsx<br/>Skill Training Chat]\n    end\n\n    subgraph \"Chat Components\"\n        ChatSessionModal[ChatSessionModal.tsx<br/>Chat Session Manager]\n        ComposerArea[ComposerArea.tsx<br/>Message Input Area]\n        MessageBubble[MessageBubble.tsx<br/>Message Display]\n        SystemMessageDisplay[SystemMessageDisplay.tsx<br/>System Message]\n        ToolUseDisplay[ToolUseDisplay.tsx<br/>Tool Execution Display]\n    end\n\n    subgraph \"UI Components (Radix UI)\"\n        Button[Button.tsx]\n        Input[Input.tsx]\n        Textarea[Textarea.tsx]\n        Select[Select.tsx]\n        Dialog[Dialog.tsx]\n        Switch[Switch.tsx]\n        Card[Card.tsx]\n        Icons[Icons.tsx]\n        ProgressBar[ProgressBar.tsx]\n    end\n\n    subgraph \"Form Components\"\n        KeyValueEditor[KeyValueEditor.tsx<br/>Edit Key-Value Pairs]\n        ArrayEditor[ArrayEditor.tsx<br/>Edit Arrays]\n    end\n\n    subgraph \"Contexts\"\n        ChatDisplayContext[ChatDisplayContext.tsx<br/>Chat State Management]\n    end\n\n    subgraph \"Services\"\n        APIService[API Service Layer<br/>Axios HTTP Client]\n        SSEService[SSE Service<br/>EventSource Streaming]\n    end\n\n    subgraph \"Hooks\"\n        CustomHooks[Custom React Hooks<br/>State & Effects]\n    end\n\n    %% App Structure\n    Main --> Router\n    Router --> ManagerApp\n    ManagerApp --> Layout\n    Layout --> Sidebar\n    Layout --> LandingPage\n    Layout --> AgentsPage\n    Layout --> SkillsPage\n    Layout --> MCPServersPage\n    Layout --> CommandsPage\n    Layout --> SettingsPage\n\n    %% Agent Flow\n    AgentsPage --> AgentConfigModal\n    AgentConfigModal --> AgentCreatorForm\n    AgentCreatorForm --> AgentCreatorChatPanel\n    AgentsPage --> TaskExecutionModal\n\n    %% Skill Flow\n    SkillsPage --> SkillCreationModal\n    SkillCreationModal --> SkillCreatorChatPanel\n\n    %% Chat Flow\n    AgentCreatorChatPanel --> ChatSessionModal\n    SkillCreatorChatPanel --> ChatSessionModal\n    ChatSessionModal --> ComposerArea\n    ChatSessionModal --> MessageBubble\n    MessageBubble --> SystemMessageDisplay\n    MessageBubble --> ToolUseDisplay\n\n    %% Context Usage\n    ChatSessionModal -.->|uses| ChatDisplayContext\n    MessageBubble -.->|uses| ChatDisplayContext\n\n    %% UI Component Usage\n    AgentCreatorForm --> Button\n    AgentCreatorForm --> Input\n    AgentCreatorForm --> Textarea\n    AgentCreatorForm --> Select\n    AgentConfigModal --> Dialog\n    SettingsPage --> Switch\n    LandingPage --> Card\n    TaskExecutionModal --> ProgressBar\n    AgentsPage --> Icons\n\n    %% Form Components\n    AgentCreatorForm --> KeyValueEditor\n    AgentCreatorForm --> ArrayEditor\n    SkillCreationModal --> KeyValueEditor\n\n    %% Service Layer\n    AgentsPage -.->|HTTP| APIService\n    SkillsPage -.->|HTTP| APIService\n    MCPServersPage -.->|HTTP| APIService\n    TaskExecutionModal -.->|SSE| SSEService\n    ChatSessionModal -.->|SSE| SSEService\n\n    %% Hooks\n    AgentsPage -.->|uses| CustomHooks\n    SkillsPage -.->|uses| CustomHooks\n    ChatSessionModal -.->|uses| CustomHooks\n\n    %% Styling\n    classDef root fill:#e1f5ff,stroke:#01579b,stroke-width:2px\n    classDef layout fill:#f3e5f5,stroke:#4a148c,stroke-width:2px\n    classDef page fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px\n    classDef agent fill:#fff3e0,stroke:#e65100,stroke-width:2px\n    classDef skill fill:#fce4ec,stroke:#880e4f,stroke-width:2px\n    classDef chat fill:#e0f2f1,stroke:#004d40,stroke-width:2px\n    classDef ui fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    classDef form fill:#ede7f6,stroke:#311b92,stroke-width:2px\n    classDef context fill:#fbe9e7,stroke:#bf360c,stroke-width:2px\n    classDef service fill:#e8eaf6,stroke:#1a237e,stroke-width:2px\n    classDef hooks fill:#f1f8e9,stroke:#33691e,stroke-width:2px\n\n    class Main,Router,ManagerApp root\n    class Layout,Sidebar layout\n    class LandingPage,AgentsPage,SkillsPage,MCPServersPage,CommandsPage,SettingsPage page\n    class AgentConfigModal,AgentCreatorForm,AgentCreatorChatPanel,TaskExecutionModal agent\n    class SkillCreationModal,SkillCreatorChatPanel skill\n    class ChatSessionModal,ComposerArea,MessageBubble,SystemMessageDisplay,ToolUseDisplay chat\n    class Button,Input,Textarea,Select,Dialog,Switch,Card,Icons,ProgressBar ui\n    class KeyValueEditor,ArrayEditor form\n    class ChatDisplayContext context\n    class APIService,SSEService service\n    class CustomHooks hooks\n```\n\n### Component Organization\n\n#### Application Root (3 components)\n- **main.tsx**: Application entry point, renders React root\n- **BrowserRouter**: React Router setup for navigation\n- **ManagerApp**: Main application component with routing\n\n#### Layout Components (2 components)\n- **Layout**: App shell with sidebar and main content area\n- **Sidebar**: Navigation menu with links to all pages\n\n#### Page Components (6 components)\n- **LandingPage**: Dashboard with overview and quick actions\n- **AgentsPage**: List and manage AI agents\n- **SkillsPage**: List and manage skills\n- **MCPServersPage**: Configure MCP servers\n- **CommandsPage**: Manage slash commands\n- **SettingsPage**: Application settings and preferences\n\n#### Agent Components (4 components)\n- **AgentConfigModal**: Configure agent settings (model, tools, etc.)\n- **AgentCreatorForm**: Form to create/edit agents\n- **AgentCreatorChatPanel**: Interactive chat for testing agents\n- **TaskExecutionModal**: Execute and monitor agent tasks\n\n#### Skill Components (2 components)\n- **SkillCreationModal**: Create/edit skill definitions\n- **SkillCreatorChatPanel**: Chat interface for training skills\n\n#### Chat Components (5 components)\n- **ChatSessionModal**: Main chat interface\n- **ComposerArea**: Message input with formatting\n- **MessageBubble**: Display individual messages\n- **SystemMessageDisplay**: Show system messages\n- **ToolUseDisplay**: Visualize tool executions\n\n#### UI Components (9 components)\n- Built on **Radix UI** primitives\n- Styled with **Tailwind CSS**\n- Reusable across the application\n\n#### Form Components (2 components)\n- **KeyValueEditor**: Edit environment variables and metadata\n- **ArrayEditor**: Edit array values (MCP args, etc.)\n\n### Frontend Patterns\n\n1. **Component Composition**: Small, reusable components composed into features\n2. **Context API**: ChatDisplayContext for cross-component state\n3. **Custom Hooks**: Encapsulate stateful logic and effects\n4. **SSE Streaming**: Real-time updates via EventSource\n5. **REST API**: Axios for CRUD operations\n6. **Radix UI**: Accessible, unstyled component primitives\n7. **Tailwind CSS**: Utility-first styling approach\n\n---\n\n## 3. Strapi Content Types and Relationships\n\nThis diagram shows the Strapi database schema with all content types and their relationships.\n\n```mermaid\nerDiagram\n    AGENT ||--o{ TASK : \"has many\"\n    AGENT ||--o{ CHAT_SESSION : \"has many\"\n    AGENT ||--o{ SKILL : \"trains\"\n    AGENT {\n        int id PK\n        string name UK\n        string slug UK\n        text description\n        text systemPrompt\n        boolean enabled\n        json toolConfig\n        json modelConfig\n        json analytics\n        json metadata\n        json mcpConfig\n        json skillSelection\n        json tasks\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    SKILL ||--o{ TRAINING_SESSION : \"has many\"\n    SKILL ||--o{ SKILL_FILE : \"has many\"\n    SKILL }|--|| AGENT : \"trained by\"\n    SKILL {\n        int id PK\n        string name UK\n        string displayName\n        text description\n        text skillConfig\n        text skillmd\n        decimal experienceScore\n        enum category\n        boolean isPublic\n        string version\n        string license\n        json trainingHistory\n        json additionalFiles\n        json agentSelection\n        int trainingAgent FK\n        json mcpConfig\n        json toolConfig\n        json modelConfig\n        json analytics\n        json tasks\n        json inputFields\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    MCP_SERVER ||--o{ MCP_TOOL : \"provides\"\n    MCP_SERVER {\n        int id PK\n        string name UK\n        text description\n        string command\n        json args\n        json env\n        boolean disabled\n        enum transport\n        string healthCheckUrl\n        boolean isHealthy\n        datetime lastHealthCheck\n        int startupTimeout\n        enum restartPolicy\n        datetime toolsFetchedAt\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    MCP_TOOL }|--|| MCP_SERVER : \"belongs to\"\n    MCP_TOOL {\n        int id PK\n        string name\n        text description\n        json inputSchema\n        int mcpServer FK\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    CHAT_SESSION ||--o{ CHAT_MESSAGE : \"has many\"\n    CHAT_SESSION }|--o| AGENT : \"uses\"\n    CHAT_SESSION }o--o{ SKILL : \"uses many\"\n    CHAT_SESSION {\n        int id PK\n        string title\n        enum status\n        string sessionId UK\n        enum permissionMode\n        boolean planMode\n        int agent FK\n        text customSystemPrompt\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    CHAT_MESSAGE }|--|| CHAT_SESSION : \"belongs to\"\n    CHAT_MESSAGE {\n        int id PK\n        enum role\n        text content\n        json toolUse\n        json toolResult\n        json metadata\n        int session FK\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    TASK {\n        int id PK\n        text message\n        enum status\n        json result\n        text error\n        datetime startedAt\n        datetime completedAt\n        int executionTime\n        int tokensUsed\n        decimal cost\n        json metadata\n        json executionLog\n        datetime createdAt\n        datetime updatedAt\n    }\n\n    TRAINING_SESSION {\n        int id PK\n        datetime trainedAt\n        int tokensUsed\n        decimal cost\n        text feedback\n        json metrics\n    }\n\n    SKILL_FILE {\n        int id PK\n        string filename\n        text content\n        string mimeType\n    }\n```\n\n### Content Type Details\n\n#### Agent\nCore content type representing an AI agent with its configuration.\n\n**Key Fields:**\n- `name`: Unique agent name\n- `slug`: URL-friendly identifier\n- `systemPrompt`: Agent's system instructions\n- `toolConfig`: Tool configuration (computer use, bash, editor)\n- `modelConfig`: Model settings (model name, temperature, max tokens)\n- `mcpConfig`: MCP server selections\n- `skillSelection`: Associated skills\n- `analytics`: Usage metrics and statistics\n\n**Components:**\n- `agent.tool-configuration`: Tool settings\n- `agent.model-configuration`: Model parameters\n- `agent.analytics`: Usage analytics\n- `shared.metadata`: Custom metadata\n- `mcp.server-selection`: MCP server bindings\n- `skill.skill-selection`: Skill associations\n- `task.task-selection`: Task associations\n\n**Relationships:**\n- Has many `TASK` records (execution history)\n- Has many `CHAT_SESSION` records\n- Trains many `SKILL` records (as training agent)\n\n#### Skill\nRepresents a Claude Agent SDK skill with training history.\n\n**Key Fields:**\n- `name`: Unique skill identifier (uid)\n- `displayName`: Human-readable name\n- `description`: Skill description\n- `skillConfig`: Forced execution mode prompt\n- `skillmd`: Markdown skill definition\n- `experienceScore`: Training quality metric (0-100)\n- `category`: Skill category (general-purpose, code-analysis, etc.)\n- `version`: Semantic version\n- `trainingHistory`: Training session records\n\n**Components:**\n- `skill.training-session`: Training history entries\n- `skill.skill-file`: Additional skill files\n- `agent.agent-selection`: Agent associations\n- `skill.input-field`: Dynamic input fields\n\n**Relationships:**\n- Belongs to `AGENT` (training agent)\n- Many-to-many with `CHAT_SESSION`\n- Has many `TRAINING_SESSION` components\n- Has many `SKILL_FILE` components\n\n#### MCP Server\nConfiguration for Model Context Protocol servers.\n\n**Key Fields:**\n- `name`: Unique server name\n- `command`: Executable command\n- `args`: Command arguments (JSON array)\n- `env`: Environment variables (JSON object)\n- `transport`: Communication protocol (stdio, sse, http)\n- `healthCheckUrl`: Health check endpoint (for http/sse)\n- `isHealthy`: Current health status\n- `restartPolicy`: Restart behavior (always, on-failure, never)\n\n**Relationships:**\n- Has many `MCP_TOOL` records (discovered tools)\n\n#### MCP Tool\nTools discovered from MCP servers.\n\n**Key Fields:**\n- `name`: Tool name\n- `description`: Tool description\n- `inputSchema`: JSON Schema for tool parameters\n\n**Relationships:**\n- Belongs to `MCP_SERVER`\n\n#### Chat Session\nRepresents a chat conversation session.\n\n**Key Fields:**\n- `title`: Session title\n- `sessionId`: Unique session identifier\n- `status`: Session status (active, archived)\n- `permissionMode`: Permission handling (default, bypass, auto)\n- `planMode`: Whether plan mode is enabled\n- `customSystemPrompt`: Optional custom system prompt\n\n**Relationships:**\n- Belongs to `AGENT` (optional, can use custom prompt)\n- Many-to-many with `SKILL`\n- Has many `CHAT_MESSAGE` records\n\n#### Chat Message\nIndividual messages within a chat session.\n\n**Key Fields:**\n- `role`: Message role (user, assistant, system)\n- `content`: Message text\n- `toolUse`: Tool invocation data\n- `toolResult`: Tool execution result\n- `metadata`: Additional metadata\n\n**Relationships:**\n- Belongs to `CHAT_SESSION`\n\n#### Task\nAgent execution task with results and metrics.\n\n**Key Fields:**\n- `message`: Task description/prompt\n- `status`: Execution status (pending, running, completed, failed, cancelled)\n- `result`: Execution result (JSON)\n- `error`: Error message if failed\n- `executionTime`: Time taken (milliseconds)\n- `tokensUsed`: Total tokens consumed\n- `cost`: Execution cost (USD)\n- `executionLog`: Detailed execution log\n\n**Relationships:**\n- Belongs to `AGENT` (implicitly through agent selection at execution time)\n\n### Database Schema Patterns\n\n1. **Component-Based Fields**: Reusable components for common structures (toolConfig, modelConfig, analytics)\n2. **Many-to-Many Relationships**: Skills can be used by multiple chat sessions\n3. **Composition Pattern**: Tasks and metadata stored as JSON for flexibility\n4. **Audit Fields**: All content types have `createdAt` and `updatedAt` timestamps\n5. **Enumeration Types**: Status fields use enums for data integrity\n6. **JSON Storage**: Complex configurations stored as JSON for flexibility\n7. **Unique Constraints**: Names and slugs enforced at database level\n\n### Content Type Interactions\n\n#### Agent Execution Flow\n1. User selects `AGENT` with associated `SKILL` records\n2. Agent configuration loaded (systemPrompt, toolConfig, modelConfig)\n3. `MCP_SERVER` connections established, `MCP_TOOL` records discovered\n4. `TASK` record created with status \"pending\"\n5. Execution begins, status updated to \"running\"\n6. On completion, `TASK` updated with result, tokens, cost\n\n#### Chat Session Flow\n1. User creates `CHAT_SESSION` with optional `AGENT`\n2. Session can select multiple `SKILL` records\n3. `CHAT_MESSAGE` records created for each interaction\n4. Messages reference tool use and results\n5. Session can be archived (status: \"archived\")\n\n#### Skill Training Flow\n1. User creates `SKILL` record\n2. Training `AGENT` selected (or default)\n3. Training sessions create `TRAINING_SESSION` components\n4. `experienceScore` updated based on training feedback\n5. Additional files stored in `SKILL_FILE` components\n\n---\n\n## Component Integration Patterns\n\n### Express \u2192 Strapi Integration\n- **Single Gateway**: `strapi-client` service is the only Express service that communicates with Strapi\n- **Caching**: LRU cache in strapi-client reduces database load\n- **REST API**: All communication via Strapi's REST API endpoints\n- **Error Handling**: Graceful degradation when Strapi is unavailable\n\n### Frontend \u2192 Express Integration\n- **REST API**: CRUD operations via Axios HTTP client\n- **SSE Streaming**: Real-time updates via EventSource\n- **Error Boundaries**: React error boundaries catch rendering errors\n- **Loading States**: Progressive loading with skeleton screens\n\n### Express \u2192 Claude SDK Integration\n- **Event-Driven**: Claude SDK emits events consumed by Express services\n- **Streaming**: SSE streaming for real-time agent responses\n- **Tool Integration**: MCP tools injected into Claude SDK context\n- **History Management**: Conversation history loaded/saved to filesystem\n\n### Express \u2192 MCP Integration\n- **JSON-RPC**: Communication via JSON-RPC 2.0 protocol\n- **Transport Abstraction**: Supports stdio, SSE, and HTTP transports\n- **Tool Discovery**: Dynamic tool discovery on server connection\n- **3-Tier Discovery**: Project-level, agent-level, and skill-level MCP configs\n\n---\n\n## Summary\n\nThe component architecture consists of:\n\n- **26 Express Services** organized into 8 categories\n- **48+ React Components** organized by feature\n- **7 Strapi Content Types** with relationships\n\n### Key Architectural Principles\n\n1. **Separation of Concerns**: Clear boundaries between layers\n2. **Single Responsibility**: Each component has one primary purpose\n3. **Dependency Injection**: Services receive dependencies, not global state\n4. **Event-Driven Communication**: Real-time updates via events\n5. **Caching Strategy**: Multiple caching layers for performance\n6. **Type Safety**: TypeScript throughout the stack\n7. **Component Reusability**: Shared components across features\n\n### Related Documentation\n\n- [System Overview](./01-system-overview.md) - High-level architecture\n- [Data Flow](./02-data-flow.md) - Data flow patterns\n- [Deployment](./03-deployment.md) - Docker deployment topology\n- [Sequences](./05-sequences.md) - Sequence diagrams for key flows\n\n---\n\n*Last Updated: 2026-01-02*\n",
        "last_modified": "2026-01-02T11:16:07.578516"
      },
      "task_intent": {
        "title": "003-create-architecture-documentation-with-system-diag",
        "description": "Create comprehensive visual documentation showing how the hybrid architecture components (React + Express + Strapi + PostgreSQL + Claude SDK + MCP) interact, including data flow, service communication, and deployment topology.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-02T10:53:08.922833",
  "last_updated": "2026-01-02T10:53:08.936325"
}